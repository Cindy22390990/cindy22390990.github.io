<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ğŸ“’ è‹±æ–‡éŒ¯é¡Œæœ¬ï¼ˆDrive é›²ç«¯ï¼‰</title>
<meta name="theme-color" content="#2563eb" />
<link rel="manifest" href="manifest.json" />
<link rel="apple-touch-icon" href="icon-192.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800;900&display=swap" rel="stylesheet" />
<!-- Google èº«åˆ†èˆ‡ APIï¼ˆDriveï¼‰ -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root{
    --safe-top:max(env(safe-area-inset-top),18px);
    --safe-side:max(env(safe-area-inset-left),16px);
    --safe-bottom:max(env(safe-area-inset-bottom),16px);
    --pad:16px;
  }
  html,body{height:100%}
  body{
    font-family:'Inter',system-ui,-apple-system,'SF Pro Text','PingFang TC','Noto Sans TC','Microsoft JhengHei',sans-serif;
    background:#f7f9fc;color:#0f172a;
  }
  .safe-top{height:var(--safe-top)}
  .container-pad{
    padding-left:calc(var(--safe-side) + var(--pad));
    padding-right:calc(var(--safe-side) + var(--pad));
  }
  .header{position:sticky;top:0;z-index:40;background:#fff;border-bottom:1px solid #e5e7eb;backdrop-filter:blur(6px)}
  .btn{border-radius:14px;font-weight:800;padding:.65rem 1rem;transition:.06s transform}
  .btn:active{transform:scale(.98)}
  .btn-lg{min-height:54px}
  .btn-primary{background:#2563eb;color:#fff}
  .btn-ghost{background:#eef2f7;color:#334155}
  .pill{font-size:12px;border-radius:9999px;padding:.125rem .5rem}
  .card{background:#fff;border:1px solid #eef2f7;border-radius:16px;box-shadow:0 8px 18px rgba(15,23,42,.06)}
  .badge{font-size:12px;background:#f1f5f9;color:#64748b;border-radius:10px;padding:.1rem .45rem}
  .hidden-hard{display:none!important}
  #loading{position:fixed;inset:0;background:rgba(255,255,255,.78);display:flex;align-items:center;justify-content:center;z-index:100}
  #loading.hidden{display:none!important}
  .fab{position:fixed;right:calc(var(--safe-side) + 18px);bottom:calc(var(--safe-bottom) + 18px);width:64px;height:64px;border-radius:9999px;background:#2563eb;color:#fff;font-size:34px;display:flex;align-items:center;justify-content:center;box-shadow:0 12px 28px rgba(37,99,235,.35);z-index:35}
  .sheet{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:end;z-index:50}
  .sheet.show{display:flex}
  .sheet-card{background:#fff;border-top-left-radius:18px;border-top-right-radius:18px;width:100%}
  .toolbar{padding:8px 0}
  .opt{display:flex;align-items:center;gap:10px;border:1px solid #e6eaf0;border-radius:12px;padding:14px 12px}
  .opt.active{border-color:#2563eb;background:#eef4ff}
  .opt.correct{border-color:#16a34a;background:#ecfdf5}
  .opt.wrong{border-color:#dc2626;background:#fef2f2}
  .kv{display:grid;grid-template-columns:110px 1fr;gap:.5rem .75rem}
  .kv .k{color:#475569}.kv .v{color:#0f172a}
  /* é¿å…ä»»ä½•é€æ˜è¦†è“‹å±¤åƒèµ°é»æ“Š */
  .no-pointer{pointer-events:none}
</style>
</head>

<body class="min-h-screen flex flex-col">
  <div class="safe-top"></div>

  <!-- é ‚éƒ¨ -->
  <header class="header">
    <div class="container-pad py-2">
      <h1 class="text-3xl font-black leading-tight">
        ğŸ“’ è‹±æ–‡éŒ¯é¡Œæœ¬ <span class="text-slate-500 font-extrabold">ï¼ˆDrive é›²ç«¯ï¼‰</span>
      </h1>
      <div id="drive-status" class="text-xs text-slate-500 mt-1">é›¢ç·šæ¨¡å¼ï¼ˆå°šæœªç™»å…¥ï¼‰</div>

      <div class="flex flex-wrap gap-3 pb-2 pt-2">
        <button id="btn-auth"    class="btn btn-lg btn-primary">Google ç™»å…¥</button>
        <button id="btn-backup"  class="btn btn-lg btn-ghost">å‚™ä»½</button>
        <button id="btn-restore" class="btn btn-lg btn-ghost">é‚„åŸ</button>
      </div>
    </div>
  </header>

  <!-- æ¬¡åˆ—å·¥å…· -->
  <nav class="container-pad toolbar bg-white/70 backdrop-blur border-b border-slate-200 sticky top-[calc(var(--safe-top)+92px)] z-30">
    <div class="flex items-center gap-2 flex-wrap">
      <button id="btn-import-file" class="btn btn-ghost">åŒ¯å…¥ï¼ˆæª”æ¡ˆï¼‰</button>
      <input id="file-import" type="file" accept="application/json" class="hidden" />
      <button id="btn-export-file" class="btn btn-ghost">åŒ¯å‡ºï¼ˆæª”æ¡ˆï¼‰</button>
    </div>

    <div class="mt-3 grid grid-cols-3 gap-3">
      <button id="tab-grammar"      class="btn btn-ghost">ğŸ“ æ–‡æ³• <span id="count-grammar" class="badge ml-1">0</span></button>
      <button id="tab-collocations" class="btn btn-ghost">ğŸ”— ç‰‡èª <span id="count-coll"    class="badge ml-1">0</span></button>
      <button id="tab-vocab"        class="btn btn-ghost">ğŸ’¡ å–®å­— <span id="count-vocab"   class="badge ml-1">0</span></button>
    </div>

    <div class="mt-3 flex items-center gap-2">
      <div class="relative flex-1">
        <input id="search" type="search" placeholder="æœå°‹é¡Œå¹¹/è§£æ/æ¨™ç±¤/ä¾†æºï¼ˆå³æ™‚éæ¿¾ï¼‰"
               class="w-full rounded-xl border border-slate-300 px-3 py-2 pl-9 outline-none focus:ring-2 focus:ring-blue-500">
        <div class="absolute left-2 top-2.5 text-gray-400">ğŸ”</div>
      </div>
      <button id="mode-list" class="btn btn-ghost" data-mode="list">ğŸ“‹ å¿«é€Ÿç¿»</button>
      <button id="mode-quiz" class="btn btn-ghost" data-mode="quiz">â“ æ¸¬é©—</button>
    </div>

    <!-- å¸¸éŒ¯çµ±è¨ˆï¼ˆä¾å­åˆ†é¡ï¼‰-->
    <div class="mt-3 flex items-center gap-2 text-sm flex-wrap" id="stats-bar">
      <span class="text-slate-500">ğŸ“ˆ å¸¸éŒ¯çµ±è¨ˆï¼š</span>
      <div id="stats-chips" class="flex items-center gap-2 flex-wrap"></div>
    </div>
  </nav>

  <!-- ä¸»å…§å®¹ -->
  <main class="flex-1">
    <div id="cards" class="max-w-xl mx-auto px-4 py-4 space-y-3"></div>
    <div id="empty" class="hidden max-w-xl mx-auto px-4 py-16 text-center text-gray-500">
      ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œé»å³ä¸‹è§’ <b>ï¼‹</b> æ–°å¢ç¬¬ä¸€å¼µå¡ç‰‡å§ï¼
    </div>
  </main>

  <!-- æ–°å¢ -->
  <button id="btn-add" class="fab" aria-label="æ–°å¢">ï¼‹</button>

  <!-- ç·¨è¼¯åº•å–® -->
  <div id="sheet" class="sheet">
    <div class="sheet-card w-full max-w-xl mx-auto p-4 pt-3">
      <div class="flex items-center justify-between mb-2">
        <h2 id="sheet-title" class="text-lg font-bold">æ–°å¢éŒ¯é¡Œ</h2>
        <button id="sheet-close" class="btn btn-ghost">é—œé–‰</button>
      </div>

      <form id="form" class="space-y-3">
        <input type="hidden" id="form-id">

        <div>
          <label class="text-sm text-gray-700">åˆ†é¡</label>
          <select id="form-category" class="w-full border rounded-lg px-3 py-2">
            <option value="Grammar">æ–‡æ³• (Grammar)</option>
            <option value="Collocations">ç‰‡èª (Collocations)</option>
            <option value="Vocabulary">å–®å­— (Vocabulary)</option>
          </select>
        </div>

        <div>
          <label class="text-sm text-gray-700">å­åˆ†é¡ï¼ˆä¾‹ï¼šä»‹ç³»è©ï¼å½¢å®¹è©â€¦ï¼‰</label>
          <input id="form-subcat" class="w-full border rounded-lg px-3 py-2" placeholder="ä»‹ç³»è©ã€å½¢å®¹è©ã€å‹•åè©â€¦">
        </div>

        <div>
          <label class="text-sm text-gray-700">é¡Œå¹¹</label>
          <textarea id="form-question" rows="3" class="w-full border rounded-lg px-3 py-2"
                    placeholder="é¡Œç›®ï¼‹ç©ºæ ¼ä½ç½®ï¼ˆå¯è²¼æ®µè½ï¼‰"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div><label class="text-sm">é¸é … A</label><input id="optA" class="w-full border rounded-lg px-3 py-2"></div>
          <div><label class="text-sm">é¸é … B</label><input id="optB" class="w-full border rounded-lg px-3 py-2"></div>
          <div><label class="text-sm">é¸é … C</label><input id="optC" class="w-full border rounded-lg px-3 py-2"></div>
          <div><label class="text-sm">é¸é … D</label><input id="optD" class="w-full border rounded-lg px-3 py-2"></div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-sm">æ­£ç¢ºé¸é …ï¼ˆA/B/C/Dï¼‰</label>
            <input id="form-correctOpt" class="w-full border rounded-lg px-3 py-2" placeholder="ä¾‹ï¼šA">
          </div>
          <div>
            <label class="text-sm">æˆ‘çš„ç­”æ¡ˆï¼ˆå¯ç©ºï¼‰</label>
            <input id="form-myAns" class="w-full border rounded-lg px-3 py-2" placeholder="ä¾‹ï¼šD">
          </div>
        </div>

        <div>
          <label class="text-sm">éŒ¯å› åˆ†æ</label>
          <textarea id="form-analysis" rows="2" class="w-full border rounded-lg px-3 py-2"></textarea>
        </div>

        <div>
          <label class="text-sm">è¨˜æ†¶å£è¨£/å°æŠ€å·§</label>
          <textarea id="form-mnemonic" rows="2" class="w-full border rounded-lg px-3 py-2"></textarea>
        </div>

        <div>
          <label class="text-sm">è§£é¡Œé—œéµ</label>
          <textarea id="form-solutionKey" rows="2" class="w-full border rounded-lg px-3 py-2"></textarea>
        </div>

        <div>
          <label class="text-sm">é¡é¡Œæé†’</label>
          <textarea id="form-similarHint" rows="2" class="w-full border rounded-lg px-3 py-2"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-sm">é¡Œç›®ä¾†æºï¼ˆæ›¸å/æ¨¡æ“¬è©¦é¡Œâ€¦ï¼‰</label>
            <input id="form-source" class="w-full border rounded-lg px-3 py-2">
          </div>
          <div>
            <label class="text-sm">é‡è¦ç¨‹åº¦ï¼ˆé«˜/ä¸­/ä½ï¼‰</label>
            <input id="form-importance" class="w-full border rounded-lg px-3 py-2">
          </div>
        </div>

        <div>
          <label class="text-sm">æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
          <input id="form-tags" class="w-full border rounded-lg px-3 py-2" placeholder="ä»‹ç³»è©, Part5, å›ºå®šæ­é…">
        </div>

        <div>
          <label class="text-sm">å‚™è¨»</label>
          <textarea id="form-notes" rows="2" class="w-full border rounded-lg px-3 py-2"></textarea>
        </div>

        <div class="flex items-center justify-between pt-2">
          <button type="button" id="btn-delete" class="text-red-600 hidden">åˆªé™¤</button>
          <button class="btn btn-primary">å„²å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- è¼‰å…¥ä¸­ -->
  <div id="loading" class="hidden">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-2"></div>
      <p class="text-gray-700">åŒæ­¥ä¸­...</p>
    </div>
  </div>

<script>
/* =========================
   åŸºæœ¬å·¥å…·
========================= */
const $  = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));
const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const LS_KEY='eng_error_cards_v3_full';
const DRIVE_FILE_NAME='english_mistakes_v3.json';

const state={
  cat:'Grammar',        // Grammar | Collocations | Vocabulary
  mode:'list',         // list | quiz
  data:[],
  filtered:[]
};

/* =========================
   æœ¬åœ°å­˜å–
========================= */
function loadLocal(){
  try{ state.data=JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ state.data=[]; }
}
function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(state.data)); }

/* =========================
   UIï¼šåˆ†é¡/æ¨¡å¼/æœå°‹/çµ±è¨ˆ
========================= */
function setCat(cat){ state.cat=cat; render(); }
function setMode(m){
  state.mode=m;
  $('#mode-list').classList.toggle('btn-primary', m==='list');
  $('#mode-list').classList.toggle('text-white', m==='list');
  $('#mode-quiz').classList.toggle('btn-primary', m==='quiz');
  $('#mode-quiz').classList.toggle('text-white', m==='quiz');
  render();
}
function computeFiltered(){
  const q=$('#search').value.trim().toLowerCase();
  state.filtered = state.data
    .filter(d=>d.category===state.cat)
    .filter(d=>{
      if(!q) return true;
      const blob=[
        d.question,d.analysis,d.mnemonic,d.solutionKey,d.similarHint,
        d.source,d.importance,(d.tags||[]).join(','),
        d.options?.A,d.options?.B,d.options?.C,d.options?.D,
        d.extra?.sourceFileName
      ].join(' ').toLowerCase();
      return blob.includes(q);
    })
    .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
}
function summarizeCounts(){
  const g=state.data.filter(d=>d.category==='Grammar').length;
  const c=state.data.filter(d=>d.category==='Collocations').length;
  const v=state.data.filter(d=>d.category==='Vocabulary').length;
  $('#count-grammar').textContent=g;
  $('#count-coll').textContent=c;
  $('#count-vocab').textContent=v;
}
function renderStats(){
  // ä¾ç›®å‰ä¸»åˆ†é¡ï¼Œå°ã€Œå­åˆ†é¡ subcategoryã€çµ±è¨ˆéŒ¯é¡Œæ¬¡æ•¸ï¼ˆwrongCountï¼‰
  const box=$('#stats-chips'); box.innerHTML='';
  const map=new Map();
  state.data.filter(d=>d.category===state.cat).forEach(d=>{
    const key=(d.subcategory||'æœªåˆ†é¡');
    const n = (d.wrongCount||0);
    if(!map.has(key)) map.set(key,0);
    map.set(key, map.get(key)+n);
  });
  [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,8).forEach(([k,v])=>{
    const chip=document.createElement('span');
    chip.className='pill bg-slate-100 text-slate-700';
    chip.textContent=`${k} ${v?`Ã—${v}`:''}`;
    chip.onclick=()=>{ $('#search').value=k; render(); };
    box.appendChild(chip);
  });
}

/* =========================
   å¡ç‰‡
========================= */
function escapeHTML(s){ return (s||'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }

function cardEl(it){
  const el=document.createElement('div');
  el.className='card p-4';

  // é¸é …ï¼ˆæ¸¬é©—ç”¨ï¼‰
  const opts = `
    <div class="space-y-2 mt-3 ${state.mode==='quiz'?'':'hidden'}">
      ${['A','B','C','D'].map(letter=>`
        <div class="opt js-opt" data-opt="${letter}">
          <div class="w-7 h-7 flex items-center justify-center font-extrabold rounded-full bg-white border">${letter}</div>
          <div class="flex-1">${escapeHTML(it.options?.[letter]||'')}</div>
        </div>`).join('')}
    </div>`;

  // è©³è§£ï¼ˆå¿«é€Ÿç¿»ï¼‰
  const details = `
    <div class="${state.mode==='quiz'?'hidden':''}">
      <div class="grid grid-cols-2 gap-2 text-sm mt-2">
        <div class="p-2 bg-red-50 border border-red-200 rounded-lg"><b class="text-red-600">âŒ æˆ‘çš„ç­”æ¡ˆ</b> ${escapeHTML(it.myAnswer||'â€”')}</div>
        <div class="p-2 bg-green-50 border border-green-200 rounded-lg"><b class="text-green-600">âœ… æ­£è§£</b> ${escapeHTML(it.correctOption||'â€”')}</div>
      </div>
      <div class="mt-2 p-3 bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg text-sm">
        <div class="font-semibold text-yellow-800 mb-1">ğŸ” éŒ¯å› åˆ†æ</div>
        <div class="text-gray-800">${escapeHTML(it.analysis||'â€”')}</div>
      </div>
      <div class="mt-2 p-3 bg-indigo-50 border-l-4 border-indigo-500 rounded-r-lg text-sm">
        <div class="font-semibold text-indigo-800 mb-1">ğŸ¯ è¨˜æ†¶å£è¨£/å°æŠ€å·§</div>
        <div class="text-gray-800">${escapeHTML(it.mnemonic||'â€”')}</div>
      </div>
      ${ (it.solutionKey||it.similarHint) ? `
      <div class="mt-2 p-3 bg-slate-50 border rounded-lg text-sm">
        <div class="kv">
          <div class="k">è§£é¡Œé—œéµ</div><div class="v">${escapeHTML(it.solutionKey||'â€”')}</div>
          <div class="k">é¡é¡Œæé†’</div><div class="v">${escapeHTML(it.similarHint||'â€”')}</div>
        </div>
      </div>` : '' }
    </div>`;

  el.innerHTML=`
    <div class="flex items-center justify-between mb-2">
      <div class="text-sm text-blue-600 font-semibold">
        ${({'Grammar':'ğŸ“ æ–‡æ³•','Collocations':'ğŸ”— ç‰‡èª','Vocabulary':'ğŸ’¡ å–®å­—'}[it.category]||'ğŸ“„')}
        <span class="ml-1 text-slate-500">${escapeHTML(it.subcategory||'æœªåˆ†é¡')}</span>
      </div>
      <div class="text-xs text-gray-400">${new Date(it.createdAt||Date.now()).toLocaleDateString()}</div>
    </div>

    <h3 class="font-bold text-gray-900 mb-2 leading-relaxed">${escapeHTML(it.question||'')}</h3>
    <div class="flex flex-wrap gap-1 mb-2">${(it.tags||[]).map(t=>`<span class="pill bg-gray-100 text-gray-600">#${escapeHTML(t)}</span>`).join('')}</div>

    ${opts}
    ${details}

    <div class="mt-3 grid grid-cols-2 gap-2 text-[13px] text-slate-600">
      <div class="kv">
        <div class="k">ä¾†æº</div><div class="v">${escapeHTML(it.source||'â€”')}</div>
        <div class="k">é‡è¦åº¦</div><div class="v">${escapeHTML(it.importance||'â€”')}</div>
        <div class="k">ç‹€æ…‹</div><div class="v">${it.isReviewed?'âœ… å·²è¤‡ç¿’':'â€”'}</div>
      </div>
      <div class="kv">
        <div class="k">éŒ¯æ¬¡</div><div class="v">${it.wrongCount||0}</div>
        <div class="k">æ„›å¿ƒ</div><div class="v">${it.hearts||0}</div>
        <div class="k">å‚™è¨»</div><div class="v">${escapeHTML(it.notes||'â€”')}</div>
      </div>
    </div>

    <div class="flex justify-end gap-2 mt-3">
      <button class="btn btn-ghost text-sm js-edit">ç·¨è¼¯</button>
      <button class="btn btn-ghost text-sm text-red-600 js-del">åˆªé™¤</button>
      <button class="btn btn-ghost text-sm ${it.isReviewed?'text-green-700 bg-green-100':'text-gray-700 bg-gray-100'} js-review">${it.isReviewed?'âœ… å·²è¤‡ç¿’':'ğŸ”„ æ¨™è¨˜å·²è¤‡ç¿’'}</button>
    </div>`;

  // è¡Œç‚º
  el.querySelector('.js-edit').onclick=()=>openSheet(it);
  el.querySelector('.js-del').onclick=()=>delItem(it.id);
  el.querySelector('.js-review').onclick=()=>markReviewed(it.id, !it.isReviewed);

  // æ¸¬é©—é¸é …é»æ“Š
  if(state.mode==='quiz'){
    el.querySelectorAll('.js-opt').forEach(node=>{
      node.onclick=()=>{
        const pick=node.dataset.opt;
        const correct=it.correctOption||'';
        el.querySelectorAll('.js-opt').forEach(n=>n.classList.remove('active','correct','wrong'));
        node.classList.add('active');
        if(pick===correct){
          node.classList.add('correct');
          it.hearts=(it.hearts||0)+1;
        }else{
          node.classList.add('wrong');
          it.wrongCount=(it.wrongCount||0)+1;
        }
        it.myAnswer=pick;
        saveLocal();
        summarizeCounts(); renderStats();
      };
    });
  }
  return el;
}

function render(){
  summarizeCounts();
  computeFiltered();
  renderStats();
  const host=$('#cards'); host.innerHTML='';
  if(state.filtered.length===0){ $('#empty').classList.remove('hidden'); }
  else { $('#empty').classList.add('hidden'); state.filtered.forEach(it=>host.appendChild(cardEl(it))); }

  // é«˜äº®ç›®å‰åˆ†é¡æŒ‰éˆ•
  $('#tab-grammar').classList.toggle('btn-primary', state.cat==='Grammar');
  $('#tab-grammar').classList.toggle('text-white', state.cat==='Grammar');
  $('#tab-collocations').classList.toggle('btn-primary', state.cat==='Collocations');
  $('#tab-collocations').classList.toggle('text-white', state.cat==='Collocations');
  $('#tab-vocab').classList.toggle('btn-primary', state.cat==='Vocabulary');
  $('#tab-vocab').classList.toggle('text-white', state.cat==='Vocabulary');
}

/* =========================
   CRUD èˆ‡è¡¨å–®
========================= */
function openSheet(it=null){
  $('#sheet').classList.add('show');
  $('#sheet-title').textContent = it?'ç·¨è¼¯éŒ¯é¡Œ':'æ–°å¢éŒ¯é¡Œ';
  $('#btn-delete').classList.toggle('hidden', !it);

  $('#form-id').value = it?.id || '';
  $('#form-category').value = it?.category || state.cat;
  $('#form-subcat').value  = it?.subcategory || '';
  $('#form-question').value= it?.question || '';
  $('#optA').value         = it?.options?.A || '';
  $('#optB').value         = it?.options?.B || '';
  $('#optC').value         = it?.options?.C || '';
  $('#optD').value         = it?.options?.D || '';
  $('#form-correctOpt').value = it?.correctOption || '';
  $('#form-myAns').value      = it?.myAnswer || '';
  $('#form-analysis').value   = it?.analysis || '';
  $('#form-mnemonic').value   = it?.mnemonic || '';
  $('#form-solutionKey').value= it?.solutionKey || '';
  $('#form-similarHint').value= it?.similarHint || '';
  $('#form-source').value     = it?.source || '';
  $('#form-importance').value = it?.importance || '';
  $('#form-tags').value       = (it?.tags||[]).join(', ');
  $('#form-notes').value      = it?.notes || '';
}
function closeSheet(){ $('#sheet').classList.remove('show'); }
function upsertLocal(obj){
  const idx=state.data.findIndex(d=>d.id===obj.id);
  if(idx>=0) state.data[idx]=obj; else state.data.unshift(obj);
  saveLocal(); render();
}
function delItem(id){
  if(!confirm('ç¢ºå®šåˆªé™¤é€™å¼µå¡ç‰‡ï¼Ÿ')) return;
  const idx=state.data.findIndex(d=>d.id===id);
  if(idx>=0){ state.data.splice(idx,1); saveLocal(); render(); }
}
function markReviewed(id,flag){
  const it=state.data.find(d=>d.id===id); if(!it) return;
  it.isReviewed=!!flag; it.reviewCount=(it.reviewCount||0)+(flag?1:0); it.lastReviewed=Date.now();
  saveLocal(); render();
}

/* =========================
   åŒ¯å…¥/åŒ¯å‡º
========================= */
function normalizeItem(o){
  // ç›¡åŠ›è£œé½Šæ‰€æœ‰æ¬„ä½
  const def={A:'',B:'',C:'',D:''};
  const opt = o.options || {A:o.optA||o.A, B:o.optB||o.B, C:o.optC||o.C, D:o.optD||o.D};
  return {
    id: o.id || uid(),
    category: o.category || 'Grammar',
    subcategory: o.subcategory || o.subCat || '',
    question: o.question || '',
    options: {...def, ...opt},
    correctOption: (o.correctOption || o.correct||'').toString().trim().toUpperCase(),
    myAnswer: (o.myAnswer || o.answer || '').toString().trim().toUpperCase(),
    analysis: o.analysis || '',
    mnemonic: o.mnemonic || '',
    solutionKey: o.solutionKey || '',
    similarHint: o.similarHint || '',
    source: o.source || '',
    importance: o.importance || '',
    tags: Array.isArray(o.tags) ? o.tags : String(o.tags||'').split(',').map(s=>s.trim()).filter(Boolean),
    notes: o.notes || '',
    isReviewed: !!o.isReviewed,
    reviewCount: o.reviewCount || 0,
    wrongCount: o.wrongCount || 0,
    hearts: o.hearts || 0,
    createdAt: o.createdAt || Date.now(),
    lastReviewed: o.lastReviewed || 0,
    extra: o.extra || {}
  };
}

function importJSON(arr){
  if(!Array.isArray(arr)) return alert('åŒ¯å…¥æ ¼å¼éŒ¯èª¤');
  const key = (o)=> (o.question||'') + '|' + (o.correctOption||'');
  const map = new Map(state.data.map(o=>[key(o), o]));
  arr.forEach(o=> map.set(key(normalizeItem(o)), normalizeItem(o)) );
  state.data = Array.from(map.values()).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  saveLocal(); render();
  alert('âœ… åŒ¯å…¥å®Œæˆ');
}
function exportJSON(){
  const data=JSON.stringify(state.data,null,2);
  const url=URL.createObjectURL(new Blob([data],{type:'application/json'}));
  const a=Object.assign(document.createElement('a'),{href:url,download:`english-mistakes-${Date.now()}.json`});
  document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),500);
}

/* =========================
   Google Driveï¼ˆAppDataï¼‰
========================= */
const GOOGLE_CLIENT_ID='1067450972173-l1o4o3fl73f57mcm4rltj520h2ocio12.apps.googleusercontent.com'; // å¯æ›¿æ›æˆä½ è‡ªå·±çš„
const SCOPES='https://www.googleapis.com/auth/drive.appdata';
let tokenClient=null,accessToken=null,driveFileId=null;

function updateDriveStatus(isLogin,emailText){
  $('#drive-status').innerHTML = isLogin ? `âœ… å·²ç™»å…¥ Google${emailText?`ï¼š${emailText}`:''}` : 'é›¢ç·šæ¨¡å¼ï¼ˆå°šæœªç™»å…¥ï¼‰';
  $('#btn-auth').textContent   = isLogin ? 'ç™»å‡º' : 'Google ç™»å…¥';
  $('#btn-auth').onclick       = isLogin ? signOut : authorize;
}

function initGapi(){ gapi.load('client', async()=>{ await gapi.client.init({ discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] }); }); }
function initGis(){
  tokenClient=google.accounts.oauth2.initTokenClient({
    client_id:GOOGLE_CLIENT_ID,
    scope:SCOPES,
    callback:(r)=>{
      if(r&&r.access_token){
        accessToken=r.access_token;
        gapi.client.setToken({access_token:accessToken});
        updateDriveStatus(true);
        findBackupFile();
      }else{
        updateDriveStatus(false);
      }
    }
  });
}
function authorize(){ tokenClient?.requestAccessToken({prompt:'consent'}); }
function signOut(){
  if(!accessToken) return;
  google.accounts.oauth2.revoke(accessToken,()=>{});
  accessToken=null; driveFileId=null; gapi.client.setToken(null);
  updateDriveStatus(false);
}

async function findBackupFile(){
  try{
    const resp=await gapi.client.drive.files.list({
      spaces:'appDataFolder',
      q:`name='${DRIVE_FILE_NAME}'`,
      fields:'files(id, name, modifiedTime)'
    });
    driveFileId=(resp.result.files && resp.result.files[0]?.id) || null;
  }catch(e){
    console.warn('åˆ—æª”å¤±æ•—',e);
  }
}

async function backupToDrive(){
  if(!accessToken){ alert('è«‹å…ˆ Google ç™»å…¥'); return; }
  $('#loading').classList.remove('hidden');
  try{
    const data=JSON.stringify(state.data||[],null,2);
    if(driveFileId){
      await gapi.client.request({
        path:`/upload/drive/v3/files/${driveFileId}`,
        method:'PATCH',
        params:{uploadType:'media'},
        headers:{'Content-Type':'application/json'},
        body:data
      });
    }else{
      const meta={ name:DRIVE_FILE_NAME, parents:['appDataFolder'] };
      const boundary='m'+Math.random().toString(36).slice(2);
      const body=`--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n`+
        JSON.stringify(meta)+
        `\r\n--${boundary}\r\nContent-Type: application/json\r\n\r\n`+
        data+`\r\n--${boundary}--`;
      const res=await gapi.client.request({
        path:'/upload/drive/v3/files?uploadType=multipart',
        method:'POST',
        headers:{'Content-Type':`multipart/related; boundary=${boundary}`},
        body
      });
      driveFileId=res.result.id;
    }
    alert('âœ… å‚™ä»½æˆåŠŸ');
  }catch(e){
    console.error(e);
    alert('å‚™ä»½å¤±æ•—ï¼šè«‹ç¢ºèª GCP å·²å•Ÿç”¨ Drive APIã€å·²åœ¨ OAuth åŒæ„ç•«é¢åŠ ä¸Šæˆæ¬Šç¶²åŸŸï¼ˆä½ çš„ GitHub Pages ç¶²åŸŸï¼‰ï¼Œä¸¦é‡è©¦ã€‚');
  }finally{ $('#loading').classList.add('hidden'); }
}

async function restoreFromDrive(){
  if(!accessToken){ alert('è«‹å…ˆ Google ç™»å…¥'); return; }
  if(!driveFileId){ await findBackupFile(); }
  if(!driveFileId){ alert('é›²ç«¯å°šç„¡å‚™ä»½ï¼Œè«‹å…ˆå‚™ä»½ä¸€æ¬¡'); return; }
  $('#loading').classList.remove('hidden');
  try{
    const res=await gapi.client.drive.files.get({ fileId:driveFileId, alt:'media' });
    const arr=Array.isArray(res.result)?res.result:[];
    state.data=(arr||[]).map(normalizeItem);
    saveLocal(); render();
    alert('âœ… é‚„åŸæˆåŠŸ');
  }catch(e){
    console.error(e);
    alert('é‚„åŸå¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™æˆ–ç¶²è·¯');
  }finally{ $('#loading').classList.add('hidden'); }
}

/* =========================
   äº‹ä»¶ç¶å®š
========================= */
$('#tab-grammar'     ).onclick=()=>setCat('Grammar');
$('#tab-collocations').onclick=()=>setCat('Collocations');
$('#tab-vocab'       ).onclick=()=>setCat('Vocabulary');
$('#mode-list').onclick = ()=>setMode('list');
$('#mode-quiz').onclick = ()=>setMode('quiz');
$('#search').oninput = ()=>render();

$('#btn-import-file').onclick = ()=>$('#file-import').click();
$('#file-import').onchange = (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{ try{ importJSON(JSON.parse(r.result)); }catch{ alert('åŒ¯å…¥å¤±æ•—'); } };
  r.readAsText(f); e.target.value='';
};
$('#btn-export-file').onclick = exportJSON;

$('#btn-add').onclick = ()=>openSheet();
$('#sheet-close').onclick = ()=>closeSheet();
$('#btn-delete').onclick = ()=>{
  const id=$('#form-id').value; if(id){ closeSheet(); delItem(id); }
};
$('#form').onsubmit=(e)=>{
  e.preventDefault();
  const id = $('#form-id').value || uid();
  const existed = state.data.find(d=>d.id===id);

  const obj = normalizeItem({
    id,
    category: $('#form-category').value,
    subcategory: $('#form-subcat').value.trim(),
    question: $('#form-question').value.trim(),
    options: {
      A: $('#optA').value.trim(),
      B: $('#optB').value.trim(),
      C: $('#optC').value.trim(),
      D: $('#optD').value.trim(),
    },
    correctOption: $('#form-correctOpt').value.trim().toUpperCase(),
    myAnswer: $('#form-myAns').value.trim().toUpperCase(),
    analysis: $('#form-analysis').value.trim(),
    mnemonic: $('#form-mnemonic').value.trim(),
    solutionKey: $('#form-solutionKey').value.trim(),
    similarHint: $('#form-similarHint').value.trim(),
    source: $('#form-source').value.trim(),
    importance: $('#form-importance').value.trim(),
    tags: $('#form-tags').value.split(',').map(s=>s.trim()).filter(Boolean),
    notes: $('#form-notes').value.trim(),
    createdAt: existed? existed.createdAt : Date.now()
  });
  upsertLocal(obj); closeSheet();
};

// Drive ç¶å®š
$('#btn-backup').onclick  = backupToDrive;
$('#btn-restore').onclick = restoreFromDrive;

// ç‰ˆæœ¬å•Ÿå‹•
window.addEventListener('error', e=>{
  console.error(e.error||e.message);
  $('#loading').classList.add('hidden');
});

loadLocal();
render();
updateDriveStatus(false);

// Google SDK æº–å‚™å¥½å¾Œåˆå§‹åŒ–
window.addEventListener('load', ()=>{
  if(window.gapi){ try{ initGapi(); }catch{} }
  if(window.google){ try{ initGis(); }catch{} }
});
</script>

<!-- PWA Service Workerï¼ˆå¯æœ‰å¯ç„¡ï¼‰ -->
<script>
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
