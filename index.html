<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ğŸ“’ è‹±æ–‡éŒ¯é¡Œæœ¬ â€” é›²ç«¯ Drive åŒæ­¥ç‰ˆ</title>

  <!-- PWA -->
  <meta name="theme-color" content="#2563eb" />
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <!-- å­—é«” & Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Identity Services & gapiï¼ˆåŠ  onload ç¢ºä¿åˆå§‹åŒ–ï¼‰ -->
  <script src="https://accounts.google.com/gsi/client" async defer onload="gislkLoaded()"></script>
  <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>

  <style>
    body{font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans TC','PingFang TC','Microsoft JhengHei',sans-serif;background:#f8fafc}
    .btn{padding:.6rem 1rem;border-radius:.6rem;font-weight:800}
    .btn-primary{background:#2563eb;color:#fff}
    .btn-ghost{background:#e5e7eb}
    pre{white-space:pre-wrap;background:#0b1020;color:#d1e7ff;padding:12px;border-radius:10px}
  </style>
</head>
<body class="min-h-screen">

  <header class="sticky top-0 bg-white/80 backdrop-blur border-b">
    <div class="max-w-xl mx-auto px-4 py-3 flex items-center justify-between">
      <div>
        <div id="auth-status" class="text-xs text-gray-500">ğŸ”— é›¢ç·šæ¨¡å¼ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</div>
        <h1 class="text-xl font-extrabold text-gray-800">ğŸ“’ è‹±æ–‡éŒ¯é¡Œæœ¬ (Drive é›²ç«¯)</h1>
      </div>
      <div class="flex gap-2">
        <button id="btn-login" class="btn btn-ghost text-sm">Google ç™»å…¥</button>
        <button id="btn-backup" class="btn btn-primary text-sm" disabled>ğŸ’¾ å‚™ä»½</button>
        <button id="btn-restore" class="btn btn-ghost text-sm" disabled>ğŸ”„ é‚„åŸ</button>
      </div>
    </div>
  </header>

  <main class="max-w-xl mx-auto px-4 py-4">
    <p class="mb-3 text-gray-700">æŒ‰ã€ŒGoogle ç™»å…¥ã€æ¸¬è©¦æˆæ¬Šï¼›æˆåŠŸå¾Œæœƒå˜—è©¦åˆ—å‡º AppData æª”æ¡ˆã€‚</p>
    <pre id="log">åˆå§‹åŒ–ä¸­â€¦</pre>
  </main>

  <script>
    // âœ… ä½¿ç”¨ä½ çš„ Client IDï¼ˆä½ ä¹‹å‰è²¼çš„ï¼‰
    const CLIENT_ID = "1067450972173-l1o4o3fl73f57mcm4rltj520h2ocio12.apps.googleusercontent.com";
    const SCOPE = "https://www.googleapis.com/auth/drive.appdata";

    const $ = (s)=>document.querySelector(s);
    const out = (...m)=>{ const el=$("#log"); el.textContent += (el.textContent ? "\n" : "") + m.join(" "); console.log(...m); };

    let tokenClient = null;
    let gapiReady = false;
    let gisReady  = false;

    function updateAuthStatus(){
      const hasToken = !!gapi?.client?.getToken();
      $("#auth-status").textContent = hasToken ? "âœ… å·²ç™»å…¥ Google" : "ğŸ”— é›¢ç·šæ¨¡å¼ï¼ˆè«‹ç™»å…¥ Googleï¼‰";
      $("#btn-backup").disabled = !hasToken;
      $("#btn-restore").disabled = !hasToken;
    }

    // gapi è¼‰å…¥å¾Œï¼šåˆå§‹åŒ– client + Drive discovery
    function gapiLoaded(){
      gapi.load('client', async () => {
        try{
          await gapi.client.init({});
          await gapi.client.load("https://www.googleapis.com/discovery/v1/apis/drive/v3/rest");
          gapiReady = true;
          out("gapi å·²å°±ç·’");
          updateAuthStatus();
        }catch(e){
          out("âŒ gapi åˆå§‹åŒ–å¤±æ•—ï¼š", e?.message || e);
        }
      });
    }

    // GIS è¼‰å…¥å¾Œï¼šåˆå§‹åŒ– Token Clientï¼ˆé—œéµï¼šinitTokenClientï¼‰
    function gislkLoaded(){
      try{
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPE,
          prompt: '',
          callback: (resp) => {
            if(resp.error){
              out("âŒ ç™»å…¥å¤±æ•—ï¼š", resp.error);
              return;
            }
            // è¨­å®š access_token çµ¦ gapiï¼Œä¹‹å¾Œå¯å‘¼å« Drive
            gapi.client.setToken({ access_token: resp.access_token });
            out("ğŸ‰ å–å¾— access_token");
            updateAuthStatus();
            listAppDataFiles();
          }
        });
        gisReady = true;
        out("GIS å·²å°±ç·’");
        updateAuthStatus();
      }catch(e){
        out("âŒ GIS åˆå§‹åŒ–å¤±æ•—ï¼š", e?.message || e);
      }
    }

    // è§¸ç™¼ç™»å…¥ / å–å¾— token
    $("#btn-login").addEventListener("click", ()=>{
      if(!gapiReady || !gisReady){
        out("â³ æœå‹™åˆå§‹åŒ–ä¸­ï¼Œç¨å¾Œå†è©¦");
        return;
      }
      const hasToken = !!gapi.client.getToken();
      if(hasToken){
        // ç™»å‡ºï¼ˆæ’¤éŠ· tokenï¼‰
        const tk = gapi.client.getToken();
        google.accounts.oauth2.revoke(tk.access_token, ()=>{
          gapi.client.setToken(null);
          out("ğŸ‘‹ å·²ç™»å‡º");
          updateAuthStatus();
        });
      }else{
        tokenClient.requestAccessToken({ prompt: 'consent' });
      }
    });

    // æ¸¬è©¦ï¼šåˆ—å‡º appDataFolder æª”æ¡ˆ
    async function listAppDataFiles(){
      try{
        const res = await gapi.client.drive.files.list({
          spaces: 'appDataFolder',
          fields: 'files(id,name,modifiedTime,size)',
          pageSize: 10
        });
        out("ğŸ“‚ AppData æª”æ¡ˆï¼š", JSON.stringify(res.result.files || [], null, 2));
      }catch(e){
        out("âŒ åˆ—æª”å¤±æ•—ï¼š", e?.message || e);
      }
    }

    // å‚™ä»½ï¼ˆæŠŠä¸€å°æ®µå‡è³‡æ–™å¯«é€² appDataFolderï¼‰
    $("#btn-backup").addEventListener("click", async ()=>{
      const fileMeta = { name: 'english-mistakes.json', parents: ['appDataFolder'], mimeType: 'application/json' };
      const content = JSON.stringify([{ demo:true, ts: Date.now() }], null, 2);

      const boundary = 'x-demo-boundary';
      const body =
        `--${boundary}\r\nContent-Type: application/json\r\n\r\n` +
        JSON.stringify(fileMeta) + `\r\n` +
        `--${boundary}\r\nContent-Type: application/json\r\n\r\n` +
        content + `\r\n--${boundary}--`;

      try{
        await gapi.client.request({
          path: '/upload/drive/v3/files?uploadType=multipart',
          method: 'POST',
          headers: { 'Content-Type': `multipart/related; boundary=${boundary}` },
          body
        });
        out("âœ… å·²å‚™ä»½ä¸€ç­†ç¤ºç¯„è³‡æ–™åˆ° AppData");
        listAppDataFiles();
      }catch(e){
        out("âŒ å‚™ä»½å¤±æ•—ï¼š", e?.message || e);
      }
    });

    // é‚„åŸï¼ˆè®€å–å‰›æ‰çš„ç¤ºç¯„æª”ï¼‰
    $("#btn-restore").addEventListener("click", async ()=>{
      try{
        const list = await gapi.client.drive.files.list({ spaces:'appDataFolder', fields:'files(id,name)', q:"name='english-mistakes.json' and trashed=false", pageSize:1 });
        if(!list.result.files?.length){ out("ï¼ˆæ‰¾ä¸åˆ°ç¤ºç¯„æª”ï¼‰"); return; }
        const id = list.result.files[0].id;
        const file = await gapi.client.drive.files.get({ fileId:id, alt:'media' });
        out("ğŸ”„ è®€åˆ°å…§å®¹ï¼š", JSON.stringify(file.result, null, 2));
      }catch(e){
        out("âŒ é‚„åŸå¤±æ•—ï¼š", e?.message || e);
      }
    });

    // è¨»å†Š Service Workerï¼ˆPWAï¼‰
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{
        navigator.serviceWorker.register('sw.js').catch(()=> out("âš ï¸ Service Worker è¨»å†Šå¤±æ•—"));
      });
    }
  </script>
</body>
</html>
