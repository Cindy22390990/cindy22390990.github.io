<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>📒 英文錯題本（Drive 雲端）</title>
<meta name="theme-color" content="#0ea5e9" />
<link rel="manifest" href="manifest.json" />

<!-- 字體 & Tailwind (CDN) -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
<script src="https://cdn.tailwindcss.com"></script>

<style>
  html,body{height:100%;}
  body{
    font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto,'Noto Sans TC','PingFang TC','Microsoft JhengHei',sans-serif;
    background:#f7fafc;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }
  /* 讓任何元素不要意外吃掉點擊 */
  [data-nope] { pointer-events:none !important; }

  .btn{ @apply rounded-xl font-bold px-4 py-3 transition active:scale-95; }
  .btn-primary{ @apply bg-sky-500 text-white shadow; }
  .btn-ghost{ @apply bg-slate-100 text-slate-700; }
  .btn-disabled{ @apply opacity-40 pointer-events-none; }

  .pill{ @apply text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-700; }

  .card{ @apply bg-white rounded-2xl border border-slate-200 shadow-sm; }
  .tap-lg{ padding:14px 18px; } /* 大觸控區 */
  .safe-bottom{ padding-bottom: max(16px, env(safe-area-inset-bottom)); }

  /* 測驗選項狀態 */
  .opt{ @apply rounded-2xl border px-4 py-4 flex items-center gap-3 text-lg bg-white; border-color:#e5e7eb; }
  .opt em{ @apply inline-flex items-center justify-center w-8 h-8 rounded-full font-bold border; }
  .opt-picked{ @apply ring-2 ring-sky-500; }
  .opt-correct{ @apply bg-emerald-50 border-emerald-300; }
  .opt-wrong{ @apply bg-rose-50 border-rose-300; }
  .opt em.badge{ @apply bg-slate-100 border-slate-300; }

  /* 讓 header 不蓋住點擊；z-index 控制最小即可 */
  header{ position:sticky; top:0; z-index:10; backdrop-filter: blur(8px);}
</style>

<!-- Google 身份服務 / GAPI（先載入，之後再初始化） -->
<script async defer src="https://accounts.google.com/gsi/client"></script>
<script async defer src="https://apis.google.com/js/api.js"></script>
</head>

<body class="min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white/90 border-b border-slate-200">
    <div class="max-w-screen-sm mx-auto px-4 py-3 flex items-start justify-between gap-3">
      <div class="leading-tight">
        <div class="text-xs text-slate-400">ENG Error Notebook</div>
        <h1 class="text-2xl font-black text-slate-900">📒 英文錯題本（Drive 雲端）</h1>
        <div id="status" class="text-xs mt-1 text-slate-500">離線模式（尚未登入）</div>
      </div>
      <div class="flex gap-2 shrink-0">
        <button id="btn-login" class="btn btn-primary tap-lg">Google<br/>登入</button>
        <button id="btn-backup" class="btn btn-ghost tap-lg btn-disabled">備份</button>
        <button id="btn-restore" class="btn btn-ghost tap-lg btn-disabled">還原</button>
      </div>
    </div>
  </header>

  <!-- 快速匯入檔案（本機 JSON） -->
  <section class="max-w-screen-sm mx-auto px-4 pt-3 pb-2">
    <button id="btn-import-file" class="btn btn-ghost">匯入（檔案）</button>
    <input id="file-picker" type="file" accept="application/json" class="hidden" />
  </section>

  <!-- 類別 Tabs -->
  <nav class="max-w-screen-sm mx-auto px-4 pb-2">
    <div class="grid grid-cols-3 gap-2">
      <button class="btn btn-ghost" data-tab="Grammar">📝 文法 <span class="pill ml-1" id="count-grammar">0</span></button>
      <button class="btn btn-ghost" data-tab="Collocations">🔗 片語 <span class="pill ml-1" id="count-coll">0</span></button>
      <button class="btn btn-ghost" data-tab="Vocabulary">💡 單字 <span class="pill ml-1" id="count-vocab">0</span></button>
    </div>
  </nav>

  <!-- 搜尋 + 快速翻 / 測驗 -->
  <section class="max-w-screen-sm mx-auto px-4">
    <div class="flex gap-2">
      <div class="flex-1 relative">
        <input id="search" class="w-full border rounded-xl px-4 py-3 pl-10" placeholder="搜尋題幹/標籤（ex: 介系詞 / schedule）"/>
        <div class="absolute left-3 top-3.5 text-slate-400">🔎</div>
      </div>
      <button id="btn-list" class="btn btn-ghost">📋 快速翻</button>
      <button id="btn-quiz" class="btn btn-ghost">❓ 測驗</button>
    </div>

    <!-- 常錯統計（可點進看標籤） -->
    <div class="flex items-center flex-wrap gap-2 mt-3">
      <div class="text-sm text-slate-600">📈 常錯統計：</div>
      <button class="pill" data-stat="Grammar">文法 <b id="stat-grammar">0</b></button>
      <button class="pill" data-stat="Collocations">片語 <b id="stat-coll">0</b></button>
      <button class="pill" data-stat="Vocabulary">單字 <b id="stat-vocab">0</b></button>
    </div>
  </section>

  <!-- 內容 -->
  <main class="flex-1">
    <div id="list" class="max-w-screen-sm mx-auto px-4 py-4 space-y-4"></div>
    <p id="empty" class="hidden max-w-screen-sm mx-auto px-4 py-16 text-center text-slate-500">
      目前沒有資料，點右下角 <b>＋</b> 新增第一張卡片吧！
    </p>
  </main>

  <!-- 浮動新增 -->
  <div class="fixed right-5 bottom-5 z-20 safe-bottom">
    <button id="btn-add" class="w-16 h-16 rounded-full text-3xl leading-none btn btn-primary shadow-xl">＋</button>
  </div>

  <!-- 編輯面板 -->
  <div id="sheet" class="fixed inset-0 hidden z-30">
    <!-- 半透明背景（不吃點擊） -->
    <div class="absolute inset-0 bg-black/40" data-nope></div>

    <div class="absolute left-0 right-0 bottom-0 max-w-screen-sm mx-auto bg-white rounded-t-3xl p-4 shadow-xl">
      <div class="flex items-center justify-between mb-2">
        <h2 id="sheet-title" class="text-lg font-bold">新增錯題</h2>
        <button id="btn-close-top" class="btn btn-ghost">關閉</button>
      </div>

      <form id="form" class="space-y-3">
        <input type="hidden" id="f-id" />
        <div>
          <label class="text-sm text-slate-600">分類</label>
          <select id="f-cat" class="w-full border rounded-xl px-3 py-2">
            <option value="Grammar">文法</option>
            <option value="Collocations">片語</option>
            <option value="Vocabulary">單字</option>
          </select>
        </div>

        <div>
          <label class="text-sm text-slate-600">題幹</label>
          <textarea id="f-q" rows="2" class="w-full border rounded-xl px-3 py-2"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-sm text-slate-600">❌ 錯誤答案</label>
            <input id="f-w" class="w-full border rounded-xl px-3 py-2" />
          </div>
          <div>
            <label class="text-sm text-slate-600">✅ 正解</label>
            <input id="f-a" class="w-full border rounded-xl px-3 py-2" />
          </div>
        </div>

        <div>
          <label class="text-sm text-slate-600">🔎 錯因分析</label>
          <textarea id="f-an" rows="2" class="w-full border rounded-xl px-3 py-2"></textarea>
        </div>

        <div>
          <label class="text-sm text-slate-600">🎯 記憶口訣/小技巧</label>
          <textarea id="f-mn" rows="2" class="w-full border rounded-xl px-3 py-2"></textarea>
        </div>

        <div>
          <label class="text-sm text-slate-600">標籤（逗號分隔）</label>
          <input id="f-tags" class="w-full border rounded-xl px-3 py-2" placeholder="介系詞, 形容詞, Part5" />
        </div>

        <div class="flex items-center justify-between pt-2">
          <button type="button" id="btn-del" class="text-rose-600 hidden">刪除</button>
          <div class="flex gap-2">
            <button type="button" id="btn-close-bottom" class="btn btn-ghost">關閉</button>
            <button class="btn btn-primary">儲存</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- 提示 -->
  <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-28 z-40 hidden">
    <div class="bg-slate-900 text-white text-sm px-3 py-2 rounded-full shadow">已儲存</div>
  </div>

<script>
(() => {
  // --------- 狀態 ----------
  const LS_KEY = 'eng_error_cards_v2';
  const state = { cat: 'Grammar', mode: 'list', data: [], filtered: [] };

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);

  // --------- UI 基本 ----------
  function toast(msg='已儲存'){
    const t = $('#toast'); t.firstElementChild.textContent = msg;
    t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 1400);
  }

  function loadLocal(){
    try{ state.data = JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ state.data=[]; }
  }
  function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(state.data)); }

  function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }

  // --------- 渲染 ----------
  function renderCounts(){
    $('#count-grammar').textContent = state.data.filter(x=>x.category==='Grammar').length;
    $('#count-coll').textContent    = state.data.filter(x=>x.category==='Collocations').length;
    $('#count-vocab').textContent   = state.data.filter(x=>x.category==='Vocabulary').length;
  }
  function renderStats(){
    // 用錯題次數(答錯+1)統計，先簡單計：以 tag 聚合
    const allWrongByCat = {Grammar:0, Collocations:0, Vocabulary:0};
    state.data.forEach(d=>{
      allWrongByCat[d.category] += (d.wrongCount||0);
    });
    $('#stat-grammar').textContent = allWrongByCat.Grammar;
    $('#stat-coll').textContent    = allWrongByCat.Collocations;
    $('#stat-vocab').textContent   = allWrongByCat.Vocabulary;
  }
  function computeFiltered(){
    const q = $('#search').value.trim().toLowerCase();
    state.filtered = state.data
      .filter(d=>d.category===state.cat)
      .filter(d=>{
        if(!q) return true;
        const blob = [d.question,d.wrongAnswer,d.correctAnswer,d.analysis,d.mnemonic,(d.tags||[]).join(',')].join(' ').toLowerCase();
        return blob.includes(q);
      })
      .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  }

  function choiceButton(letter, text){
    // 顯示只有 ABCD，不附加長句（你要求的）
    const wrap = document.createElement('button');
    wrap.type = 'button';
    wrap.className = 'opt w-full text-left';
    wrap.innerHTML = `<em class="badge">${letter}</em><span>${escapeHTML(letter)}</span>`;
    return wrap;
  }

  function cardEl(it){
    const el = document.createElement('div');
    el.className = 'card p-4 space-y-3';
    el.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="text-sm text-sky-600 font-semibold">${({'Grammar':'📝 文法','Collocations':'🔗 片語','Vocabulary':'💡 單字'}[it.category]||'📄')}</div>
        <div class="text-xs text-slate-400">${new Date(it.createdAt||Date.now()).toLocaleDateString()}</div>
      </div>
      <div class="font-bold text-slate-900">${escapeHTML(it.question||'')}</div>
      <div class="flex gap-1 flex-wrap">${(it.tags||[]).map(t=>`<span class="pill">#${escapeHTML(t)}</span>`).join('')}</div>
      <div class="${state.mode==='quiz'?'':'hidden'}" data-quiz></div>
      <div class="${state.mode==='list'?'':'hidden'}" data-list>
        <div class="grid grid-cols-2 gap-2 text-sm">
          <div class="p-2 bg-rose-50 border border-rose-200 rounded-xl"><b class="text-rose-600">❌</b> ${escapeHTML(it.wrongAnswer||'')}</div>
          <div class="p-2 bg-emerald-50 border border-emerald-200 rounded-xl"><b class="text-emerald-600">✅</b> ${escapeHTML(it.correctAnswer||'')}</div>
        </div>
        <div class="mt-2 p-3 bg-amber-50 border-l-4 border-amber-500 rounded-r-xl text-sm">
          <div class="font-semibold text-amber-800 mb-1">🔎 錯因分析</div>
          <div class="text-slate-800">${escapeHTML(it.analysis||'—')}</div>
        </div>
        <div class="mt-2 p-3 bg-indigo-50 border-l-4 border-indigo-500 rounded-r-xl text-sm">
          <div class="font-semibold text-indigo-800 mb-1">🎯 記憶口訣/小技巧</div>
          <div class="text-slate-800">${escapeHTML(it.mnemonic||'—')}</div>
        </div>
      </div>
      <div class="flex justify-end gap-2">
        <button class="btn btn-ghost" data-edit>編輯</button>
        <button class="btn btn-ghost text-rose-600" data-del>刪除</button>
        <span class="text-sm text-slate-500">錯 <b>${it.wrongCount||0}</b>・心 <b>${it.heart||0}</b></span>
      </div>
    `;

    // 測驗模式建立 ABCD
    const qHost = el.querySelector('[data-quiz]');
    if(qHost){
      const opts = ['A','B','C','D'].map(L=>choiceButton(L, L));
      opts.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          opts.forEach(b=>b.classList.remove('opt-picked','opt-correct','opt-wrong'));
          btn.classList.add('opt-picked');
          const picked = btn.textContent.trim();
          const correct = 'A'; // 只顯示字母，真正判斷用資料的 correctAnswer 的首字母
          const target = (it.correctAnswer||'').trim().charAt(0).toUpperCase();
          if(picked === target){
            btn.classList.add('opt-correct');
            it.heart = (it.heart||0)+1;
          }else{
            btn.classList.add('opt-wrong');
            it.wrongCount = (it.wrongCount||0)+1;
          }
          saveLocal(); renderStats();
        });
        qHost.appendChild(btn);
      });
    }

    el.querySelector('[data-edit]').onclick = ()=>openSheet(it);
    el.querySelector('[data-del]').onclick = ()=>{ if(confirm('確定刪除？')){ del(it.id); } };
    return el;
  }

  function render(){
    renderCounts(); renderStats(); computeFiltered();
    const host = $('#list'); host.innerHTML='';
    if(state.filtered.length===0){ $('#empty').classList.remove('hidden'); }
    else{ $('#empty').classList.add('hidden'); state.filtered.forEach(it=>host.appendChild(cardEl(it))); }
  }

  // --------- CRUD ----------
  function upsert(obj){
    const idx = state.data.findIndex(d=>d.id===obj.id);
    if(idx>=0) state.data[idx]=obj; else state.data.unshift(obj);
    saveLocal(); render(); toast('已儲存');
  }
  function del(id){
    const i = state.data.findIndex(d=>d.id===id);
    if(i>=0){ state.data.splice(i,1); saveLocal(); render(); }
  }

  // --------- 面板 ----------
  function openSheet(it=null){
    $('#sheet').classList.remove('hidden');
    $('#sheet-title').textContent = it?'編輯錯題':'新增錯題';
    $('#btn-del').classList.toggle('hidden', !it);
    $('#f-id').value = it?.id || '';
    $('#f-cat').value = it?.category || state.cat;
    $('#f-q').value = it?.question || '';
    $('#f-w').value = it?.wrongAnswer || '';
    $('#f-a').value = it?.correctAnswer || '';
    $('#f-an').value = it?.analysis || '';
    $('#f-mn').value = it?.mnemonic || '';
    $('#f-tags').value = (it?.tags||[]).join(', ');
  }
  function closeSheet(){ $('#sheet').classList.add('hidden'); }

  // --------- 檔案匯入（本機 JSON） ----------
  $('#btn-import-file').addEventListener('click', ()=> $('#file-picker').click());
  $('#file-picker').addEventListener('change', (e)=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const arr = JSON.parse(r.result);
        if(Array.isArray(arr)){
          // 合併
          const key = o => (o.question||'')+'|'+(o.correctAnswer||'');
          const map = new Map(state.data.map(o=>[key(o),o]));
          arr.forEach(o=>{
            o.id=o.id||uid();
            o.tags = Array.isArray(o.tags) ? o.tags : String(o.tags||'').split(',').map(s=>s.trim()).filter(Boolean);
            map.set(key(o), o);
          });
          state.data = Array.from(map.values());
          saveLocal(); render(); toast('已匯入');
        }
      }catch{ toast('匯入失敗'); }
    };
    r.readAsText(f); e.target.value='';
  });

  // --------- 事件與初始化 ----------
  document.addEventListener('DOMContentLoaded', ()=>{
    // Tabs
    $$('[data-tab]').forEach(b=>{
      b.addEventListener('click', ()=>{ state.cat=b.dataset.tab; render(); });
    });
    // 模式
    $('#btn-list').addEventListener('click', ()=>{ state.mode='list'; render(); });
    $('#btn-quiz').addEventListener('click', ()=>{ state.mode='quiz'; render(); });

    // 新增
    $('#btn-add').addEventListener('click', ()=>openSheet());
    $('#btn-close-top').addEventListener('click', closeSheet);
    $('#btn-close-bottom').addEventListener('click', closeSheet);
    $('#btn-del').addEventListener('click', ()=>{
      const id=$('#f-id').value; if(id){ closeSheet(); del(id); }
    });
    $('#form').addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = $('#f-id').value || uid();
      const existed = state.data.find(d=>d.id===id);
      const obj = {
        id,
        category: $('#f-cat').value,
        question: $('#f-q').value.trim(),
        wrongAnswer: $('#f-w').value.trim(),
        correctAnswer: $('#f-a').value.trim(),
        analysis: $('#f-an').value.trim(),
        mnemonic: $('#f-mn').value.trim(),
        tags: $('#f-tags').value.split(',').map(s=>s.trim()).filter(Boolean),
        createdAt: existed? existed.createdAt : Date.now(),
        wrongCount: existed? (existed.wrongCount||0):0,
        heart: existed? (existed.heart||0):0
      };
      upsert(obj); closeSheet();
    });

    // 搜尋
    $('#search').addEventListener('input', render);

    // 資料
    loadLocal(); render();
  });

  // --------- Google 登入 / 備份 / 還原（先能按，有明確提示） ----------
  const CLIENT_ID = 'myappproject-473806';
  let accessToken = null;

  function uiLogin(on){
    $('#status').textContent = on ? '✅ 已登入 Google' : '離線模式（尚未登入）';
    $('#btn-backup').classList.toggle('btn-disabled', !on);
    $('#btn-restore').classList.toggle('btn-disabled', !on);
    $('#btn-login').innerHTML = on ? '已登入<br/>Google' : 'Google<br/>登入';
  }

  async function initGapi(){
    return new Promise(res=>{
      gapi.load('client', async ()=>{
        await gapi.client.init({
          clientId: CLIENT_ID,
          scope: 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.file',
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
        });
        res(true);
      });
    });
  }

  async function doLogin(){
    if(!CLIENT_ID || CLIENT_ID.includes('myappproject-473806')){
      toast('請先在程式填入 Google Client ID');
      return;
    }
    await initGapi();
    try{
      const token = gapi.client.getToken();
      if(!token){
        // 使用 code flow（彈窗）
        const client = google.accounts.oauth2.initCodeClient({
          client_id: CLIENT_ID,
          scope: 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.file',
          ux_mode: 'popup',
          callback: async (resp)=>{
            if(resp.code){
              // 用 code 兌換 token：純前端無法完成；這裡直接叫用彈窗式 access token（簡化）
              // 簡化處理：改用 token client
              const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.file',
                callback:(t)=>{ accessToken=t.access_token; gapi.client.setToken(t); uiLogin(true); toast('已登入'); }
              });
              tokenClient.requestAccessToken();
            }
          }
        });
        client.requestCode();
      }else{
        accessToken = token.access_token;
        uiLogin(true);
      }
    }catch(err){
      console.error(err);
      toast('登入失敗，請檢查 GCP 設定');
    }
  }

  async function backup(){
    if(!accessToken){ toast('尚未登入'); return; }
    try{
      const data = JSON.stringify(state.data||[], null, 2);
      // 直接建立/更新一個固定檔名
      const name = 'english_mistakes_v2.json';

      // 先找有沒有
      const list = await gapi.client.drive.files.list({ q: `name='${name}' and trashed=false`, fields:'files(id,name)' });
      let id = list.result.files?.[0]?.id;

      if(id){
        await gapi.client.request({
          path:`/upload/drive/v3/files/${id}`,
          method:'PATCH',
          params:{ uploadType:'media' },
          headers:{ 'Content-Type':'application/json' },
          body:data
        });
      }else{
        const metadata = { name, mimeType:'application/json' };
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)],{type:'application/json'}));
        form.append('file', new Blob([data],{type:'application/json'}));
        const r = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
          method:'POST',
          headers:{ 'Authorization':`Bearer ${accessToken}` },
          body:form
        });
        const jr = await r.json(); id = jr.id;
      }
      toast('✅ 備份完成');
    }catch(e){
      console.error(e);
      toast('備份失敗：請完成 GCP 發佈/授權網域/啟用 Drive API');
    }
  }

  async function restore(){
    if(!accessToken){ toast('尚未登入'); return; }
    try{
      const name='english_mistakes_v2.json';
      const list = await gapi.client.drive.files.list({ q:`name='${name}' and trashed=false`, fields:'files(id,name)' });
      const id = list.result.files?.[0]?.id;
      if(!id){ toast('雲端沒有備份檔'); return; }
      const file = await gapi.client.drive.files.get({ fileId:id, alt:'media' });
      if(Array.isArray(file.result)){
        // 合併
        const key = o => (o.question||'')+'|'+(o.correctAnswer||'');
        const map=new Map(state.data.map(o=>[key(o),o]));
        file.result.forEach(o=>{
          o.id=o.id||uid();
          o.tags = Array.isArray(o.tags) ? o.tags : String(o.tags||'').split(',').map(s=>s.trim()).filter(Boolean);
          map.set(key(o),o);
        });
        state.data = Array.from(map.values());
        saveLocal(); render(); toast('✅ 還原完成');
      }else{
        toast('還原格式不正確');
      }
    }catch(e){
      console.error(e);
      toast('還原失敗：請檢查權限或網路');
    }
  }

  // 綁定
  $('#btn-login').addEventListener('click', doLogin);
  $('#btn-backup').addEventListener('click', backup);
  $('#btn-restore').addEventListener('click', restore);

})(); 
</script>

</body>
</html>
