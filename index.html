<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ğŸ“’ è‹±æ–‡éŒ¯é¡Œæœ¬ï¼ˆDrive é›²ç«¯ï¼‰</title>
<meta name="theme-color" content="#0ea5e9" />
<link rel="manifest" href="manifest.json" />

<!-- å­—é«” & Tailwind (CDN) -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
<script src="https://cdn.tailwindcss.com"></script>

<style>
  html,body{height:100%;}
  body{
    font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto,'Noto Sans TC','PingFang TC','Microsoft JhengHei',sans-serif;
    background:#f7fafc;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }
  /* è®“ä»»ä½•å…ƒç´ ä¸è¦æ„å¤–åƒæ‰é»æ“Š */
  [data-nope] { pointer-events:none !important; }

  .btn{ @apply rounded-xl font-bold px-4 py-3 transition active:scale-95; }
  .btn-primary{ @apply bg-sky-500 text-white shadow; }
  .btn-ghost{ @apply bg-slate-100 text-slate-700; }
  .btn-disabled{ @apply opacity-40 pointer-events-none; }

  .pill{ @apply text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-700; }

  .card{ @apply bg-white rounded-2xl border border-slate-200 shadow-sm; }
  .tap-lg{ padding:14px 18px; } /* å¤§è§¸æ§å€ */
  .safe-bottom{ padding-bottom: max(16px, env(safe-area-inset-bottom)); }

  /* æ¸¬é©—é¸é …ç‹€æ…‹ */
  .opt{ @apply rounded-2xl border px-4 py-4 flex items-center gap-3 text-lg bg-white; border-color:#e5e7eb; }
  .opt em{ @apply inline-flex items-center justify-center w-8 h-8 rounded-full font-bold border; }
  .opt-picked{ @apply ring-2 ring-sky-500; }
  .opt-correct{ @apply bg-emerald-50 border-emerald-300; }
  .opt-wrong{ @apply bg-rose-50 border-rose-300; }
  .opt em.badge{ @apply bg-slate-100 border-slate-300; }

  /* è®“ header ä¸è“‹ä½é»æ“Šï¼›z-index æ§åˆ¶æœ€å°å³å¯ */
  header{ position:sticky; top:0; z-index:10; backdrop-filter: blur(8px);}
</style>

<!-- Google èº«ä»½æœå‹™ / GAPIï¼ˆå…ˆè¼‰å…¥ï¼Œä¹‹å¾Œå†åˆå§‹åŒ–ï¼‰ -->
<script async defer src="https://accounts.google.com/gsi/client"></script>
<script async defer src="https://apis.google.com/js/api.js"></script>
</head>

<body class="min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white/90 border-b border-slate-200">
    <div class="max-w-screen-sm mx-auto px-4 py-3 flex items-start justify-between gap-3">
      <div class="leading-tight">
        <div class="text-xs text-slate-400">ENG Error Notebook</div>
        <h1 class="text-2xl font-black text-slate-900">ğŸ“’ è‹±æ–‡éŒ¯é¡Œæœ¬ï¼ˆDrive é›²ç«¯ï¼‰</h1>
        <div id="status" class="text-xs mt-1 text-slate-500">é›¢ç·šæ¨¡å¼ï¼ˆå°šæœªç™»å…¥ï¼‰</div>
      </div>
      <div class="flex gap-2 shrink-0">
        <button id="btn-login" class="btn btn-primary tap-lg">Google<br/>ç™»å…¥</button>
        <button id="btn-backup" class="btn btn-ghost tap-lg btn-disabled">å‚™ä»½</button>
        <button id="btn-restore" class="btn btn-ghost tap-lg btn-disabled">é‚„åŸ</button>
      </div>
    </div>
  </header>

  <!-- å¿«é€ŸåŒ¯å…¥æª”æ¡ˆï¼ˆæœ¬æ©Ÿ JSONï¼‰ -->
  <section class="max-w-screen-sm mx-auto px-4 pt-3 pb-2">
    <button id="btn-import-file" class="btn btn-ghost">åŒ¯å…¥ï¼ˆæª”æ¡ˆï¼‰</button>
    <input id="file-picker" type="file" accept="application/json" class="hidden" />
  </section>

  <!-- é¡åˆ¥ Tabs -->
  <nav class="max-w-screen-sm mx-auto px-4 pb-2">
    <div class="grid grid-cols-3 gap-2">
      <button class="btn btn-ghost" data-tab="Grammar">ğŸ“ æ–‡æ³• <span class="pill ml-1" id="count-grammar">0</span></button>
      <button class="btn btn-ghost" data-tab="Collocations">ğŸ”— ç‰‡èª <span class="pill ml-1" id="count-coll">0</span></button>
      <button class="btn btn-ghost" data-tab="Vocabulary">ğŸ’¡ å–®å­— <span class="pill ml-1" id="count-vocab">0</span></button>
    </div>
  </nav>

  <!-- æœå°‹ + å¿«é€Ÿç¿» / æ¸¬é©— -->
  <section class="max-w-screen-sm mx-auto px-4">
    <div class="flex gap-2">
      <div class="flex-1 relative">
        <input id="search" class="w-full border rounded-xl px-4 py-3 pl-10" placeholder="æœå°‹é¡Œå¹¹/æ¨™ç±¤ï¼ˆex: ä»‹ç³»è© / scheduleï¼‰"/>
        <div class="absolute left-3 top-3.5 text-slate-400">ğŸ”</div>
      </div>
      <button id="btn-list" class="btn btn-ghost">ğŸ“‹ å¿«é€Ÿç¿»</button>
      <button id="btn-quiz" class="btn btn-ghost">â“ æ¸¬é©—</button>
    </div>

    <!-- å¸¸éŒ¯çµ±è¨ˆï¼ˆå¯é»é€²çœ‹æ¨™ç±¤ï¼‰ -->
    <div class="flex items-center flex-wrap gap-2 mt-3">
      <div class="text-sm text-slate-600">ğŸ“ˆ å¸¸éŒ¯çµ±è¨ˆï¼š</div>
      <button class="pill" data-stat="Grammar">æ–‡æ³• <b id="stat-grammar">0</b></button>
      <button class="pill" data-stat="Collocations">ç‰‡èª <b id="stat-coll">0</b></button>
      <button class="pill" data-stat="Vocabulary">å–®å­— <b id="stat-vocab">0</b></button>
    </div>
  </section>

  <!-- å…§å®¹ -->
  <main class="flex-1">
    <div id="list" class="max-w-screen-sm mx-auto px-4 py-4 space-y-4"></div>
    <p id="empty" class="hidden max-w-screen-sm mx-auto px-4 py-16 text-center text-slate-500">
      ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œé»å³ä¸‹è§’ <b>ï¼‹</b> æ–°å¢ç¬¬ä¸€å¼µå¡ç‰‡å§ï¼
    </p>
  </main>

  <!-- æµ®å‹•æ–°å¢ -->
  <div class="fixed right-5 bottom-5 z-20 safe-bottom">
    <button id="btn-add" class="w-16 h-16 rounded-full text-3xl leading-none btn btn-primary shadow-xl">ï¼‹</button>
  </div>

  <!-- ç·¨è¼¯é¢æ¿ -->
  <div id="sheet" class="fixed inset-0 hidden z-30">
    <!-- åŠé€æ˜èƒŒæ™¯ï¼ˆä¸åƒé»æ“Šï¼‰ -->
    <div class="absolute inset-0 bg-black/40" data-nope></div>

    <div class="absolute left-0 right-0 bottom-0 max-w-screen-sm mx-auto bg-white rounded-t-3xl p-4 shadow-xl">
      <div class="flex items-center justify-between mb-2">
        <h2 id="sheet-title" class="text-lg font-bold">æ–°å¢éŒ¯é¡Œ</h2>
        <button id="btn-close-top" class="btn btn-ghost">é—œé–‰</button>
      </div>

      <form id="form" class="space-y-3">
        <input type="hidden" id="f-id" />
        <div>
          <label class="text-sm text-slate-600">åˆ†é¡</label>
          <select id="f-cat" class="w-full border rounded-xl px-3 py-2">
            <option value="Grammar">æ–‡æ³•</option>
            <option value="Collocations">ç‰‡èª</option>
            <option value="Vocabulary">å–®å­—</option>
          </select>
        </div>

        <div>
          <label class="text-sm text-slate-600">é¡Œå¹¹</label>
          <textarea id="f-q" rows="2" class="w-full border rounded-xl px-3 py-2"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-sm text-slate-600">âŒ éŒ¯èª¤ç­”æ¡ˆ</label>
            <input id="f-w" class="w-full border rounded-xl px-3 py-2" />
          </div>
          <div>
            <label class="text-sm text-slate-600">âœ… æ­£è§£</label>
            <input id="f-a" class="w-full border rounded-xl px-3 py-2" />
          </div>
        </div>

        <div>
          <label class="text-sm text-slate-600">ğŸ” éŒ¯å› åˆ†æ</label>
          <textarea id="f-an" rows="2" class="w-full border rounded-xl px-3 py-2"></textarea>
        </div>

        <div>
          <label class="text-sm text-slate-600">ğŸ¯ è¨˜æ†¶å£è¨£/å°æŠ€å·§</label>
          <textarea id="f-mn" rows="2" class="w-full border rounded-xl px-3 py-2"></textarea>
        </div>

        <div>
          <label class="text-sm text-slate-600">æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
          <input id="f-tags" class="w-full border rounded-xl px-3 py-2" placeholder="ä»‹ç³»è©, å½¢å®¹è©, Part5" />
        </div>

        <div class="flex items-center justify-between pt-2">
          <button type="button" id="btn-del" class="text-rose-600 hidden">åˆªé™¤</button>
          <div class="flex gap-2">
            <button type="button" id="btn-close-bottom" class="btn btn-ghost">é—œé–‰</button>
            <button class="btn btn-primary">å„²å­˜</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- æç¤º -->
  <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-28 z-40 hidden">
    <div class="bg-slate-900 text-white text-sm px-3 py-2 rounded-full shadow">å·²å„²å­˜</div>
  </div>

<script>
(() => {
  // --------- ç‹€æ…‹ ----------
  const LS_KEY = 'eng_error_cards_v2';
  const state = { cat: 'Grammar', mode: 'list', data: [], filtered: [] };

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);

  // --------- UI åŸºæœ¬ ----------
  function toast(msg='å·²å„²å­˜'){
    const t = $('#toast'); t.firstElementChild.textContent = msg;
    t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 1400);
  }

  function loadLocal(){
    try{ state.data = JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ state.data=[]; }
  }
  function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(state.data)); }

  function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }

  // --------- æ¸²æŸ“ ----------
  function renderCounts(){
    $('#count-grammar').textContent = state.data.filter(x=>x.category==='Grammar').length;
    $('#count-coll').textContent    = state.data.filter(x=>x.category==='Collocations').length;
    $('#count-vocab').textContent   = state.data.filter(x=>x.category==='Vocabulary').length;
  }
  function renderStats(){
    // ç”¨éŒ¯é¡Œæ¬¡æ•¸(ç­”éŒ¯+1)çµ±è¨ˆï¼Œå…ˆç°¡å–®è¨ˆï¼šä»¥ tag èšåˆ
    const allWrongByCat = {Grammar:0, Collocations:0, Vocabulary:0};
    state.data.forEach(d=>{
      allWrongByCat[d.category] += (d.wrongCount||0);
    });
    $('#stat-grammar').textContent = allWrongByCat.Grammar;
    $('#stat-coll').textContent    = allWrongByCat.Collocations;
    $('#stat-vocab').textContent   = allWrongByCat.Vocabulary;
  }
  function computeFiltered(){
    const q = $('#search').value.trim().toLowerCase();
    state.filtered = state.data
      .filter(d=>d.category===state.cat)
      .filter(d=>{
        if(!q) return true;
        const blob = [d.question,d.wrongAnswer,d.correctAnswer,d.analysis,d.mnemonic,(d.tags||[]).join(',')].join(' ').toLowerCase();
        return blob.includes(q);
      })
      .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  }

  function choiceButton(letter, text){
    // é¡¯ç¤ºåªæœ‰ ABCDï¼Œä¸é™„åŠ é•·å¥ï¼ˆä½ è¦æ±‚çš„ï¼‰
    const wrap = document.createElement('button');
    wrap.type = 'button';
    wrap.className = 'opt w-full text-left';
    wrap.innerHTML = `<em class="badge">${letter}</em><span>${escapeHTML(letter)}</span>`;
    return wrap;
  }

  function cardEl(it){
    const el = document.createElement('div');
    el.className = 'card p-4 space-y-3';
    el.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="text-sm text-sky-600 font-semibold">${({'Grammar':'ğŸ“ æ–‡æ³•','Collocations':'ğŸ”— ç‰‡èª','Vocabulary':'ğŸ’¡ å–®å­—'}[it.category]||'ğŸ“„')}</div>
        <div class="text-xs text-slate-400">${new Date(it.createdAt||Date.now()).toLocaleDateString()}</div>
      </div>
      <div class="font-bold text-slate-900">${escapeHTML(it.question||'')}</div>
      <div class="flex gap-1 flex-wrap">${(it.tags||[]).map(t=>`<span class="pill">#${escapeHTML(t)}</span>`).join('')}</div>
      <div class="${state.mode==='quiz'?'':'hidden'}" data-quiz></div>
      <div class="${state.mode==='list'?'':'hidden'}" data-list>
        <div class="grid grid-cols-2 gap-2 text-sm">
          <div class="p-2 bg-rose-50 border border-rose-200 rounded-xl"><b class="text-rose-600">âŒ</b> ${escapeHTML(it.wrongAnswer||'')}</div>
          <div class="p-2 bg-emerald-50 border border-emerald-200 rounded-xl"><b class="text-emerald-600">âœ…</b> ${escapeHTML(it.correctAnswer||'')}</div>
        </div>
        <div class="mt-2 p-3 bg-amber-50 border-l-4 border-amber-500 rounded-r-xl text-sm">
          <div class="font-semibold text-amber-800 mb-1">ğŸ” éŒ¯å› åˆ†æ</div>
          <div class="text-slate-800">${escapeHTML(it.analysis||'â€”')}</div>
        </div>
        <div class="mt-2 p-3 bg-indigo-50 border-l-4 border-indigo-500 rounded-r-xl text-sm">
          <div class="font-semibold text-indigo-800 mb-1">ğŸ¯ è¨˜æ†¶å£è¨£/å°æŠ€å·§</div>
          <div class="text-slate-800">${escapeHTML(it.mnemonic||'â€”')}</div>
        </div>
      </div>
      <div class="flex justify-end gap-2">
        <button class="btn btn-ghost" data-edit>ç·¨è¼¯</button>
        <button class="btn btn-ghost text-rose-600" data-del>åˆªé™¤</button>
        <span class="text-sm text-slate-500">éŒ¯ <b>${it.wrongCount||0}</b>ãƒ»å¿ƒ <b>${it.heart||0}</b></span>
      </div>
    `;

    // æ¸¬é©—æ¨¡å¼å»ºç«‹ ABCD
    const qHost = el.querySelector('[data-quiz]');
    if(qHost){
      const opts = ['A','B','C','D'].map(L=>choiceButton(L, L));
      opts.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          opts.forEach(b=>b.classList.remove('opt-picked','opt-correct','opt-wrong'));
          btn.classList.add('opt-picked');
          const picked = btn.textContent.trim();
          const correct = 'A'; // åªé¡¯ç¤ºå­—æ¯ï¼ŒçœŸæ­£åˆ¤æ–·ç”¨è³‡æ–™çš„ correctAnswer çš„é¦–å­—æ¯
          const target = (it.correctAnswer||'').trim().charAt(0).toUpperCase();
          if(picked === target){
            btn.classList.add('opt-correct');
            it.heart = (it.heart||0)+1;
          }else{
            btn.classList.add('opt-wrong');
            it.wrongCount = (it.wrongCount||0)+1;
          }
          saveLocal(); renderStats();
        });
        qHost.appendChild(btn);
      });
    }

    el.querySelector('[data-edit]').onclick = ()=>openSheet(it);
    el.querySelector('[data-del]').onclick = ()=>{ if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')){ del(it.id); } };
    return el;
  }

  function render(){
    renderCounts(); renderStats(); computeFiltered();
    const host = $('#list'); host.innerHTML='';
    if(state.filtered.length===0){ $('#empty').classList.remove('hidden'); }
    else{ $('#empty').classList.add('hidden'); state.filtered.forEach(it=>host.appendChild(cardEl(it))); }
  }

  // --------- CRUD ----------
  function upsert(obj){
    const idx = state.data.findIndex(d=>d.id===obj.id);
    if(idx>=0) state.data[idx]=obj; else state.data.unshift(obj);
    saveLocal(); render(); toast('å·²å„²å­˜');
  }
  function del(id){
    const i = state.data.findIndex(d=>d.id===id);
    if(i>=0){ state.data.splice(i,1); saveLocal(); render(); }
  }

  // --------- é¢æ¿ ----------
  function openSheet(it=null){
    $('#sheet').classList.remove('hidden');
    $('#sheet-title').textContent = it?'ç·¨è¼¯éŒ¯é¡Œ':'æ–°å¢éŒ¯é¡Œ';
    $('#btn-del').classList.toggle('hidden', !it);
    $('#f-id').value = it?.id || '';
    $('#f-cat').value = it?.category || state.cat;
    $('#f-q').value = it?.question || '';
    $('#f-w').value = it?.wrongAnswer || '';
    $('#f-a').value = it?.correctAnswer || '';
    $('#f-an').value = it?.analysis || '';
    $('#f-mn').value = it?.mnemonic || '';
    $('#f-tags').value = (it?.tags||[]).join(', ');
  }
  function closeSheet(){ $('#sheet').classList.add('hidden'); }

  // --------- æª”æ¡ˆåŒ¯å…¥ï¼ˆæœ¬æ©Ÿ JSONï¼‰ ----------
  $('#btn-import-file').addEventListener('click', ()=> $('#file-picker').click());
  $('#file-picker').addEventListener('change', (e)=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const arr = JSON.parse(r.result);
        if(Array.isArray(arr)){
          // åˆä½µ
          const key = o => (o.question||'')+'|'+(o.correctAnswer||'');
          const map = new Map(state.data.map(o=>[key(o),o]));
          arr.forEach(o=>{
            o.id=o.id||uid();
            o.tags = Array.isArray(o.tags) ? o.tags : String(o.tags||'').split(',').map(s=>s.trim()).filter(Boolean);
            map.set(key(o), o);
          });
          state.data = Array.from(map.values());
          saveLocal(); render(); toast('å·²åŒ¯å…¥');
        }
      }catch{ toast('åŒ¯å…¥å¤±æ•—'); }
    };
    r.readAsText(f); e.target.value='';
  });

  // --------- äº‹ä»¶èˆ‡åˆå§‹åŒ– ----------
  document.addEventListener('DOMContentLoaded', ()=>{
    // Tabs
    $$('[data-tab]').forEach(b=>{
      b.addEventListener('click', ()=>{ state.cat=b.dataset.tab; render(); });
    });
    // æ¨¡å¼
    $('#btn-list').addEventListener('click', ()=>{ state.mode='list'; render(); });
    $('#btn-quiz').addEventListener('click', ()=>{ state.mode='quiz'; render(); });

    // æ–°å¢
    $('#btn-add').addEventListener('click', ()=>openSheet());
    $('#btn-close-top').addEventListener('click', closeSheet);
    $('#btn-close-bottom').addEventListener('click', closeSheet);
    $('#btn-del').addEventListener('click', ()=>{
      const id=$('#f-id').value; if(id){ closeSheet(); del(id); }
    });
    $('#form').addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = $('#f-id').value || uid();
      const existed = state.data.find(d=>d.id===id);
      const obj = {
        id,
        category: $('#f-cat').value,
        question: $('#f-q').value.trim(),
        wrongAnswer: $('#f-w').value.trim(),
        correctAnswer: $('#f-a').value.trim(),
        analysis: $('#f-an').value.trim(),
        mnemonic: $('#f-mn').value.trim(),
        tags: $('#f-tags').value.split(',').map(s=>s.trim()).filter(Boolean),
        createdAt: existed? existed.createdAt : Date.now(),
        wrongCount: existed? (existed.wrongCount||0):0,
        heart: existed? (existed.heart||0):0
      };
      upsert(obj); closeSheet();
    });

    // æœå°‹
    $('#search').addEventListener('input', render);

    // è³‡æ–™
    loadLocal(); render();
  });

  // --------- Google ç™»å…¥ / å‚™ä»½ / é‚„åŸï¼ˆå…ˆèƒ½æŒ‰ï¼Œæœ‰æ˜ç¢ºæç¤ºï¼‰ ----------
  const CLIENT_ID = 'myappproject-473806';
  let accessToken = null;

  function uiLogin(on){
    $('#status').textContent = on ? 'âœ… å·²ç™»å…¥ Google' : 'é›¢ç·šæ¨¡å¼ï¼ˆå°šæœªç™»å…¥ï¼‰';
    $('#btn-backup').classList.toggle('btn-disabled', !on);
    $('#btn-restore').classList.toggle('btn-disabled', !on);
    $('#btn-login').innerHTML = on ? 'å·²ç™»å…¥<br/>Google' : 'Google<br/>ç™»å…¥';
  }

  async function initGapi(){
    return new Promise(res=>{
      gapi.load('client', async ()=>{
        await gapi.client.init({
          clientId: CLIENT_ID,
          scope: 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.file',
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
        });
        res(true);
      });
    });
  }

  async function doLogin(){
    if(!CLIENT_ID || CLIENT_ID.includes('myappproject-473806')){
      toast('è«‹å…ˆåœ¨ç¨‹å¼å¡«å…¥ Google Client ID');
      return;
    }
    await initGapi();
    try{
      const token = gapi.client.getToken();
      if(!token){
        // ä½¿ç”¨ code flowï¼ˆå½ˆçª—ï¼‰
        const client = google.accounts.oauth2.initCodeClient({
          client_id: CLIENT_ID,
          scope: 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.file',
          ux_mode: 'popup',
          callback: async (resp)=>{
            if(resp.code){
              // ç”¨ code å…Œæ› tokenï¼šç´”å‰ç«¯ç„¡æ³•å®Œæˆï¼›é€™è£¡ç›´æ¥å«ç”¨å½ˆçª—å¼ access tokenï¼ˆç°¡åŒ–ï¼‰
              // ç°¡åŒ–è™•ç†ï¼šæ”¹ç”¨ token client
              const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.file',
                callback:(t)=>{ accessToken=t.access_token; gapi.client.setToken(t); uiLogin(true); toast('å·²ç™»å…¥'); }
              });
              tokenClient.requestAccessToken();
            }
          }
        });
        client.requestCode();
      }else{
        accessToken = token.access_token;
        uiLogin(true);
      }
    }catch(err){
      console.error(err);
      toast('ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ GCP è¨­å®š');
    }
  }

  async function backup(){
    if(!accessToken){ toast('å°šæœªç™»å…¥'); return; }
    try{
      const data = JSON.stringify(state.data||[], null, 2);
      // ç›´æ¥å»ºç«‹/æ›´æ–°ä¸€å€‹å›ºå®šæª”å
      const name = 'english_mistakes_v2.json';

      // å…ˆæ‰¾æœ‰æ²’æœ‰
      const list = await gapi.client.drive.files.list({ q: `name='${name}' and trashed=false`, fields:'files(id,name)' });
      let id = list.result.files?.[0]?.id;

      if(id){
        await gapi.client.request({
          path:`/upload/drive/v3/files/${id}`,
          method:'PATCH',
          params:{ uploadType:'media' },
          headers:{ 'Content-Type':'application/json' },
          body:data
        });
      }else{
        const metadata = { name, mimeType:'application/json' };
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)],{type:'application/json'}));
        form.append('file', new Blob([data],{type:'application/json'}));
        const r = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
          method:'POST',
          headers:{ 'Authorization':`Bearer ${accessToken}` },
          body:form
        });
        const jr = await r.json(); id = jr.id;
      }
      toast('âœ… å‚™ä»½å®Œæˆ');
    }catch(e){
      console.error(e);
      toast('å‚™ä»½å¤±æ•—ï¼šè«‹å®Œæˆ GCP ç™¼ä½ˆ/æˆæ¬Šç¶²åŸŸ/å•Ÿç”¨ Drive API');
    }
  }

  async function restore(){
    if(!accessToken){ toast('å°šæœªç™»å…¥'); return; }
    try{
      const name='english_mistakes_v2.json';
      const list = await gapi.client.drive.files.list({ q:`name='${name}' and trashed=false`, fields:'files(id,name)' });
      const id = list.result.files?.[0]?.id;
      if(!id){ toast('é›²ç«¯æ²’æœ‰å‚™ä»½æª”'); return; }
      const file = await gapi.client.drive.files.get({ fileId:id, alt:'media' });
      if(Array.isArray(file.result)){
        // åˆä½µ
        const key = o => (o.question||'')+'|'+(o.correctAnswer||'');
        const map=new Map(state.data.map(o=>[key(o),o]));
        file.result.forEach(o=>{
          o.id=o.id||uid();
          o.tags = Array.isArray(o.tags) ? o.tags : String(o.tags||'').split(',').map(s=>s.trim()).filter(Boolean);
          map.set(key(o),o);
        });
        state.data = Array.from(map.values());
        saveLocal(); render(); toast('âœ… é‚„åŸå®Œæˆ');
      }else{
        toast('é‚„åŸæ ¼å¼ä¸æ­£ç¢º');
      }
    }catch(e){
      console.error(e);
      toast('é‚„åŸå¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™æˆ–ç¶²è·¯');
    }
  }

  // ç¶å®š
  $('#btn-login').addEventListener('click', doLogin);
  $('#btn-backup').addEventListener('click', backup);
  $('#btn-restore').addEventListener('click', restore);

})(); 
</script>

</body>
</html>
