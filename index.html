<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ğŸ“’ è‹±æ–‡éŒ¯é¡Œæœ¬ï¼ˆDrive é›²ç«¯ï¼‰</title>
<meta name="theme-color" content="#2563eb" />
<link rel="manifest" href="manifest.json" />
<link rel="apple-touch-icon" href="icon-192.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800;900&display=swap" rel="stylesheet" />
<script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
<script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root{--safe-top:max(env(safe-area-inset-top),18px);--safe-side:max(env(safe-area-inset-left),16px);--pad:16px;}
  body{font-family:'Inter',system-ui,-apple-system,'SF Pro Text','PingFang TC','Noto Sans TC','Microsoft JhengHei',sans-serif;background:#f7f9fc;color:#0f172a;}
  .safe-top{height:var(--safe-top)}
  .container-pad{padding-left:calc(var(--safe-side) + var(--pad));padding-right:calc(var(--safe-side) + var(--pad))}
  .header{position:sticky;top:0;z-index:40;background:#fff;border-bottom:1px solid #e5e7eb;backdrop-filter:blur(6px)}
  .btn{border-radius:14px;font-weight:800;padding:.65rem 1rem;transition:.06s transform}
  .btn:active{transform:scale(.98)}
  .btn-lg{min-height:54px}
  .btn-primary{background:#2563eb;color:#fff}
  .btn-ghost{background:#eef2f7;color:#334155}
  .pill{font-size:12px;border-radius:9999px;padding:.125rem .5rem}
  .card{background:#fff;border:1px solid #eef2f7;border-radius:16px;box-shadow:0 8px 18px rgba(15,23,42,.06)}
  .badge{font-size:12px;background:#f1f5f9;color:#64748b;border-radius:10px;padding:.1rem .45rem}
  .hidden-hard{display:none!important}
  #loading{position:fixed;inset:0;background:rgba(255,255,255,.78);display:flex;align-items:center;justify-content:center;z-index:100}
  #loading.hidden{display:none!important}
  .fab{position:fixed;right:calc(var(--safe-side) + 18px);bottom:calc(env(safe-area-inset-bottom) + 18px);width:64px;height:64px;border-radius:9999px;background:#2563eb;color:#fff;font-size:34px;display:flex;align-items:center;justify-content:center;box-shadow:0 12px 28px rgba(37,99,235,.35);z-index:35}
  .sheet{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:end;z-index:50}
  .sheet.show{display:flex}
  .sheet-card{background:#fff;border-top-left-radius:18px;border-top-right-radius:18px;width:100%}
  .toolbar{padding:8px 0}
  .opt{display:flex;align-items:center;gap:10px;border:1px solid #e6eaf0;border-radius:12px;padding:14px 12px}
  .opt.active{border-color:#2563eb;background:#eef4ff}
  .opt.correct{border-color:#16a34a;background:#ecfdf5}
  .opt.wrong{border-color:#dc2626;background:#fef2f2}
  .kv{display:grid;grid-template-columns:120px 1fr;gap:.5rem .75rem}
  .kv .k{color:#475569}.kv .v{color:#0f172a}
</style>
</head>

<body class="min-h-screen flex flex-col">
  <div class="safe-top"></div>

  <header class="header">
    <div class="container-pad">
      <h1 class="text-3xl font-black leading-tight">ğŸ“’ è‹±æ–‡éŒ¯é¡Œæœ¬ <span class="text-slate-500 font-extrabold">ï¼ˆDrive é›²ç«¯ï¼‰</span></h1>
      <div id="drive-status" class="text-xs text-slate-500 mt-1">é›¢ç·šæ¨¡å¼ï¼ˆå°šæœªç™»å…¥ï¼‰</div>
      <div class="flex flex-wrap gap-3 pb-3 mt-2">
        <button id="btn-auth" class="btn btn-lg btn-primary">Google ç™»å…¥</button>
        <button id="btn-backup" class="btn btn-lg btn-ghost">å‚™ä»½</button>
        <button id="btn-restore" class="btn btn-lg btn-ghost">é‚„åŸ</button>
      </div>
    </div>
  </header>

  <nav class="container-pad toolbar bg-white/70 backdrop-blur border-b border-slate-200 sticky top-[calc(var(--safe-top)+72px)] z-30">
    <div class="flex items-center gap-2 flex-wrap">
      <button id="btn-import-file" class="btn btn-ghost">åŒ¯å…¥ï¼ˆæª”æ¡ˆï¼‰</button>
      <button id="btn-export-file" class="btn btn-ghost">åŒ¯å‡ºï¼ˆæª”æ¡ˆï¼‰</button>
    </div>
    <div class="mt-3 grid grid-cols-3 gap-3">
      <button id="tab-grammar" class="btn btn-ghost">ğŸ“ æ–‡æ³• <span id="count-grammar" class="badge ml-1">0</span></button>
      <button id="tab-collocations" class="btn btn-ghost">ğŸ”— ç‰‡èª <span id="count-coll" class="badge ml-1">0</span></button>
      <button id="tab-vocab" class="btn btn-ghost">ğŸ’¡ å–®å­— <span id="count-vocab" class="badge ml-1">0</span></button>
    </div>
    <div class="mt-3 flex items-center gap-2">
      <div class="flex-1"><input id="search" class="w-full border rounded-xl px-4 py-2" placeholder="æœå°‹..." /></div>
      <button id="btn-quick" class="btn btn-ghost">ğŸ—‚ï¸ å¿«é€Ÿç¿»</button>
      <button id="btn-quiz" class="btn btn-ghost">â“ æ¸¬é©—</button>
    </div>
  </nav>

  <main class="flex-1 container-pad">
    <div id="cards" class="py-4 space-y-4"></div>
    <div id="empty" class="text-center text-slate-500 py-16">ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œé»å³ä¸‹è§’ <b>ï¼‹</b> æ–°å¢ç¬¬ä¸€å¼µå¡ç‰‡å§ï¼</div>
  </main>
  <button id="btn-add" class="fab">ï¼‹</button>

  <!-- æ–°å¢/ç·¨è¼¯è¡¨å–® -->
  <div id="sheet" class="sheet">
    <div class="sheet-card container-pad pt-3 pb-6">
      <div class="flex items-center justify-between pb-2">
        <h2 id="sheet-title" class="text-lg font-bold">æ–°å¢éŒ¯é¡Œ</h2>
        <button id="sheet-close" type="button" class="btn btn-ghost">é—œé–‰</button>
      </div>
      <form id="form" class="grid gap-3">
        <input type="hidden" id="form-id" />
        <select id="form-category" class="w-full border rounded-xl px-3 py-2">
          <option value="Grammar">æ–‡æ³•</option><option value="Collocations">ç‰‡èª</option><option value="Vocabulary">å–®å­—</option>
        </select>
        <textarea id="form-question" rows="3" class="w-full border rounded-xl px-3 py-2" placeholder="é¡Œå¹¹"></textarea>
        <input id="form-wrong" class="w-full border rounded-xl px-3 py-2" placeholder="éŒ¯èª¤ç­”æ¡ˆ" />
        <input id="form-correct" class="w-full border rounded-xl px-3 py-2" placeholder="æ­£ç¢ºç­”æ¡ˆ" />
        <input id="form-correctOpt" class="w-full border rounded-xl px-3 py-2" placeholder="æ­£è§£é¸é … A/B/C/D" />
        <input id="form-subtopic" class="w-full border rounded-xl px-3 py-2" placeholder="å­åˆ†é¡" />
        <textarea id="form-analysis" rows="2" class="w-full border rounded-xl px-3 py-2" placeholder="éŒ¯å› åˆ†æ"></textarea>
        <textarea id="form-mnemonic" rows="2" class="w-full border rounded-xl px-3 py-2" placeholder="è¨˜æ†¶å£è¨£"></textarea>
        <input id="form-tags" class="w-full border rounded-xl px-3 py-2" placeholder="æ¨™ç±¤ (é€—è™Ÿåˆ†éš”)" />
        <div id="extra-fields" class="grid gap-3"></div>
        <div class="flex justify-between pt-1">
          <button type="button" id="btn-delete" class="text-rose-600">åˆªé™¤</button>
          <button class="btn btn-primary">å„²å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- loading -->
  <div id="loading" class="hidden"><div class="text-center"><div class="animate-spin h-12 w-12 border-b-2 border-blue-600 rounded-full mx-auto"></div><div>åŒæ­¥ä¸­â€¦</div></div></div>
<script>
/* ========= ç‹€æ…‹ ========= */
const $=s=>document.querySelector(s);const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const LS_KEY='eng_error_cards_v2';let state={cat:'Grammar',mode:'list',data:[],filtered:[]};
let EXTRA_FIELDS=[];const BASE_KEYS=new Set(['id','category','question','wrongAnswer','correctAnswer','correctOption','subtopic','analysis','mnemonic','tags','createdAt','isReviewed','reviewCount','lastReviewed','heart','wrongCount','åˆ†é¡','Category']);

/* ========= åŒ¯å…¥ï¼ˆCSV / JSONï¼‰ ========= */
(function setupFileImport(){
  const btn=$('#btn-import-file');
  const input=document.createElement('input'); 
  input.type='file'; 
  input.accept='.json,.csv,application/json,text/csv';
  btn.onclick=()=>input.click();

  function parseCSV(text){
    const lines = String(text).replace(/\r\n/g,'\n').replace(/\r/g,'\n')
      .split('\n').filter(l=>l.trim().length>0);
    if(lines.length===0) return {headers:[], rows:[]};
    const parseLine = (line)=>{
      const out=[]; let cur=''; let inQ=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(inQ){
          if(ch==='"' && line[i+1]==='"'){ cur+='"'; i++; }
          else if(ch==='"'){ inQ=false; }
          else cur+=ch;
        }else{
          if(ch===','){ out.push(cur); cur=''; }
          else if(ch==='"'){ inQ=true; }
          else cur+=ch;
        }
      }
      out.push(cur);
      return out;
    };
    const headers = parseLine(lines[0]).map(h=>h.replace(/^\uFEFF/,'').trim());
    const rows = lines.slice(1).map(l=>parseLine(l)).map(arr=>{
      const obj={}; headers.forEach((h,idx)=>{ obj[h]=arr[idx]??''; }); return obj;
    });
    return {headers, rows};
  }

  function deduceExtraFieldsFromHeaders(headers){
    const set = headers.filter(h=>h && !BASE_KEYS.has(h));
    EXTRA_FIELDS = Array.from(new Set(set));
  }

  input.onchange=e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const name=(f.name||'').toLowerCase();
        let imported=[];
        if(name.endsWith('.csv') || name.endsWith('.txt')){
          const {headers, rows} = parseCSV(r.result);
          if(headers.length===0) throw new Error('CSV ç„¡æ¨™é¡Œåˆ—æˆ–æ ¼å¼éŒ¯èª¤');
          deduceExtraFieldsFromHeaders(headers);
          imported = rows.map(row=>{
            const obj={
              id: uid(),
              category: normalizeCategory(row['åˆ†é¡']||row['category']||row['Category']) || state.cat,
              question: row['é¡Œå¹¹']||row['question']||'',
              wrongAnswer: row['éŒ¯èª¤ç­”æ¡ˆ']||row['ä½ çš„ç­”æ¡ˆ']||row['wrongAnswer']||'',
              correctAnswer: row['æ­£ç¢ºç­”æ¡ˆ']||row['æ­£è§£']||row['correctAnswer']||'',
              correctOption: (row['æ­£è§£é¸é …']||row['ç­”æ¡ˆé¸é …']||row['correctOption']||'').toUpperCase(),
              subtopic: row['å­åˆ†é¡']||row['subtopic']||'',
              analysis: row['éŒ¯å› åˆ†æ']||row['analysis']||'',
              mnemonic: row['è¨˜æ†¶å£è¨£']||row['mnemonic']||'',
              tags: (row['æ¨™ç±¤']||row['tags']||'').split(',').map(s=>s.trim()).filter(Boolean),
              createdAt: Date.now(),
              isReviewed:false, reviewCount:0, lastReviewed:0, heart:0, wrongCount:0,
              extra:{}
            };
            EXTRA_FIELDS.forEach(k=>{ obj.extra[k]=row[k]??''; });
            return obj;
          });
        }else{ // JSON
          const arr=JSON.parse(r.result);
          if(!Array.isArray(arr)) throw new Error('JSON æ‡‰ç‚ºé™£åˆ—');
          const headers = Array.from(new Set(arr.flatMap(o=>Object.keys(o||{}))));
          deduceExtraFieldsFromHeaders(headers);
          imported = arr.map(src=>{
            const obj={
              id: src.id||uid(),
              category: normalizeCategory(src.category || src['åˆ†é¡'] || src['Category']) || state.cat,
              question: src.question || src['é¡Œå¹¹'] || '',
              wrongAnswer: src.wrongAnswer || src['éŒ¯èª¤ç­”æ¡ˆ'] || src['ä½ çš„ç­”æ¡ˆ'] || '',
              correctAnswer: src.correctAnswer || src['æ­£ç¢ºç­”æ¡ˆ'] || src['æ­£è§£'] || '',
              correctOption: String(src.correctOption || src['æ­£è§£é¸é …'] || src['ç­”æ¡ˆé¸é …'] || '').toUpperCase(),
              subtopic: src.subtopic || src['å­åˆ†é¡'] || '',
              analysis: src.analysis || src['éŒ¯å› åˆ†æ'] || '',
              mnemonic: src.mnemonic || src['è¨˜æ†¶å£è¨£'] || '',
              tags: Array.isArray(src.tags)? src.tags : String(src['æ¨™ç±¤']||src.tags||'').split(',').map(s=>s.trim()).filter(Boolean),
              createdAt: src.createdAt || Date.now(),
              isReviewed: !!src.isReviewed, reviewCount: src.reviewCount||0, lastReviewed: src.lastReviewed||0,
              heart: src.heart||0, wrongCount: src.wrongCount||0,
              extra:{}
            };
            EXTRA_FIELDS.forEach(k=>{ obj.extra[k]=src[k]??(src.extra?src.extra[k]: ''); });
            return obj;
          });
        }

        // åˆä½µå»é‡
        const key=o=> JSON.stringify([o.category, o.question, o.correctAnswer, ...EXTRA_FIELDS.map(k=> ((o.extra||{})[k] || ''))]);
        const map=new Map(state.data.map(o=>[key(o),o]));
        imported.forEach(o=>map.set(key(o), o));
        state.data=[...map.values()];
        saveLocal(); render(); alert('âœ… åŒ¯å…¥å®Œæˆ');
      }catch(err){
        console.error(err);
        alert('åŒ¯å…¥å¤±æ•—ï¼š'+err.message);
      }finally{
        input.value='';
      }
    };
    r.readAsText(f);
  };
})();

/* ========= åŒ¯å‡ºï¼ˆCSV / JSONï¼‰ ========= */
(function setupFileExport(){
  const btn = document.getElementById('btn-export-file');
  if(!btn) return;

  function unionExtraKeys(data){
    const set = new Set();
    (data||[]).forEach(it=>{
      Object.keys(it.extra||{}).forEach(k=>set.add(k));
    });
    return Array.from(set);
  }

  function toRows(data){
    const extras = unionExtraKeys(data);
    const rows = (data||[]).map(it=>{
      const base = {
        'åˆ†é¡': it.category||'',
        'é¡Œå¹¹': it.question||'',
        'ä½ çš„ç­”æ¡ˆ': it.wrongAnswer||'',
        'æ­£ç¢ºç­”æ¡ˆ': it.correctAnswer||'',
        'æ­£è§£é¸é …': (it.correctOption||'').trim().toUpperCase(),
        'å­åˆ†é¡': it.subtopic||'',
        'éŒ¯å› åˆ†æ': it.analysis||'',
        'è¨˜æ†¶å£è¨£': it.mnemonic||'',
        'æ¨™ç±¤': Array.isArray(it.tags) ? it.tags.join(', ') : (it.tags||''),
      };
      const out = {...base};
      const ex = it.extra||{};
      extras.forEach(k=>{ out[k] = ex[k] ?? ''; });
      return out;
    });
    return {rows, extras};
  }

  function toCSV(rows){
    if(!rows.length) return '';
    const headers = Object.keys(rows[0]);
    const esc = s => ('"'+ String(s).replace(/"/g,'""') +'"');
    const head = headers.map(esc).join(',');
    const body = rows.map(r=> headers.map(h=>esc(r[h]??'')).join(',')).join('\n');
    return head+'\n'+body;
  }

  function download(filename, blob){
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
  }

  btn.onclick = ()=>{
    const data = state.data||[];
    const safe = data.map(o=>({...o, extra: o.extra||{}}));
    const {rows} = toRows(safe);

    // åŒ¯å‡º CSVï¼ˆUTF-8 BOMï¼ŒExcel å‹å–„ï¼‰
    const csv = toCSV(rows);
    const csvBlob = new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8'});
    download('è‹±æ–‡éŒ¯é¡Œæœ¬_åŒ¯å‡º.csv', csvBlob);

    // åŒ¯å‡º JSON
    const jsonBlob = new Blob([JSON.stringify(rows, null, 2)], {type:'application/json;charset=utf-8'});
    download('è‹±æ–‡éŒ¯é¡Œæœ¬_åŒ¯å‡º.json', jsonBlob);
  };
})();

/* ========= æœ¬åœ°è³‡æ–™ ========= */
function loadLocal(){ try{ state.data=JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ state.data=[]; } }
function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(state.data||[])); }

/* ========= åˆ†é¡å°æ‡‰ ========= */
function normalizeCategory(raw){
  const s=String(raw||'').trim().toLowerCase();
  if(['æ–‡æ³•','grammar','g'].includes(s)) return 'Grammar';
  if(['ç‰‡èª','collocations','phrase','phrases','c'].includes(s)) return 'Collocations';
  if(['å–®å­—','vocab','vocabulary','word','words','v'].includes(s)) return 'Vocabulary';
  return null;
}
/* ========= UI æ¸²æŸ“ ========= */
function computeFiltered(){
  const q=$('#search').value.trim().toLowerCase();
  state.filtered = (state.data||[])
    .filter(d=> (d.category||'Grammar')===state.cat)
    .filter(d=>{
      if(!q) return true;
      const extra = d.extra||{};
      const extraBlob = Object.entries(extra).map(([k,v])=>`${k} ${v}`).join(' ');
      const blob=[
        d.question,d.wrongAnswer,d.correctAnswer,d.analysis,d.mnemonic,
        (d.tags||[]).join(','),(d.subtopic||''), extraBlob
      ].join(' ').toLowerCase();
      return blob.includes(q);
    })
    .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
}

function setMode(m){
  state.mode=m;
  document.getElementById('btn-quick').classList.toggle('btn-primary', m==='list');
  document.getElementById('btn-quiz').classList.toggle('btn-primary', m==='quiz');
  render();
}

function renderTabs(){
  document.getElementById('count-grammar').textContent =
    (state.data||[]).filter(d=> (d.category||'Grammar')==='Grammar').length;
  document.getElementById('count-coll').textContent =
    (state.data||[]).filter(d=> (d.category||'Grammar')==='Collocations').length;
  document.getElementById('count-vocab').textContent =
    (state.data||[]).filter(d=> (d.category||'Grammar')==='Vocabulary').length;
}

function showStat(kind){
  const box = (state.data||[]).filter(d=> (d.category||'Grammar')==={
    grammar:'Grammar',coll:'Collocations',vocab:'Vocabulary'}[kind]);
  const pairs = Object.entries(box.reduce((m,it)=>{
    const k=(it.subtopic||'æœªæ¨™è¨»').trim()||'æœªæ¨™è¨»';
    m[k]=(m[k]||0)+(it.wrongCount||0); return m;
  },{})).sort((a,b)=>b[1]-a[1]);
  alert(`å¸¸éŒ¯çµ±è¨ˆï¼ˆ${{grammar:'æ–‡æ³•',coll:'ç‰‡èª',vocab:'å–®å­—'}[kind]}ï¼‰\n\n`+(pairs.length? pairs.map(([k,v])=>`${k}ï¼š${v}`).join('\n'):'ç›®å‰æ²’æœ‰çµ±è¨ˆè³‡æ–™'));
}

function escapeHTML(s){return (s==null?'':String(s)).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]))}

/* ========= CRUD & å¡ç‰‡æ¸²æŸ“ ========= */
function cardEl(it){
  const wrap=document.createElement('div');
  wrap.className='card p-4';
  const topL={'Grammar':'ğŸ“ æ–‡æ³•','Collocations':'ğŸ”— ç‰‡èª','Vocabulary':'ğŸ’¡ å–®å­—'}[it.category]||'ğŸ“„';

  wrap.innerHTML=`
    <div class="flex items-center justify-between mb-1">
      <div class="text-sm text-blue-600 font-semibold">${topL}</div>
      <div class="text-xs text-slate-400">${new Date(it.createdAt||Date.now()).toLocaleDateString()}</div>
    </div>
    <h3 class="font-extrabold text-slate-900 mb-2">${escapeHTML(it.question||'')}</h3>
    <div class="grid grid-cols-2 gap-2 text-sm mb-2">
      <div class="p-2 bg-red-50 border border-red-200 rounded-lg">âŒ ${escapeHTML(it.wrongAnswer||'')}</div>
      <div class="p-2 bg-green-50 border border-green-200 rounded-lg">âœ… ${escapeHTML(it.correctAnswer||'')}</div>
    </div>
    <div class="text-xs text-slate-500">æ­£è§£é¸é …ï¼š${it.correctOption||'æœªè¨­å®š'}</div>
    <div class="flex justify-end gap-2 mt-3">
      <button class="btn btn-ghost text-sm js-edit">ç·¨è¼¯</button>
      <button class="btn btn-ghost text-sm text-rose-600 js-del">åˆªé™¤</button>
    </div>`;
  wrap.querySelector('.js-edit').onclick=()=>openSheet(it);
  wrap.querySelector('.js-del').onclick=()=>delItem(it.id);
  return wrap;
}
function render(){
  renderTabs(); computeFiltered();
  const host=document.getElementById('cards'); host.innerHTML='';
  if(state.filtered.length===0){ document.getElementById('empty').classList.remove('hidden-hard'); }
  else { document.getElementById('empty').classList.add('hidden-hard'); state.filtered.forEach(it=>host.appendChild(cardEl(it))); }
}
function openSheet(it=null){
  document.getElementById('sheet').classList.add('show');
  document.getElementById('sheet-title').textContent=it?'ç·¨è¼¯éŒ¯é¡Œ':'æ–°å¢éŒ¯é¡Œ';
  document.getElementById('btn-delete').classList.toggle('hidden-hard',!it);
  document.getElementById('form-id').value=it?.id||'';
  document.getElementById('form-question').value=it?.question||'';
  document.getElementById('form-wrong').value=it?.wrongAnswer||'';
  document.getElementById('form-correct').value=it?.correctAnswer||'';
  document.getElementById('form-correctOpt').value=it?.correctOption||'';
}
function closeSheet(){ document.getElementById('sheet').classList.remove('show'); }
function upsertLocal(obj){ const i=(state.data||[]).findIndex(d=>d.id===obj.id); if(i>=0) state.data[i]=obj; else state.data.unshift(obj); saveLocal(); render(); }
function delItem(id){ if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')){ const i=(state.data||[]).findIndex(d=>d.id===id); if(i>=0){ state.data.splice(i,1); saveLocal(); render(); } } }

/* ========= è¡¨å–®é€å‡º ========= */
document.getElementById('form').onsubmit=(e)=>{
  e.preventDefault();
  const id=document.getElementById('form-id').value||uid();
  const existed=(state.data||[]).find(d=>d.id===id);
  const obj={
    id,
    category: state.cat,
    question: document.getElementById('form-question').value.trim(),
    wrongAnswer: document.getElementById('form-wrong').value.trim(),
    correctAnswer: document.getElementById('form-correct').value.trim(),
    correctOption: (document.getElementById('form-correctOpt').value||'').trim().toUpperCase(),
    createdAt: existed? existed.createdAt:Date.now(),
    isReviewed: existed?!!existed.isReviewed:false,
    reviewCount: existed?(existed.reviewCount||0):0,
    lastReviewed: existed?(existed.lastReviewed||0):0,
    heart: existed?(existed.heart||0):0,
    wrongCount: existed?(existed.wrongCount||0):0,
    extra: existed?existed.extra||{}:{}
  };
  upsertLocal(obj); closeSheet();
};

/* ========= äº‹ä»¶æ›è¼‰ ========= */
document.getElementById('tab-grammar').onclick=()=>{ state.cat='Grammar'; render(); };
document.getElementById('tab-collocations').onclick=()=>{ state.cat='Collocations'; render(); };
document.getElementById('tab-vocab').onclick=()=>{ state.cat='Vocabulary'; render(); };
document.getElementById('btn-quick').onclick=()=>setMode('list');
document.getElementById('btn-quiz').onclick=()=>setMode('quiz');
document.getElementById('search').oninput=()=>render();
document.getElementById('btn-add').onclick=()=>openSheet();
document.getElementById('sheet').addEventListener('click',e=>{ if(e.target.id==='sheet') closeSheet(); });
document.getElementById('btn-delete').onclick=()=>{ const id=document.getElementById('form-id').value; if(id){ closeSheet(); delItem(id); } };

/* ========= Google Drive & å•Ÿå‹• ========= */
const GOOGLE_CLIENT_ID='1067450972173-l1o4o3fl73f57mcm4rltj520h2ocio12.apps.googleusercontent.com';
const SCOPES='https://www.googleapis.com/auth/drive.appdata';
let tokenClient=null,accessToken=null,driveFileId=null;

function updateDriveStatus(isLogin){ document.getElementById('drive-status').innerHTML=isLogin?'âœ… å·²ç™»å…¥ Google':'é›¢ç·šæ¨¡å¼ï¼ˆå°šæœªç™»å…¥ï¼‰'; }
function gapiLoaded(){ gapi.load('client', async()=>{ await gapi.client.init({ discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] }); }); }
function gisLoaded(){ tokenClient=google.accounts.oauth2.initTokenClient({ client_id:GOOGLE_CLIENT_ID, scope:SCOPES, callback:(r)=>{ if(r&&r.access_token){ accessToken=r.access_token; gapi.client.setToken({access_token}); updateDriveStatus(true);}else updateDriveStatus(false); } }); }
function authorize(){ tokenClient?.requestAccessToken({prompt:'consent'}); }
function signOut(){ if(accessToken){ google.accounts.oauth2.revoke(accessToken,()=>{}); accessToken=null; updateDriveStatus(false);} }

document.getElementById('btn-auth').onclick=authorize;
document.getElementById('btn-backup').onclick=()=>alert('å‚™ä»½åŠŸèƒ½ç¤ºç¯„');
document.getElementById('btn-restore').onclick=()=>alert('é‚„åŸåŠŸèƒ½ç¤ºç¯„');

window.addEventListener('error',e=>{ console.error(e.error||e.message); document.getElementById('loading').classList.add('hidden'); });
loadLocal(); render(); updateDriveStatus(false);
</script>
</body>
</html>
