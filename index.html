<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>📒 英文錯題本（Drive 雲端）</title>

  <!-- PWA（可留可刪） -->
  <meta name="theme-color" content="#2563eb" />
  <link rel="manifest" href="manifest.json" />

  <!-- iOS 安全區 + 圖示（可留可刪） -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <!-- 字體 / Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google APIs -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <style>
    :root { --primary:#2563eb; }
    html, body { height:100%; }
    body { font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans TC', 'PingFang TC', 'Microsoft JhengHei', sans-serif; background:#f6f7fb; }
    .card { background:#fff; border:1px solid #eef0f4; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .btn { user-select:none; -webkit-tap-highlight-color:transparent; border-radius:16px; font-weight:800; padding:.9rem 1.1rem; }
    .btn:active { transform:scale(.98); }
    .btn-primary { background:var(--primary); color:#fff; }
    .btn-ghost { background:#eef2f7; color:#1f2937; }
    .btn-danger { background:#ef4444; color:#fff; }
    .chip { padding:.25rem .6rem; border-radius:9999px; font-size:.8rem; font-weight:700; }
    .safe-bottom { padding-bottom: max(env(safe-area-inset-bottom), 18px); }
    .disabled { opacity:.45; pointer-events:none; }
    .tapfix { min-height:48px; } /* 提高可點擊高度 */

    /* 表單抽屜（sheet） */
    #sheet { position:fixed; inset:0; display:none; align-items:flex-end; background:rgba(0,0,0,.35); z-index:60; }
    #sheet .panel { width:100%; max-width:680px; margin:0 auto; border-radius:20px 20px 0 0; }
    /* 關閉鍵：放在右上但加大熱區，同時在底部也提供一個明顯關閉鍵 */
    .close-hit { position:absolute; right:12px; top:12px; width:44px; height:44px; display:flex; align-items:center; justify-content:center; border-radius:12px; background:#f1f5f9; }
    #sheet-close-bottom { width:100%; padding:14px 0; }

    /* Loading 遮罩 */
    #loading { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(255,255,255,.75); backdrop-filter:saturate(160%) blur(2px); z-index:80; }
    .spin { width:48px; height:48px; border-radius:9999px; border:4px solid #cfe0ff; border-top-color:var(--primary); animation:sp 1s linear infinite; }
    @keyframes sp { to { transform:rotate(360deg); } }

    /* 測驗選項樣式 */
    .opt { display:flex; align-items:center; gap:.9rem; padding:14px 16px; border-radius:14px; border:1px solid #ebeff5; background:#f9fafb; font-weight:800; }
    .opt .badge { width:32px; height:32px; border-radius:9999px; display:flex; align-items:center; justify-content:center; background:#e5edff; color:#1e3a8a; }
    .opt.correct { background:#ecfdf5; border-color:#34d399; }
    .opt.wrong   { background:#fef2f2; border-color:#f87171; }
    .opt.chosen  { outline:2px solid var(--primary); }

    /* 讓頂部大卡在 iPhone 15PM 也易按 */
    .headbtn { width:152px; max-width:42vw; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- 頂部：標題 + Google/備份/還原 -->
  <header class="bg-white/90 backdrop-blur sticky top-0 z-50 border-b border-slate-200">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-start justify-between gap-3">
      <div class="leading-tight">
        <div class="text-xs text-slate-400">ENG Error Notebook</div>
        <h1 class="text-[22px] font-extrabold text-slate-900">📒 英文錯題本 <span class="text-slate-400">(Drive 雲端)</span></h1>
        <div id="status" class="text-xs mt-1 text-slate-500">離線模式（尚未登入）</div>
      </div>
      <div class="flex items-stretch gap-2">
        <button id="btn-auth"   class="btn btn-primary headbtn tapfix">Google 登入</button>
        <button id="btn-backup" class="btn btn-ghost headbtn tapfix disabled">備份</button>
        <button id="btn-restore" class="btn btn-ghost headbtn tapfix disabled">還原</button>
      </div>
    </div>
  </header>

  <!-- 次列：匯入(檔案) -->
  <nav class="bg-white">
    <div class="max-w-3xl mx-auto px-4 py-2 flex items-center gap-2">
      <label class="btn btn-ghost tapfix">
        匯入（檔案）
        <input id="file-import" type="file" accept="application/json" class="hidden" />
      </label>
      <div class="text-xs text-slate-400">或在上方以 Drive 進行備份 / 還原</div>
    </div>
  </nav>

  <!-- 分類 Tabs -->
  <nav class="bg-white border-y border-slate-200 sticky top-[76px] z-40">
    <div class="max-w-3xl mx-auto px-4 py-2 grid grid-cols-3 gap-2">
      <button class="tab btn btn-ghost" data-cat="Grammar">📝 文法 <span class="count text-slate-400"></span></button>
      <button class="tab btn btn-ghost" data-cat="Collocations">🔗 片語 <span class="count text-slate-400"></span></button>
      <button class="tab btn btn-ghost" data-cat="Vocabulary">💡 單字 <span class="count text-slate-400"></span></button>
    </div>
    <div class="max-w-3xl mx-auto px-4 pb-2 flex items-center gap-2">
      <div class="flex-1 relative">
        <input id="search" class="w-full border border-slate-300 rounded-xl px-3 py-2 pl-8 outline-none focus:ring-2 focus:ring-blue-500" placeholder="搜尋題幹/標籤（ex: 介系詞 / schedule）" />
        <span class="absolute left-2 top-2.5 text-slate-400">🔎</span>
      </div>
      <button id="btn-quick" class="btn btn-ghost tapfix">🗂️ 快速翻</button>
      <button id="btn-quiz" class="btn btn-ghost tapfix">❓ 測驗</button>
    </div>
  </nav>

  <!-- 常錯統計 -->
  <section class="bg-white">
    <div class="max-w-3xl mx-auto px-4 py-2 flex items-center gap-3">
      <div class="text-[13px]">📈 常錯統計：</div>
      <button id="stat-grammar" class="chip bg-blue-50 text-blue-700">文法 <span class="font-extrabold ml-1" id="statG">0</span></button>
      <button id="stat-col" class="chip bg-emerald-50 text-emerald-700">片語 <span class="font-extrabold ml-1" id="statC">0</span></button>
      <button id="stat-voc" class="chip bg-violet-50 text-violet-700">單字 <span class="font-extrabold ml-1" id="statV">0</span></button>
    </div>
  </section>

  <!-- 主內容：卡片 -->
  <main class="flex-1">
    <div id="cards" class="max-w-3xl mx-auto px-4 py-4 space-y-4"></div>
    <div id="empty" class="hidden max-w-3xl mx-auto px-4 py-20 text-center text-slate-500">目前沒有資料，點右下角 <b>＋</b> 新增第一張卡片吧！</div>
  </main>

  <!-- 右下角新增 -->
  <button id="btn-add" class="fixed right-4 bottom-5 z-40 btn btn-primary rounded-full w-16 h-16 text-3xl leading-none safe-bottom">＋</button>

  <!-- 表單 Sheet -->
  <div id="sheet">
    <div class="panel card p-4 pb-2 safe-bottom relative">
      <button class="close-hit" id="sheet-x">✕</button>
      <h2 id="sheet-title" class="text-lg font-extrabold mb-2">新增錯題</h2>
      <form id="form" class="space-y-3">
        <input type="hidden" id="form-id" />
        <div>
          <label class="text-sm">分類</label>
          <select id="form-category" class="w-full border rounded-xl px-3 py-2">
            <option value="Grammar">文法 (Grammar)</option>
            <option value="Collocations">片語 (Collocations)</option>
            <option value="Vocabulary">單字 (Vocabulary)</option>
          </select>
        </div>
        <div>
          <label class="text-sm">題幹（簡短題目）</label>
          <textarea id="form-question" rows="3" class="w-full border rounded-xl px-3 py-2" placeholder="e.g. Visitors will see the monument ___ the building."></textarea>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-sm">❌ 錯誤答案</label>
            <input id="form-wrong" class="w-full border rounded-xl px-3 py-2" />
          </div>
          <div>
            <label class="text-sm">✅ 正解（A/B/C/D）</label>
            <input id="form-correct" class="w-full border rounded-xl px-3 py-2" placeholder="A 或 B 或 C 或 D" />
          </div>
        </div>
        <div>
          <label class="text-sm">🔎 錯因分析</label>
          <textarea id="form-analysis" rows="2" class="w-full border rounded-xl px-3 py-2" placeholder="為何會錯？"></textarea>
        </div>
        <div>
          <label class="text-sm">🎯 記憶口訣/小技巧</label>
          <textarea id="form-mnemonic" rows="2" class="w-full border rounded-xl px-3 py-2" placeholder="小技巧/口訣"></textarea>
        </div>
        <div>
          <label class="text-sm">標籤（逗號分隔）</label>
          <input id="form-tags" class="w-full border rounded-xl px-3 py-2" placeholder="介系詞, 形容詞, Part5" />
        </div>
        <div class="flex items-center justify-between pt-1">
          <button type="button" id="btn-delete" class="text-red-600 hidden">刪除</button>
          <button class="btn btn-primary">儲存</button>
        </div>
      </form>
      <button id="sheet-close-bottom" class="btn btn-ghost mt-3">關閉</button>
    </div>
  </div>

  <!-- 常錯統計彈窗 -->
  <div id="stat-modal" class="fixed inset-0 hidden items-end z-[55] bg-black/40">
    <div class="w-full max-w-3xl mx-auto card rounded-t-2xl p-4 safe-bottom">
      <div class="flex items-center justify-between">
        <h3 class="font-extrabold">常錯子類統計</h3>
        <button id="stat-close" class="close-hit">✕</button>
      </div>
      <div id="stat-list" class="mt-2 grid grid-cols-2 gap-2"></div>
      <button id="stat-close-bottom" class="btn btn-ghost mt-3 w-full">關閉</button>
    </div>
  </div>

  <!-- Toast / Loading -->
  <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-28 z-[70] hidden">
    <div class="bg-slate-900 text-white text-sm px-3 py-2 rounded-full shadow-lg">完成</div>
  </div>
  <div id="loading" class="fixed inset-0 hidden z-[75]">
    <div class="w-full h-full flex items-center justify-center">
      <div class="flex flex-col items-center gap-3">
        <div class="spin"></div>
        <div class="text-slate-700">同步中…</div>
      </div>
    </div>
  </div>

  <script>
    /* ========= 基本狀態 ========= */
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    const LS_KEY = 'eng_error_cards_v3';
    const DRIVE_FILE_NAME = 'english_mistakes_v3.json';
    const GOOGLE_CLIENT_ID = '1067450972173-l1o4o3fl73f57mcm4rltj520h2ocio12.apps.googleusercontent.com'; // ←← 這裡改成你的 Client ID

    const state = {
      cat: 'Grammar',
      mode: 'list',   // list | quiz
      data: [],
      filtered: [],
      token: null,
      email: null,
      driveFileId: null,
      statScope: 'Grammar'
    };

    /* ========= 本地資料 ========= */
    const loadLocal = () => { try { state.data = JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch { state.data = []; } };
    const saveLocal = () => localStorage.setItem(LS_KEY, JSON.stringify(state.data));

    function toast(msg='完成'){
      const t = $('#toast'); t.firstElementChild.textContent = msg;
      t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 1600);
    }
    function loading(on=true){
      $('#loading').classList.toggle('hidden', !on);
      if(on){ setTimeout(()=>$('#loading').classList.add('hidden'), 15000); } // 最長 15 秒
    }

    /* ========= UI：Tabs / 篩選 / Render ========= */
    function renderTabs(){
      $$('.tab').forEach(btn=>{
        const cat = btn.dataset.cat;
        const cnt = state.data.filter(d=>d.category===cat).length;
        btn.querySelector('.count').textContent = cnt ? `(${cnt})` : '';
        const on = (state.cat===cat);
        btn.classList.toggle('btn-primary', on);
        btn.classList.toggle('btn-ghost', !on);
        btn.classList.toggle('text-white', on);
      });
      // 常錯彙總
      $('#statG').textContent = state.data.filter(d=>d.category==='Grammar' && d.wrongCount>0).length;
      $('#statC').textContent = state.data.filter(d=>d.category==='Collocations' && d.wrongCount>0).length;
      $('#statV').textContent = state.data.filter(d=>d.category==='Vocabulary' && d.wrongCount>0).length;
    }
    function computeFiltered(){
      const q = $('#search').value.trim().toLowerCase();
      state.filtered = state.data
        .filter(d=>d.category===state.cat)
        .filter(d=>{
          if(!q) return true;
          const blob = [d.question,d.wrongAnswer,d.correctAnswer,d.analysis,d.mnemonic,(d.tags||[]).join(',')].join(' ').toLowerCase();
          return blob.includes(q);
        })
        .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    }
    const esc = s => String(s||'').replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

    function cardEl(it){
      const el = document.createElement('div');
      el.className = 'card p-4';
      const tags = (it.tags||[]).map(t=>`<span class="chip bg-slate-100 text-slate-600">#${esc(t)}</span>`).join(' ');
      const hearts = it.heartCount||0, wrongs = it.wrongCount||0;

      // 測驗模式：只顯示 A/B/C/D，不附加任何額外文字
      const quizBlock = `
        <div class="${state.mode==='quiz'?'':'hidden'} space-y-2 mt-3">
          ${['A','B','C','D'].map(k=>`
            <button class="opt js-opt" data-k="${k}">
              <div class="badge">${k}</div>
              <div class="font-bold">${k}</div>
            </button>`).join('')}
        </div>
      `;

      const reviewBlock = `
        <div class="${state.mode==='list'?'':'hidden'}">
          <div class="grid grid-cols-2 gap-2 text-sm mt-2">
            <div class="p-2 bg-red-50 border border-red-200 rounded-lg"><b class="text-red-600">❌</b> ${esc(it.wrongAnswer||'')}</div>
            <div class="p-2 bg-emerald-50 border border-emerald-200 rounded-lg"><b class="text-emerald-600">✅</b> ${esc(it.correctAnswer||'')}</div>
          </div>
          <div class="mt-2 p-3 bg-amber-50 border-l-4 border-amber-500 rounded-r-lg text-sm">
            <div class="font-bold text-amber-800 mb-1">🔎 錯因分析</div>
            <div class="text-slate-800">${esc(it.analysis||'—')}</div>
          </div>
          <div class="mt-2 p-3 bg-indigo-50 border-l-4 border-indigo-500 rounded-r-lg text-sm">
            <div class="font-bold text-indigo-800 mb-1">🎯 記憶口訣/小技巧</div>
            <div class="text-slate-800">${esc(it.mnemonic||'—')}</div>
          </div>
        </div>`;

      el.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm text-blue-600 font-bold">${({'Grammar':'📝 文法','Collocations':'🔗 片語','Vocabulary':'💡 單字'}[it.category])}</div>
          <div class="text-xs text-slate-400">${new Date(it.createdAt||Date.now()).toLocaleDateString()}</div>
        </div>
        <h3 class="font-extrabold text-slate-900 text-[18px] leading-snug">${esc(it.question||'')}</h3>
        <div class="flex flex-wrap gap-1 mt-1">${tags}</div>

        ${quizBlock}
        ${reviewBlock}

        <div class="flex items-center justify-between mt-3">
          <div class="text-xs flex items-center gap-2">
            <span class="chip bg-rose-50 text-rose-700">錯 <b>${wrongs}</b></span>
            <span class="chip bg-pink-50 text-pink-700">❤️ <b>${hearts}</b></span>
          </div>
          <div class="flex gap-2">
            <button class="btn btn-ghost tapfix js-edit">編輯</button>
            <button class="btn btn-ghost tapfix js-del text-rose-600">刪除</button>
            <button class="btn btn-ghost tapfix js-reviewed ${it.isReviewed?'bg-emerald-100 text-emerald-800':''}">${it.isReviewed?'已複習':'標記已複習'}</button>
          </div>
        </div>
      `;

      // 事件
      el.querySelector('.js-edit').onclick = ()=>openSheet(it);
      el.querySelector('.js-del').onclick = ()=>delItem(it.id);
      el.querySelector('.js-reviewed').onclick = ()=>toggleReviewed(it.id);

      if(state.mode==='quiz'){
        el.querySelectorAll('.js-opt').forEach(btn=>{
          btn.onclick = ()=>{
            const k = btn.dataset.k;
            // 已選顯示
            el.querySelectorAll('.js-opt').forEach(o=>o.classList.remove('chosen'));
            btn.classList.add('chosen');
            // 判斷
            if((it.correctAnswer||'').toUpperCase()===k.toUpperCase()){
              btn.classList.add('correct');
              it.heartCount = (it.heartCount||0)+1;
            }else{
              btn.classList.add('wrong');
              it.wrongCount = (it.wrongCount||0)+1;
            }
            saveLocal(); render(); // 立即更新計數
          };
        });
      }
      return el;
    }

    function render(){
      renderTabs(); computeFiltered();
      const host = $('#cards'); host.innerHTML='';
      if(state.filtered.length===0){ $('#empty').classList.remove('hidden'); }
      else { $('#empty').classList.add('hidden'); state.filtered.forEach(it=>host.appendChild(cardEl(it))); }
    }

    /* ========= 表單 CRUD ========= */
    function openSheet(it=null){
      $('#sheet').style.display='flex';
      $('#sheet-title').textContent = it?'編輯錯題':'新增錯題';
      $('#btn-delete').classList.toggle('hidden', !it);
      $('#form-id').value = it?.id || '';
      $('#form-category').value = it?.category || state.cat;
      $('#form-question').value = it?.question || '';
      $('#form-wrong').value = it?.wrongAnswer || '';
      $('#form-correct').value = it?.correctAnswer || '';
      $('#form-analysis').value = it?.analysis || '';
      $('#form-mnemonic').value = it?.mnemonic || '';
      $('#form-tags').value = (it?.tags||[]).join(', ');
    }
    function closeSheet(){ $('#sheet').style.display='none'; }

    function upsert(obj){
      const idx = state.data.findIndex(d=>d.id===obj.id);
      if(idx>=0) state.data[idx]=obj; else state.data.unshift(obj);
      saveLocal(); render(); toast('已儲存');
    }
    function delItem(id){
      if(!confirm('確定刪除這張卡片？')) return;
      const idx = state.data.findIndex(d=>d.id===id);
      if(idx>=0){ state.data.splice(idx,1); saveLocal(); render(); }
    }
    function toggleReviewed(id){
      const it = state.data.find(d=>d.id===id); if(!it) return;
      it.isReviewed = !it.isReviewed; if(it.isReviewed){ it.reviewCount=(it.reviewCount||0)+1; it.lastReviewed=Date.now(); }
      saveLocal(); render();
    }

    // 匯入 JSON（合併重覆題目：以 question+correctAnswer 為 key）
    function importJSON(arr){
      if(!Array.isArray(arr)) return toast('匯入格式錯誤');
      const key = o => (o.question||'') + '|' + (o.correctAnswer||'');
      const map = new Map(state.data.map(o=>[key(o), o]));
      arr.forEach(o=>{
        o.id = o.id || uid();
        o.tags = Array.isArray(o.tags) ? o.tags : String(o.tags||'').split(',').map(s=>s.trim()).filter(Boolean);
        o.wrongCount = o.wrongCount||0; o.heartCount = o.heartCount||0;
        map.set(key(o), {...(map.get(key(o))||{}), ...o});
      });
      state.data = Array.from(map.values()).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      saveLocal(); render(); toast('已匯入');
    }

    /* ========= 常錯統計（子標籤） ========= */
    function openStatModal(scopeCat='Grammar'){
      state.statScope = scopeCat;
      const list = $('#stat-list'); list.innerHTML='';
      // 以 tags 統計
      const counts = {};
      state.data.filter(d=>d.category===scopeCat).forEach(d=>{
        (d.tags||[]).forEach(t=>{ counts[t]=(counts[t]||0)+(d.wrongCount||0); });
      });
      const items = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
      if(items.length===0){ list.innerHTML = `<div class="text-slate-500">尚無統計資料</div>`; }
      else {
        items.forEach(([t,c])=>{
          const div=document.createElement('div');
          div.className='card p-3 flex items-center justify-between';
          div.innerHTML=`<div class="font-bold">#${esc(t)}</div><div class="chip bg-rose-50 text-rose-700">錯 <b>${c}</b></div>`;
          list.appendChild(div);
        });
      }
      $('#stat-modal').style.display='flex';
    }
    function closeStatModal(){ $('#stat-modal').style.display='none'; }

    /* ========= Google 登入 + Drive ========= */
    let tokenClient, gapiInited=false, gisInited=false;

    function gapiLoaded(){
      gapi.load('client', async ()=>{
        await gapi.client.init({
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
        });
        gapiInited = true; maybeEnableAuth();
      });
    }
    window.gapiLoaded = gapiLoaded;

    function gisLoaded(){
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.file email',
        callback: (resp)=>{
          if(resp.error){ toast('授權失敗'); return; }
          state.token = resp.access_token;
          gapi.client.setToken({access_token: state.token});
          // 嘗試取得使用者 email（用 userinfo endpoint）
          fetch('https://www.googleapis.com/oauth2/v2/userinfo', { headers:{Authorization:'Bearer '+state.token}})
            .then(r=>r.json()).then(u=>{
              state.email = u.email || '已登入';
              updateAuthUI(true);
              // 找檔案
              findDriveFile().finally(()=>{});
            }).catch(()=>{ updateAuthUI(true); });
        }
      });
      gisInited = true; maybeEnableAuth();
    }
    window.gisLoaded = gisLoaded;

    // 手動載入（避免某些瀏覽器延遲 onload）
    window.addEventListener('load', ()=>{
      if(typeof gapi!=='undefined'){ gapiLoaded(); }
      if(typeof google!=='undefined'){ gisLoaded(); }
    });

    function maybeEnableAuth(){
      if(gapiInited && gisInited){
        $('#btn-auth').classList.remove('disabled');
      }
    }

    function updateAuthUI(isLoggedIn){
      if(isLoggedIn){
        $('#status').textContent = `✅ 已登入 Google：${state.email||''}`;
        $('#btn-auth').textContent = '登出';
        $('#btn-auth').onclick = signOut;
        $('#btn-backup').classList.remove('disabled');
        $('#btn-restore').classList.remove('disabled');
      }else{
        $('#status').textContent = '離線模式（尚未登入）';
        $('#btn-auth').textContent = 'Google 登入';
        $('#btn-auth').onclick = authorize;
        $('#btn-backup').classList.add('disabled');
        $('#btn-restore').classList.add('disabled');
      }
    }

    function authorize(){
      if(!tokenClient){ toast('雲端服務未就緒'); return; }
      tokenClient.requestAccessToken({prompt:'consent'});
    }
    function signOut(){
      try{
        google.accounts.oauth2.revoke(state.token, ()=>{});
      }catch{}
      state.token=null; state.email=null; state.driveFileId=null;
      gapi.client.setToken('');
      updateAuthUI(false);
      toast('已登出');
    }

    async function findDriveFile(){
      try{
        const r = await gapi.client.drive.files.list({
          spaces:'appDataFolder',
          q:`name='${DRIVE_FILE_NAME}'`,
          fields:'files(id, modifiedTime)',
          pageSize:1
        });
        const files = r.result.files||[];
        state.driveFileId = files.length? files[0].id : null;
      }catch(e){ console.warn('list error', e); }
    }

    async function backupToDrive(){
      if(!state.token){ return toast('請先登入 Google'); }
      loading(true);
      try{
        const data = JSON.stringify(state.data, null, 2);
        const boundary = '-------314159265358979323846'; // 任意
        const delimiter = `\r\n--${boundary}\r\n`;
        const closeDelim = `\r\n--${boundary}--`;
        const meta = { name: DRIVE_FILE_NAME, parents:['appDataFolder'], mimeType:'application/json' };

        const multipartBody =
          delimiter + 'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
          JSON.stringify(meta) +
          delimiter + 'Content-Type: application/json\r\n\r\n' +
          data + closeDelim;

        let url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
        let method = 'POST';
        if(state.driveFileId){
          url = `https://www.googleapis.com/upload/drive/v3/files/${state.driveFileId}?uploadType=multipart`;
          method = 'PATCH';
        }
        const resp = await fetch(url, {
          method,
          headers: {
            'Authorization':'Bearer '+state.token,
            'Content-Type':'multipart/related; boundary='+boundary
          },
          body: multipartBody
        });
        if(!resp.ok){
          const txt = await resp.text();
          throw new Error('上傳失敗：'+txt);
        }
        const j = await resp.json();
        state.driveFileId = j.id || state.driveFileId;
        toast('✅ 備份成功');
      }catch(e){
        console.error(e);
        if(String(e).includes('AccessNotConfigured') || String(e).includes('drive.googleapis.com')){
          toast('備份失敗：請到 GCP 啟用 Google Drive API');
        }else{
          toast('備份失敗，請稍後再試');
        }
      }finally{ loading(false); }
    }

    async function restoreFromDrive(){
      if(!state.token){ return toast('請先登入 Google'); }
      await findDriveFile();
      if(!state.driveFileId){ return toast('雲端未找到備份，請先備份'); }
      loading(true);
      try{
        const r = await gapi.client.drive.files.get({ fileId: state.driveFileId, alt:'media' });
        if(r.result){ importJSON(r.result); toast('✅ 還原成功'); }
        else throw new Error('無法取得檔案內容');
      }catch(e){
        console.error(e); toast('還原失敗，請稍後再試');
      }finally{ loading(false); }
    }

    /* ========= 事件 ========= */
    $$('.tab').forEach(b=>b.onclick=()=>{ state.cat=b.dataset.cat; render(); });
    $('#btn-quick').onclick = ()=>{ state.mode='list'; render(); };
    $('#btn-quiz').onclick  = ()=>{ state.mode='quiz'; render(); };

    $('#btn-add').onclick = ()=>openSheet();
    $('#sheet-x').onclick = closeSheet;
    $('#sheet-close-bottom').onclick = closeSheet;

    $('#form').onsubmit = (e)=>{
      e.preventDefault();
      const id = $('#form-id').value || uid();
      const existed = state.data.find(d=>d.id===id);
      const obj = {
        id,
        category: $('#form-category').value,
        question: $('#form-question').value.trim(),
        wrongAnswer: $('#form-wrong').value.trim(),
        correctAnswer: ($('#form-correct').value||'').trim().toUpperCase(), // 僅 A/B/C/D
        analysis: $('#form-analysis').value.trim(),
        mnemonic: $('#form-mnemonic').value.trim(),
        tags: $('#form-tags').value.split(',').map(s=>s.trim()).filter(Boolean),
        createdAt: existed? existed.createdAt : Date.now(),
        isReviewed: existed? existed.isReviewed : false,
        reviewCount: existed? existed.reviewCount||0 : 0,
        heartCount: existed? existed.heartCount||0 : 0,
        wrongCount: existed? existed.wrongCount||0 : 0
      };
      upsert(obj); closeSheet();
    };
    $('#btn-delete').onclick = ()=>{
      const id=$('#form-id').value; if(!id) return; closeSheet(); delItem(id);
    };

    // 匯出（本機下載）
    //（保留快捷：在任何時候輸出）
    document.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='e'){
        const blob = new Blob([JSON.stringify(state.data,null,2)],{type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement('a'),{href:url,download:'english-mistakes.json'});
        document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),500);
      }
    });

    // 匯入（檔案）
    $('#file-import').onchange = (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader(); r.onload = ()=>{
        try { importJSON(JSON.parse(r.result)); } catch { toast('匯入失敗'); }
      };
      r.readAsText(f); e.target.value='';
    };

    // 常錯統計（子類彈窗）
    $('#stat-grammar').onclick = ()=>openStatModal('Grammar');
    $('#stat-col').onclick = ()=>openStatModal('Collocations');
    $('#stat-voc').onclick = ()=>openStatModal('Vocabulary');
    $('#stat-close').onclick = closeStatModal;
    $('#stat-close-bottom').onclick = closeStatModal;

    // 雲端按鈕
    $('#btn-auth').onclick = authorize;    // 初始給 authorize；登入後會改綁 signOut
    $('#btn-backup').onclick = backupToDrive;
    $('#btn-restore').onclick = restoreFromDrive;

    /* ========= 啟動 ========= */
    // PWA sw（可留可刪）
    if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('sw.js').catch(()=>{}); }); }

    loadLocal(); render(); updateAuthUI(false);

    // 若外部 script 已載入，手動觸發初始化
    if(typeof gapi!=='undefined'){ gapiLoaded(); }
    if(typeof google!=='undefined'){ gisLoaded(); }
  </script>
</body>
</html>
