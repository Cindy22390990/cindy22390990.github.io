<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ğŸ“’ è‹±æ–‡éŒ¯é¡Œæœ¬ï¼ˆDrive é›²ç«¯ï¼‰</title>

  <!-- PWA -->
  <meta name="theme-color" content="#2563eb" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- UIï¼šTailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
  <style>
    html,body{height:100%}
    body{font-family:'Inter', system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans TC','PingFang TC','Microsoft JhengHei',sans-serif;background:#f8fafc}
    .tap{-webkit-tap-highlight-color:transparent}
    .btn{padding:.625rem .875rem;border-radius:.75rem;font-weight:700;transition:transform .06s}
    .btn:active{transform:scale(.98)}
    .btn-primary{background:#2563eb;color:#fff}
    .btn-ghost{background:#eef2f7;color:#1f2937}
    .btn-danger{background:#ef4444;color:#fff}
    .card{background:#fff;border:1px solid #eef2f7;border-radius:1rem;box-shadow:0 10px 15px -8px rgba(0,0,0,.08)}
    .pill{font-size:12px;padding:.125rem .5rem;border-radius:9999px}
    .safe-top{padding-top:calc(env(safe-area-inset-top) + .5rem)}
    .safe-bottom{padding-bottom:calc(env(safe-area-inset-bottom) + 1rem)}
    .sticky-header{position:sticky;top:0;z-index:30;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid #e5e7eb}
    .toolbar .btn{min-height:48px}              /* iPhone 15 Pro Max å¯è§¸å€ */
    .floating-add{width:64px;height:64px;border-radius:9999px}
    .disabled{opacity:.45;pointer-events:none}
    .quiz-opt{display:flex;align-items:center;gap:.75rem;border:1.5px solid #e5e7eb;border-radius:.875rem;padding:.875rem 1rem;font-weight:700}
    .opt-A::before{content:'A';display:inline-grid;place-items:center;width:36px;height:36px;border-radius:9999px;background:#eef2ff;color:#1d4ed8;font-weight:800}
    .opt-B::before{content:'B';display:inline-grid;place-items:center;width:36px;height:36px;border-radius:9999px;background:#eef2ff;color:#1d4ed8;font-weight:800}
    .opt-C::before{content:'C';display:inline-grid;place-items:center;width:36px;height:36px;border-radius:9999px;background:#eef2ff;color:#1d4ed8;font-weight:800}
    .opt-D::before{content:'D';display:inline-grid;place-items:center;width:36px;height:36px;border-radius:9999px;background:#eef2ff;color:#1d4ed8;font-weight:800}
    .opt-right{border-color:#16a34a;background:#ecfdf5}
    .opt-wrong{border-color:#ef4444;background:#fef2f2}
    /* Sheet (è¡¨å–®) */
    #sheet{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:end;z-index:50}
    #sheet .panel{background:#fff;border-top-left-radius:1.25rem;border-top-right-radius:1.25rem;max-width:720px;margin:0 auto;width:100%}
    #sheet .titlebar{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;z-index:10}
    /* çµ±è¨ˆé¢æ¿ */
    #stats{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50}
  </style>

  <!-- Google èº«åˆ†èˆ‡ API -->
  <script async defer src="https://accounts.google.com/gsi/client"></script>
  <script async defer src="https://apis.google.com/js/api.js"></script>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Header -->
  <header class="sticky-header safe-top">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-start gap-3">
      <div class="flex-1">
        <div class="text-xs text-gray-400">ENG Error Notebook</div>
        <h1 class="text-2xl font-extrabold text-gray-800">ğŸ“’ è‹±æ–‡éŒ¯é¡Œæœ¬ï¼ˆDrive é›²ç«¯ï¼‰</h1>
        <div id="drive-status" class="text-xs text-gray-500 mt-1">é›¢ç·šæ¨¡å¼ï¼ˆå°šæœªç™»å…¥ï¼‰</div>
      </div>
      <!-- å³ä¸Šè§’å·¥å…·åˆ—ï¼šåŠ é«˜å¯é»æ“Š -->
      <div class="toolbar grid grid-cols-3 gap-3">
        <button id="btn-auth" class="btn btn-primary">Google ç™»å…¥</button>
        <button id="btn-backup" class="btn btn-primary disabled">å‚™ä»½</button>
        <button id="btn-restore" class="btn btn-ghost disabled">é‚„åŸ</button>
      </div>
    </div>
    <div class="max-w-3xl mx-auto px-4 pb-3">
      <button id="btn-import-file" class="btn btn-ghost">åŒ¯å…¥ï¼ˆæª”æ¡ˆï¼‰</button>
      <input id="file-import" type="file" accept="application/json" class="hidden" />
    </div>
  </header>

  <!-- é¡åˆ¥ Tabs -->
  <nav class="bg-white border-b border-gray-200">
    <div class="max-w-3xl mx-auto px-2 py-2 grid grid-cols-3 gap-2">
      <button data-cat="Grammar" class="tab btn btn-ghost tap">ğŸ“ æ–‡æ³• <span class="count text-gray-400"></span></button>
      <button data-cat="Collocations" class="tab btn btn-ghost tap">ğŸ”— ç‰‡èª <span class="count text-gray-400"></span></button>
      <button data-cat="Vocabulary" class="tab btn btn-ghost tap">ğŸ’¡ å–®å­— <span class="count text-gray-400"></span></button>
    </div>
  </nav>

  <!-- æœå°‹ï¼‹æ¨¡å¼åˆ‡æ› -->
  <section class="bg-white">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center gap-2">
      <div class="flex-1 relative">
        <input id="search" type="search" placeholder="æœå°‹é¡Œå¹¹/æ¨™ç±¤ï¼ˆex: ä»‹ç³»è© / scheduleï¼‰"
               class="w-full rounded-lg border border-gray-300 px-3 py-2 pl-9 focus:ring-2 focus:ring-blue-500 outline-none">
        <div class="absolute left-2 top-2.5 text-gray-400">ğŸ”</div>
      </div>
      <button id="mode-flip" class="btn btn-ghost" data-mode="flip">ğŸ“‘ å¿«é€Ÿç¿»</button>
      <button id="mode-quiz" class="btn btn-ghost" data-mode="quiz">â“ æ¸¬é©—</button>
    </div>

    <!-- å¸¸éŒ¯çµ±è¨ˆ -->
    <div class="max-w-3xl mx-auto px-4 pb-3 flex items-center gap-3">
      <span class="text-sm text-gray-600">ğŸ“ˆ å¸¸éŒ¯çµ±è¨ˆï¼š</span>
      <button id="btn-stats" class="pill bg-slate-100 text-slate-700">æ–‡æ³• 0</button>
      <span class="pill bg-slate-100 text-slate-700">ç‰‡èª 0</span>
      <span class="pill bg-slate-100 text-slate-700">å–®å­— 0</span>
    </div>
  </section>

  <!-- ä¸»å…§å®¹ -->
  <main class="flex-1">
    <div id="cards" class="max-w-3xl mx-auto px-4 py-4 space-y-4"></div>
    <div id="empty" class="hidden max-w-3xl mx-auto px-4 py-16 text-center text-gray-500">
      ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œé»å³ä¸‹è§’ <b>ï¼‹</b> æ–°å¢ç¬¬ä¸€å¼µå¡ç‰‡å§ï¼
    </div>
  </main>

  <!-- æ–°å¢æŒ‰éˆ• -->
  <div class="fixed right-5 bottom-5 z-40">
    <button id="btn-add" class="btn btn-primary floating-add shadow-xl text-3xl leading-none">ï¼‹</button>
  </div>

  <!-- è¡¨å–® Sheet -->
  <div id="sheet">
    <div class="panel max-h-[88vh] w-full">
      <div class="titlebar px-4 pt-3 pb-2 flex items-center justify-between">
        <h2 id="sheet-title" class="text-lg font-bold">æ–°å¢éŒ¯é¡Œ</h2>
        <button id="sheet-close" class="btn btn-ghost">âœ•</button>
      </div>
      <form id="form" class="p-4 space-y-3 overflow-y-auto" style="max-height:60vh">
        <input type="hidden" id="form-id" />
        <div>
          <label class="text-sm text-gray-700">åˆ†é¡</label>
          <select id="form-category" class="w-full border rounded-lg px-3 py-2">
            <option value="Grammar">æ–‡æ³•</option>
            <option value="Collocations">ç‰‡èª</option>
            <option value="Vocabulary">å–®å­—</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-gray-700">é¡Œå¹¹ï¼ˆå¯è²¼æ–‡ç« æ®µè½ï¼‰</label>
          <textarea id="form-question" rows="3" class="w-full border rounded-lg px-3 py-2"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div><label class="text-sm text-gray-700">A</label><input id="form-a" class="w-full border rounded-lg px-3 py-2"></div>
          <div><label class="text-sm text-gray-700">B</label><input id="form-b" class="w-full border rounded-lg px-3 py-2"></div>
          <div><label class="text-sm text-gray-700">C</label><input id="form-c" class="w-full border rounded-lg px-3 py-2"></div>
          <div><label class="text-sm text-gray-700">D</label><input id="form-d" class="w-full border rounded-lg px-3 py-2"></div>
        </div>
        <div>
          <label class="text-sm text-gray-700">æ­£è§£ï¼ˆè¼¸å…¥ A/B/C/Dï¼‰</label>
          <input id="form-answer" class="w-full border rounded-lg px-3 py-2" placeholder="A / B / C / D" />
        </div>
        <div>
          <label class="text-sm text-gray-700">ğŸ” éŒ¯å› åˆ†æ</label>
          <textarea id="form-analysis" rows="2" class="w-full border rounded-lg px-3 py-2"></textarea>
        </div>
        <div>
          <label class="text-sm text-gray-700">ğŸ¯ è¨˜æ†¶å£è¨£/å°æŠ€å·§</label>
          <textarea id="form-mnemonic" rows="2" class="w-full border rounded-lg px-3 py-2"></textarea>
        </div>
        <div>
          <label class="text-sm text-gray-700">æ¨™ç±¤ï¼ˆä»¥ # é–‹é ­å¯åšçµ±è¨ˆï¼Œå¦‚ï¼š#ä»‹ç³»è©, #å½¢å®¹è©ï¼‰</label>
          <input id="form-tags" class="w-full border rounded-lg px-3 py-2" placeholder="#ä»‹ç³»è©, #Part5">
        </div>
        <div class="flex items-center justify-between pt-2">
          <button type="button" id="btn-delete" class="hidden text-red-600">åˆªé™¤</button>
          <button class="btn btn-primary">å„²å­˜</button>
        </div>
      </form>
      <div class="p-3 safe-bottom">
        <button id="sheet-close-bottom" class="btn btn-ghost w-full">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- çµ±è¨ˆé¢æ¿ -->
  <div id="stats">
    <div class="card w-[92%] max-w-xl bg-white p-4 safe-bottom">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-bold">æ–‡æ³•å¸¸éŒ¯ç´°é …</h3>
        <button id="stats-close" class="btn btn-ghost">âœ•</button>
      </div>
      <div id="stats-body" class="text-sm text-gray-700 space-y-2 max-h-[60vh] overflow-y-auto"></div>
    </div>
  </div>

  <!-- æç¤º -->
  <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-28 z-[100] hidden">
    <div class="bg-gray-900 text-white text-sm px-3 py-2 rounded-full shadow-lg">å·²å„²å­˜</div>
  </div>

  <!-- è¼‰å…¥é®ç½© -->
  <div id="loading" class="fixed inset-0 bg-white/80 flex items-center justify-center z-[80] hidden">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-2"></div>
      <p class="text-gray-700">åŒæ­¥ä¸­...</p>
    </div>
  </div>

  <script>
  /* ========= åŸºç¤å·¥å…· ========= */
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  const uid = ()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
  const LS_KEY='eng_error_cards_v3';
  const state={cat:'Grammar',mode:'flip',data:[],filtered:[]};

  const toast=(msg='å·²å„²å­˜')=>{
    const t=$("#toast"); t.firstElementChild.textContent=msg;
    t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),1400);
  };

  const loadLocal=()=>{ try{state.data=JSON.parse(localStorage.getItem(LS_KEY)||'[]');}catch{state.data=[];} };
  const saveLocal=()=>localStorage.setItem(LS_KEY, JSON.stringify(state.data));

  /* ========= UI æ¸²æŸ“ ========= */
  function renderTabs(){
    $$('.tab').forEach(btn=>{
      const cat=btn.dataset.cat;
      const count=state.data.filter(d=>d.category===cat).length;
      btn.querySelector('.count').textContent=count?`(${count})`:'';
      const active = state.cat===cat;
      btn.classList.toggle('btn-primary',active);
      btn.classList.toggle('btn-ghost',!active);
      btn.classList.toggle('text-white',active);
    });
    // çµ±è¨ˆæ°£æ³¡
    const g = state.data.filter(d=>d.category==='Grammar');
    const c = state.data.filter(d=>d.category==='Collocations');
    const v = state.data.filter(d=>d.category==='Vocabulary');
    const pills = document.querySelectorAll('section .pill');
    pills[0].textContent = `æ–‡æ³• ${g.length}`;
    pills[1].textContent = `ç‰‡èª ${c.length}`;
    pills[2].textContent = `å–®å­— ${v.length}`;
  }

  function computeFiltered(){
    const q = $('#search').value.trim().toLowerCase();
    state.filtered = state.data
      .filter(d=>d.category===state.cat)
      .filter(d=>{
        if(!q) return true;
        const blob=[d.question,d.analysis,d.mnemonic,(d.tags||[]).join(',')].join(' ').toLowerCase();
        return blob.includes(q);
      })
      .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  }

  function render(){
    renderTabs(); computeFiltered();
    const host=$("#cards"); host.innerHTML='';
    if(state.filtered.length===0){ $("#empty").classList.remove('hidden'); return; }
    $("#empty").classList.add('hidden');
    state.filtered.forEach(it=>host.appendChild(cardEl(it)));
  }

  function cardEl(it){
    const wrap=document.createElement('div');
    wrap.className='card p-4';
    const tagHTML=(it.tags||[]).map(t=>`<span class="pill bg-gray-100 text-gray-600 mr-1">#${t.replace(/^#/, '')}</span>`).join('');
    const header = `
      <div class="flex items-center justify-between mb-2">
        <div class="text-sm text-blue-600 font-semibold">${({'Grammar':'ğŸ“ æ–‡æ³•','Collocations':'ğŸ”— ç‰‡èª','Vocabulary':'ğŸ’¡ å–®å­—'}[it.category])}</div>
        <div class="text-xs text-gray-400">${new Date(it.createdAt||Date.now()).toLocaleDateString()}</div>
      </div>
      <div class="text-xs text-gray-500 mb-2">
        <span class="mr-2">éŒ¯ <b class="text-red-600">${it.wrongCount||0}</b></span>
        <span>â¤ï¸ <b class="text-pink-600">${it.heart||0}</b></span>
      </div>
      <div class="font-bold text-gray-900 whitespace-pre-wrap mb-2">${it.question?it.question: ''}</div>
      <div class="mb-2">${tagHTML}</div>
    `;
    wrap.insertAdjacentHTML('afterbegin', header);

    if(state.mode==='flip'){
      // è©³è§£æ¨¡å¼
      const detail = document.createElement('div');
      detail.innerHTML = `
        <div class="grid grid-cols-2 gap-2 text-sm">
          <div class="p-2 bg-slate-50 border rounded-lg"><b>A</b> ${it.optA||''}</div>
          <div class="p-2 bg-slate-50 border rounded-lg"><b>B</b> ${it.optB||''}</div>
          <div class="p-2 bg-slate-50 border rounded-lg"><b>C</b> ${it.optC||''}</div>
          <div class="p-2 bg-slate-50 border rounded-lg"><b>D</b> ${it.optD||''}</div>
        </div>
        <div class="mt-2 p-3 bg-green-50 border-l-4 border-green-500 rounded-r-lg text-sm">
          <div class="font-semibold text-green-800 mb-1">âœ… æ­£è§£</div>
          <div class="text-gray-800">${it.answer||'â€”'}</div>
        </div>
        <div class="mt-2 p-3 bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg text-sm">
          <div class="font-semibold text-yellow-800 mb-1">ğŸ” éŒ¯å› åˆ†æ</div>
          <div class="text-gray-800 whitespace-pre-wrap">${it.analysis||'â€”'}</div>
        </div>
        <div class="mt-2 p-3 bg-indigo-50 border-l-4 border-indigo-500 rounded-r-lg text-sm">
          <div class="font-semibold text-indigo-800 mb-1">ğŸ¯ è¨˜æ†¶å£è¨£/å°æŠ€å·§</div>
          <div class="text-gray-800 whitespace-pre-wrap">${it.mnemonic||'â€”'}</div>
        </div>
        <div class="flex justify-end gap-2 mt-3">
          <button class="btn btn-ghost text-sm js-edit">ç·¨è¼¯</button>
          <button class="btn btn-danger text-sm js-del">åˆªé™¤</button>
          <button class="btn btn-ghost text-sm js-review">${it.isReviewed?'âœ… å·²è¤‡ç¿’':'ğŸ”„ æ¨™è¨˜å·²è¤‡ç¿’'}</button>
        </div>
      `;
      wrap.appendChild(detail);
    }else{
      // æ¸¬é©—æ¨¡å¼ï¼ˆåªé¡¯ç¤º A/B/C/D é¸é …ï¼‰
      const q = document.createElement('div');
      q.className='space-y-2';
      [['A','optA'],['B','optB'],['C','optC'],['D','optD']].forEach(([k,key])=>{
        const b=document.createElement('button');
        b.type='button';
        b.className=`quiz-opt opt-${k}`;
        b.textContent = ''; // ä¸é¡¯ç¤ºæ–‡å­—ï¼Œåªé¡¯ç¤º ABCD åœ“é»
        b.addEventListener('click',()=>{
          // å…ˆæ¸…æ¨£å¼
          q.querySelectorAll('.quiz-opt').forEach(x=>x.classList.remove('opt-right','opt-wrong'));
          const isRight = (it.answer||'').toUpperCase().trim()===k;
          if(isRight){
            b.classList.add('opt-right');
            it.heart = (it.heart||0)+1;
          }else{
            b.classList.add('opt-wrong');
            it.wrongCount = (it.wrongCount||0)+1;
          }
          saveLocal(); render(); // æ›´æ–°å¡ç‰‡è¨ˆæ•¸
        });
        q.appendChild(b);
      });
      // å‹•ä½œåˆ—
      const ops=document.createElement('div');
      ops.className='flex justify-end gap-2 mt-3';
      ops.innerHTML=`
        <button class="btn btn-ghost text-sm js-edit">ç·¨è¼¯</button>
        <button class="btn btn-danger text-sm js-del">åˆªé™¤</button>
        <button class="btn btn-ghost text-sm js-review">${it.isReviewed?'âœ… å·²è¤‡ç¿’':'ğŸ”„ æ¨™è¨˜å·²è¤‡ç¿’'}</button>
      `;
      wrap.appendChild(q); wrap.appendChild(ops);
    }

    // äº‹ä»¶
    wrap.querySelector('.js-edit').onclick=()=>openSheet(it);
    wrap.querySelector('.js-del').onclick=()=>delItem(it.id);
    wrap.querySelector('.js-review').onclick=()=>markReviewed(it.id, !(it.isReviewed));

    return wrap;
  }

  /* ========= CRUD ========= */
  function openSheet(it=null){
    $('#sheet').style.display='flex';
    $('#sheet-title').textContent = it?'ç·¨è¼¯éŒ¯é¡Œ':'æ–°å¢éŒ¯é¡Œ';
    $('#btn-delete').classList.toggle('hidden', !it);
    $('#form-id').value = it?.id || '';
    $('#form-category').value = it?.category || state.cat;
    $('#form-question').value = it?.question || '';
    $('#form-a').value = it?.optA || '';
    $('#form-b').value = it?.optB || '';
    $('#form-c').value = it?.optC || '';
    $('#form-d').value = it?.optD || '';
    $('#form-answer').value = it?.answer || '';
    $('#form-analysis').value = it?.analysis || '';
    $('#form-mnemonic').value = it?.mnemonic || '';
    $('#form-tags').value = (it?.tags||[]).join(', ');
  }
  function closeSheet(){ $('#sheet').style.display='none'; }
  function upsertLocal(obj){
    const i=state.data.findIndex(d=>d.id===obj.id);
    if(i>=0) state.data[i]=obj; else state.data.unshift(obj);
    saveLocal(); render(); toast('å·²å„²å­˜');
  }
  function delItem(id){
    if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ'))return;
    const i=state.data.findIndex(d=>d.id===id);
    if(i>=0){ state.data.splice(i,1); saveLocal(); render(); }
  }
  function markReviewed(id,flag){
    const it=state.data.find(d=>d.id===id); if(!it)return;
    it.isReviewed=!!flag; it.lastReviewed=Date.now();
    saveLocal(); render();
  }

  /* ========= å¸¸éŒ¯çµ±è¨ˆ ========= */
  function openStats(){
    const list = state.data.filter(d=>d.category==='Grammar');
    const map = new Map();
    list.forEach(it=>{
      (it.tags||[]).forEach(t=>{
        const key=t.replace(/^#/, '');
        const wrong = it.wrongCount||0;
        map.set(key, (map.get(key)||0) + wrong);
      });
    });
    const arr=[...map.entries()].sort((a,b)=>b[1]-a[1]);
    $('#stats-body').innerHTML = arr.length
      ? arr.map(([k,v])=>`<div class="flex items-center justify-between"><div>#${k}</div><div class="text-red-600 font-bold">éŒ¯ ${v}</div></div>`).join('')
      : '<div class="text-gray-500">æš«ç„¡çµ±è¨ˆè³‡æ–™</div>';
    $('#stats').style.display='flex';
  }
  const closeStats=()=>$('#stats').style.display='none';

  /* ========= åŒ¯å…¥ ========= */
  function importJSON(arr){
    if(!Array.isArray(arr)) return toast('åŒ¯å…¥æ ¼å¼éŒ¯èª¤');
    const key=(o)=> (o.question||'') + '|' + (o.answer||'');
    const map = new Map(state.data.map(o=>[key(o),o]));
    arr.forEach(o=>{
      o.id=o.id||uid();
      o.tags = Array.isArray(o.tags)? o.tags : String(o.tags||'').split(',').map(s=>s.trim()).filter(Boolean);
      map.set(key(o), {...o});
    });
    state.data=[...map.values()].sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    saveLocal(); render(); toast('å·²åŒ¯å…¥');
  }

  /* ========= Google Drive ========= */
  const GOOGLE_CLIENT_ID = 'YOUR_CLIENT_ID_HERE'; // â†â†æ›æˆä½ çš„
  const SCOPES = [
    'https://www.googleapis.com/auth/drive.appdata',
    'https://www.googleapis.com/auth/userinfo.email'
  ].join(' ');
  const DRIVE_FILE_NAME='english_mistakes_v3.json';

  let tokenClient=null, accessToken=null, driveFileId=null;

  function updateAuthUI(logged){
    const s=$('#drive-status'), ba=$('#btn-backup'), rs=$('#btn-restore'), au=$('#btn-auth');
    if(logged){
      s.textContent='âœ… å·²ç™»å…¥ Google';
      ba.classList.remove('disabled'); rs.classList.remove('disabled');
      au.textContent='ç™»å‡º'; au.onclick=signOut;
    }else{
      s.textContent='é›¢ç·šæ¨¡å¼ï¼ˆå°šæœªç™»å…¥ï¼‰';
      ba.classList.add('disabled'); rs.classList.add('disabled');
      au.textContent='Google ç™»å…¥'; au.onclick=startAuth;
    }
  }

  function initGoogle(){
    gapi.load('client', async ()=>{
      await gapi.client.init({
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
      });
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: SCOPES,
        prompt: 'consent',
        callback: (resp)=>{
          if(resp && resp.access_token){
            accessToken=resp.access_token;
            gapi.client.setToken({access_token:accessToken});
            updateAuthUI(true);
            findAppDataFile();
          }else{
            toast('ç™»å…¥å¤±æ•—'); updateAuthUI(false);
          }
        }
      });
      updateAuthUI(false);
    });
  }
  function startAuth(){
    if(!tokenClient){ toast('Google æœå‹™æœªå°±ç·’'); return; }
    tokenClient.requestAccessToken();
  }
  function signOut(){
    if(!accessToken) return;
    google.accounts.oauth2.revoke(accessToken, ()=>{
      accessToken=null; driveFileId=null; updateAuthUI(false);
      toast('å·²ç™»å‡º');
    });
  }

  async function findAppDataFile(){
    try{
      const resp = await gapi.client.drive.files.list({
        spaces: 'appDataFolder', q: `name='${DRIVE_FILE_NAME}'`, fields: 'files(id,modifiedTime)'
      });
      driveFileId = (resp.result.files[0]?.id) || null;
    }catch(e){
      // å¸¸è¦‹ï¼šæœªå•Ÿç”¨ Drive API / scope ä¸ç¬¦
      console.warn(e);
    }
  }

  async function backupToDrive(){
    if(!accessToken){ toast('è«‹å…ˆç™»å…¥ Google'); return; }
    $('#loading').classList.remove('hidden');
    try{
      const data = JSON.stringify(state.data, null, 2);
      // è‹¥å·²æœ‰æª”æ¡ˆï¼šç›´æ¥ä»¥ media æ›´æ–°ï¼›å¦å‰‡å»ºç«‹ multipart
      if(driveFileId){
        const res = await gapi.client.request({
          path: `/upload/drive/v3/files/${driveFileId}`,
          method: 'PATCH',
          params: {uploadType:'media'},
          headers: {'Content-Type':'application/json'},
          body: data
        });
        if(res.status===200){ toast('âœ… å‚™ä»½æˆåŠŸ'); }
      }else{
        const metadata = {name:DRIVE_FILE_NAME, parents:['appDataFolder']};
        const boundary='-------eng-notebook-'+Date.now();
        const body =
          `--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n`+
          `${JSON.stringify(metadata)}\r\n`+
          `--${boundary}\r\nContent-Type: application/json\r\n\r\n`+
          `${data}\r\n--${boundary}--`;
        const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',{
          method:'POST',
          headers:{
            'Authorization':`Bearer ${accessToken}`,
            'Content-Type':`multipart/related; boundary=${boundary}`
          },
          body
        });
        if(res.ok){ const j=await res.json(); driveFileId=j.id; toast('âœ… å‚™ä»½æˆåŠŸ'); }
        else throw await res.json();
      }
    }catch(err){
      console.error(err);
      // å‹å–„æç¤º
      toast('å‚™ä»½å¤±æ•—ï¼šè«‹åˆ° GCP å•Ÿç”¨ Google Drive APIï¼Œæˆ–ç¨å¾Œå†è©¦');
    }finally{
      $('#loading').classList.add('hidden');
    }
  }

  async function restoreFromDrive(){
    if(!accessToken){ toast('è«‹å…ˆç™»å…¥ Google'); return; }
    $('#loading').classList.remove('hidden');
    try{
      await findAppDataFile();
      if(!driveFileId){ toast('é›²ç«¯å°šç„¡å‚™ä»½'); return; }
      const res = await gapi.client.drive.files.get({fileId:driveFileId, alt:'media'});
      if(res.result){ importJSON(res.result); toast('âœ… é‚„åŸæˆåŠŸ'); }
    }catch(err){
      console.error(err);
      toast('é‚„åŸå¤±æ•—ï¼šè«‹ç¢ºèª API æ¬Šé™æˆ–ç¨å¾Œå†è©¦');
    }finally{
      $('#loading').classList.add('hidden');
    }
  }

  /* ========= äº‹ä»¶ ========= */
  // Tabs
  $$('.tab').forEach(b=>b.onclick=()=>{ state.cat=b.dataset.cat; render(); });
  // æ¨¡å¼
  $('#mode-flip').onclick=()=>{ state.mode='flip'; render(); $('#mode-flip').classList.add('btn-primary'); $('#mode-quiz').classList.remove('btn-primary'); };
  $('#mode-quiz').onclick=()=>{ state.mode='quiz'; render(); $('#mode-quiz').classList.add('btn-primary'); $('#mode-flip').classList.remove('btn-primary'); };
  // æ–°å¢
  $('#btn-add').onclick=()=>openSheet();
  $('#sheet-close').onclick=closeSheet;
  $('#sheet-close-bottom').onclick=closeSheet;
  // è¡¨å–®é€å‡º
  $('#form').onsubmit=(e)=>{
    e.preventDefault();
    const id = $('#form-id').value || uid();
    const existed = state.data.find(d=>d.id===id);
    const obj = {
      id,
      category: $('#form-category').value,
      question: $('#form-question').value.trim(),
      optA: $('#form-a').value.trim(),
      optB: $('#form-b').value.trim(),
      optC: $('#form-c').value.trim(),
      optD: $('#form-d').value.trim(),
      answer: $('#form-answer').value.trim().toUpperCase(),
      analysis: $('#form-analysis').value.trim(),
      mnemonic: $('#form-mnemonic').value.trim(),
      tags: $('#form-tags').value.split(',').map(s=>s.trim()).filter(Boolean),
      createdAt: existed? existed.createdAt : Date.now(),
      wrongCount: existed? (existed.wrongCount||0) : 0,
      heart: existed? (existed.heart||0) : 0,
      isReviewed: existed? !!existed.isReviewed : false
    };
    upsertLocal(obj); closeSheet();
  };
  $('#btn-delete').onclick=()=>{
    const id=$('#form-id').value; if(id){ closeSheet(); delItem(id); }
  };

  // åŒ¯å…¥ï¼ˆæª”æ¡ˆï¼‰
  $('#btn-import-file').onclick=()=>$('#file-import').click();
  $('#file-import').onchange=(e)=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{ try{ importJSON(JSON.parse(r.result)); }catch{ toast('åŒ¯å…¥å¤±æ•—'); } };
    r.readAsText(f); e.target.value='';
  };

  // çµ±è¨ˆ
  $('#btn-stats').onclick=openStats;
  $('#stats-close').onclick=closeStats;
  $('#stats').addEventListener('click', (e)=>{ if(e.target.id==='stats') closeStats(); });

  // å‚™ä»½/é‚„åŸ
  $('#btn-backup').onclick=backupToDrive;
  $('#btn-restore').onclick=restoreFromDrive;

  // åˆå§‹åŒ–
  if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('sw.js').catch(()=>{}); }); }
  loadLocal(); render();
  initGoogle();
  </script>
</body>
</html>
