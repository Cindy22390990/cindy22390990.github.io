<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ğŸ“’ è‹±æ–‡éŒ¯é¡Œæœ¬ï¼ˆDrive é›²ç«¯ï¼‰</title>
<meta name="theme-color" content="#2563eb" />
<link rel="manifest" href="manifest.json" />
<link rel="apple-touch-icon" href="icon-192.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800;900&display=swap" rel="stylesheet" />
<script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
<script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root{
    --safe-top: max(env(safe-area-inset-top), 18px);
    --safe-side: max(env(safe-area-inset-left), 16px);
    --pad: 16px;
  }
  html,body{height:100%}
  body{
    font-family:'Inter',system-ui,-apple-system,'SF Pro Text','PingFang TC','Noto Sans TC','Microsoft JhengHei',sans-serif;
    background:#f7f9fc;color:#0f172a;
  }
  .safe-top{height:var(--safe-top)}
  .container-pad{padding-left:calc(var(--safe-side) + var(--pad));padding-right:calc(var(--safe-side) + var(--pad))}
  .header{position:sticky;top:0;z-index:40;background:#fff;border-bottom:1px solid #e5e7eb;backdrop-filter:blur(6px)}
  .btn{border-radius:14px;font-weight:800;padding:.65rem 1rem;transition:.06s transform;-webkit-tap-highlight-color:transparent}
  .btn:active{transform:scale(.98)}
  .btn-lg{min-height:54px}
  .btn-primary{background:#2563eb;color:#fff}
  .btn-ghost{background:#eef2f7;color:#334155}
  .pill{font-size:12px;border-radius:9999px;padding:.125rem .5rem}
  .card{background:#fff;border:1px solid #eef2f7;border-radius:16px;box-shadow:0 8px 18px rgba(15,23,42,.06)}
  .badge{font-size:12px;background:#f1f5f9;color:#64748b;border-radius:10px;padding:.1rem .45rem}
  .hidden-hard{display:none!important}
  #loading{position:fixed;inset:0;background:rgba(255,255,255,.78);display:flex;align-items:center;justify-content:center;z-index:100;pointer-events:none}
  #loading.hidden{display:none!important}
  .fab{position:fixed;right:calc(var(--safe-side) + 18px);bottom:calc(env(safe-area-inset-bottom) + 18px);width:64px;height:64px;border-radius:9999px;background:#2563eb;color:#fff;font-size:34px;display:flex;align-items:center;justify-content:center;box-shadow:0 12px 28px rgba(37,99,235,.35);z-index:35}
  .sheet{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:end;z-index:50}
  .sheet.show{display:flex}
  .sheet-card{background:#fff;border-top-left-radius:18px;border-top-right-radius:18px;width:100%}
  .toolbar{padding:8px 0}
  .opt{display:flex;align-items:center;gap:10px;border:1px solid #e6eaf0;border-radius:12px;padding:14px 12px}
  .opt.active{border-color:#2563eb;background:#eef4ff}
  .opt.correct{border-color:#16a34a;background:#ecfdf5}
  .opt.wrong{border-color:#dc2626;background:#fef2f2}
  .kv{display:grid;grid-template-columns:120px 1fr;gap:.5rem .75rem}
  .kv .k{color:#475569}
  .kv .v{color:#0f172a}
</style>
</head>

<body class="min-h-screen flex flex-col">
  <div class="safe-top"></div>

  <header class="header">
    <div class="container-pad">
      <div class="py-2">
        <div class="text-xs text-slate-400 leading-none">ENG Error Notebook</div>
        <h1 class="text-3xl font-black leading-tight">ğŸ“’ è‹±æ–‡éŒ¯é¡Œæœ¬ <span class="text-slate-500 font-extrabold">ï¼ˆDrive é›²ç«¯ï¼‰</span></h1>
        <div id="drive-status" class="text-xs text-slate-500 mt-1">é›¢ç·šæ¨¡å¼ï¼ˆå°šæœªç™»å…¥ï¼‰</div>
      </div>

      <div class="flex flex-wrap gap-3 pb-3">
        <button id="btn-auth" class="btn btn-lg btn-primary">Google ç™»å…¥</button>
        <button id="btn-backup" class="btn btn-lg btn-ghost">å‚™ä»½</button>
        <button id="btn-restore" class="btn btn-lg btn-ghost">é‚„åŸ</button>
        <button id="btn-fields" class="btn btn-lg btn-ghost">æ¬„ä½è¨­å®š</button>
      </div>
    </div>
  </header>

  <nav class="container-pad toolbar bg-white/70 backdrop-blur border-b border-slate-200 sticky top-[calc(var(--safe-top)+72px)] z-30">
    <div class="flex items-center gap-2 flex-wrap">
      <button class="btn btn-ghost" id="btn-import-file">åŒ¯å…¥ï¼ˆCSV/JSONï¼‰</button>
      <span class="text-slate-400 text-xs">æˆ–åœ¨ä¸Šæ–¹ä»¥ Drive é€²è¡Œå‚™ä»½ / é‚„åŸ</span>
    </div>

    <div class="mt-3 grid grid-cols-3 gap-3">
      <button id="tab-grammar"      class="btn btn-ghost">ğŸ“ æ–‡æ³• <span id="count-grammar" class="badge ml-1">0</span></button>
      <button id="tab-collocations" class="btn btn-ghost">ğŸ”— ç‰‡èª <span id="count-coll" class="badge ml-1">0</span></button>
      <button id="tab-vocab"        class="btn btn-ghost">ğŸ’¡ å–®å­— <span id="count-vocab" class="badge ml-1">0</span></button>
    </div>

    <div class="mt-3 flex items-center gap-2">
      <div class="flex-1">
        <div class="relative">
          <input id="search" class="w-full border border-slate-300 rounded-xl px-4 py-2 pl-10" placeholder="æœå°‹æ‰€æœ‰æ¬„ä½ï¼ˆé¡Œå¹¹/æ¨™ç±¤/è§£æâ€¦ï¼‰" />
          <div class="absolute left-3 top-2.5 text-slate-400">ğŸ”</div>
        </div>
      </div>
      <button id="btn-quick" class="btn btn-ghost">ğŸ—‚ï¸ å¿«é€Ÿç¿»</button>
      <button id="btn-quiz"  class="btn btn-ghost">â“ æ¸¬é©—</button>
    </div>

    <div class="mt-2 flex items-center gap-3 text-sm">
      <div class="flex items-center gap-1"><span class="text-slate-500">ğŸ“Š å¸¸éŒ¯çµ±è¨ˆï¼š</span>
        <button id="stat-grammar" class="pill bg-slate-100 text-rose-600">æ–‡æ³• 0</button>
        <button id="stat-coll"    class="pill bg-slate-100 text-rose-600">ç‰‡èª 0</button>
        <button id="stat-vocab"   class="pill bg-slate-100 text-rose-600">å–®å­— 0</button>
      </div>
    </div>
  </nav>

  <main class="flex-1 container-pad">
    <div id="cards" class="py-4 space-y-4"></div>
    <div id="empty" class="text-center text-slate-500 py-16">ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œé»å³ä¸‹è§’ <b>ï¼‹</b> æ–°å¢ç¬¬ä¸€å¼µå¡ç‰‡å§ï¼</div>
  </main>

  <button id="btn-add" class="fab">ï¼‹</button>

  <!-- æ–°å¢/ç·¨è¼¯ Sheet -->
  <div id="sheet" class="sheet">
    <div class="sheet-card container-pad pt-3 pb-[calc(env(safe-area-inset-bottom)+16px)]">
      <div class="flex items-center justify-between pb-2">
        <h2 id="sheet-title" class="text-lg font-bold">æ–°å¢éŒ¯é¡Œ</h2>
        <button id="sheet-close" class="btn btn-ghost">é—œé–‰</button>
      </div>

      <form id="form" class="grid gap-3 pb-2">
        <!-- å›ºå®šä¿ç•™ï¼šåˆ†é¡ -->
        <div>
          <label class="text-sm text-slate-600">åˆ†é¡</label>
          <select id="form-category" class="w-full border rounded-xl px-3 py-2">
            <option value="Grammar">æ–‡æ³• (Grammar)</option>
            <option value="Collocations">ç‰‡èª (Collocations)</option>
            <option value="Vocabulary">å–®å­— (Vocabulary)</option>
          </select>
        </div>

        <!-- ä¾ã€Œè‡ªè¨‚æ¬„ä½ã€å‹•æ…‹ç”¢ç”Ÿ -->
        <div id="dynamic-fields" class="grid gap-3"></div>

        <div class="flex items-center justify-between pt-1">
          <button type="button" id="btn-delete" class="text-rose-600">åˆªé™¤</button>
          <button class="btn btn-primary">å„²å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- æ¬„ä½è¨­å®š Sheet -->
  <div id="sheet-fields" class="sheet">
    <div class="sheet-card container-pad pt-3 pb-[calc(env(safe-area-inset-bottom)+16px)]">
      <div class="flex items-center justify-between pb-2">
        <h2 class="text-lg font-bold">æ¬„ä½è¨­å®š</h2>
        <button id="fields-close" class="btn btn-ghost">é—œé–‰</button>
      </div>
      <div class="text-sm text-slate-600 mb-2">æ¯ä¸€è¡Œä¸€å€‹æ¬„ä½åç¨±ï¼ˆæœƒä¾åºé¡¯ç¤ºï¼‰ã€‚è‹¥åŒ¯å…¥ CSV/JSON æœƒè‡ªå‹•è¦†è“‹ç‚ºæª”æ¡ˆæ¬„ä½ã€‚</div>
      <textarea id="fields-editor" rows="8" class="w-full border rounded-xl px-3 py-2"></textarea>
      <div class="flex justify-end mt-2">
        <button id="fields-save" class="btn btn-primary">å„²å­˜æ¬„ä½</button>
      </div>
    </div>
  </div>

  <!-- loading -->
  <div id="loading" class="hidden">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-2"></div>
      <div class="text-slate-700">åŒæ­¥ä¸­â€¦</div>
    </div>
  </div>

<script>
/* ========= åŸºæœ¬å·¥å…· ========= */
const $  = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const LS_KEY='eng_error_cards_v3';
const FIELDS_KEY='eng_error_custom_fields_v1'; // è‡ªè¨‚æ¬„ä½ï¼ˆä¸å«åˆ†é¡ï¼‰
const state={cat:'Grammar',mode:'list',data:[],filtered:[],fields:[]}; // fields: è‡ªè¨‚æ¬„ä½åç¨±é™£åˆ—

/* ========= PWA SW ========= */
if('serviceWorker' in navigator){
  addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
}

/* ========= è‡ªè¨‚æ¬„ä½ è®€å¯« ========= */
function loadFields(){
  try{ state.fields=JSON.parse(localStorage.getItem(FIELDS_KEY)||'[]'); }catch{ state.fields=[]; }
}
function saveFields(){
  localStorage.setItem(FIELDS_KEY, JSON.stringify(state.fields||[]));
}

/* ========= æœ¬åœ°è³‡æ–™ ========= */
function loadLocal(){ try{ state.data=JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ state.data=[]; } }
function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(state.data)); }

/* ========= UI æ¸²æŸ“ ========= */
function computeFiltered(){
  const q=$('#search').value.trim().toLowerCase();

  // åˆ†é¡ä¾†æºï¼šå„ªå…ˆ item.metaCategoryï¼ˆç”±ã€Œåˆ†é¡ã€æ¬„ä½æˆ– select è¨­å®šï¼‰ï¼Œå›é€€åˆ°èˆŠçµæ§‹ item.category
  const picks = state.data.filter(d=>{
    const itemCat = (d.metaCategory || d.category || 'Grammar');
    return itemCat===state.cat;
  });
  state.filtered = picks
    .filter(d=>{
      if(!q) return true;
      const blobParts=[];
      // èˆŠæ¬„ä½
      ['question','wrongAnswer','correctAnswer','analysis','mnemonic','tags','subtopic','correctOption'].forEach(k=>{
        const v = d[k];
        if(Array.isArray(v)) blobParts.push(v.join(','));
        else if(v!=null) blobParts.push(String(v));
      });
      // è‡ªè¨‚æ¬„ä½
      const fieldsObj = d.fields||{};
      Object.keys(fieldsObj).forEach(k=>blobParts.push(k, String(fieldsObj[k]??'')));
      const blob = blobParts.join(' ').toLowerCase();
      return blob.includes(q);
    })
    .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
}

function setMode(m){
  state.mode=m;
  $('#btn-quick').classList.toggle('btn-primary', m==='list');
  $('#btn-quiz').classList.toggle('btn-primary', m==='quiz');
  render();
}

function renderTabs(){
  const countByCat = (cat)=>{
    return state.data.filter(d=> (d.metaCategory||d.category||'Grammar')===cat).length;
  };
  $('#count-grammar').textContent = countByCat('Grammar');
  $('#count-coll').textContent    = countByCat('Collocations');
  $('#count-vocab').textContent   = countByCat('Vocabulary');
}

function statCounts(){
  // ä»èˆŠä»¥å­åˆ†é¡ï¼ˆè‹¥ä½ çš„æ¬„ä½ä¸­æœ‰ã€Œå­åˆ†é¡ã€æˆ–ç­‰åƒ¹æ¬„ä½ï¼Œæœƒé¡¯ç¤ºå¾—æ›´æº–ï¼›å¦å‰‡ç”¨æœªæ¨™è¨»ï¼‰
  const subKeyCandidates = ['å­åˆ†é¡','subtopic','å­ä¸»é¡Œ','é¡Œå‹'];
  const pickSub = it=>{
    const f=it.fields||{};
    for(const k of subKeyCandidates){
      if(f[k]) return String(f[k]).trim();
    }
    return (it.subtopic||'æœªæ¨™è¨»').trim() || 'æœªæ¨™è¨»';
  };
  const tally = (arr)=>arr.reduce((m,it)=>{ const k=pickSub(it); m[k]=(m[k]||0)+(it.wrongCount||0); return m; },{});
  return {
    grammar: tally(state.data.filter(d=>(d.metaCategory||d.category||'Grammar')==='Grammar')),
    coll:    tally(state.data.filter(d=>(d.metaCategory||d.category||'Grammar')==='Collocations')),
    vocab:   tally(state.data.filter(d=>(d.metaCategory||d.category||'Grammar')==='Vocabulary')),
  };
}

function showStat(kind){
  const box = statCounts()[kind];
  const pairs = Object.entries(box).sort((a,b)=>b[1]-a[1]);
  const msg = pairs.length? pairs.map(([k,v])=>`${k}ï¼š${v}`).join('\n') : 'ç›®å‰æ²’æœ‰çµ±è¨ˆè³‡æ–™';
  alert(`å¸¸éŒ¯çµ±è¨ˆï¼ˆ${{grammar:'æ–‡æ³•',coll:'ç‰‡èª',vocab:'å–®å­—'}[kind]}ï¼‰\n\n${msg}`);
}

function escapeHTML(s){return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]))}

function renderDynamicFields(container, item){
  container.innerHTML='';
  // æ ¹æ“šæ¬„ä½åç¨±ï¼Œæ±ºå®šç”¨ input æˆ– textarea çš„èˆ’é©å‹æ…‹
  const longFieldHints = ['é¡Œå¹¹','é¡Œç›®','è§£æ','éŒ¯å› ','éŒ¯å› åˆ†æ','è¨˜æ†¶å£è¨£','å‚™è¨»','ä¾‹å¥','å¥å­','èªªæ˜','è§£é‡‹','è§£é‡‹èªªæ˜','è§£é¡Œæ­¥é©Ÿ'];
  const isLong = name => longFieldHints.some(h=>name.toLowerCase().includes(h.toLowerCase()));
  const fieldsObj = item?.fields || {};
  state.fields.forEach(name=>{
    const value = fieldsObj[name] ?? '';
    const id = 'fld-' + name.replace(/\s+/g,'_');
    const label = `<label class="text-sm text-slate-600">${escapeHTML(name)}</label>`;
    if(isLong(name)){
      container.insertAdjacentHTML('beforeend', `
        <div>
          ${label}
          <textarea data-key="${escapeHTML(name)}" id="${id}" rows="3" class="w-full border rounded-xl px-3 py-2"></textarea>
        </div>`);
    }else{
      container.insertAdjacentHTML('beforeend', `
        <div>
          ${label}
          <input data-key="${escapeHTML(name)}" id="${id}" class="w-full border rounded-xl px-3 py-2" />
        </div>`);
    }
    const el = $('#'+id);
    el.value = value;
  });
}

function cardEl(it){
  const wrap=document.createElement('div');
  wrap.className='card p-4';
  const catLabel = {'Grammar':'ğŸ“ æ–‡æ³•','Collocations':'ğŸ”— ç‰‡èª','Vocabulary':'ğŸ’¡ å–®å­—'}[it.metaCategory||it.category]||'ğŸ“„';
  const wrongTag = `<span class="pill bg-rose-50 text-rose-600">éŒ¯ ${it.wrongCount||0}</span>`;
  const heartTag = `<span class="pill bg-fuchsia-50 text-fuchsia-700">ğŸ’— ${it.heart||0}</span>`;
  const createdStr = new Date(it.createdAt||Date.now()).toLocaleDateString();

  // å°‡è‡ªè¨‚æ¬„ä½ä»¥ key-value æ–¹å¼é¡¯ç¤º
  const kvHtml = (state.fields||[]).map(k=>{
    const v = (it.fields||{})[k];
    if(v==null || v==='') return '';
    return `<div class="k">${escapeHTML(k)}</div><div class="v">${escapeHTML(String(v))}</div>`;
  }).join('');

  wrap.innerHTML = `
    <div class="flex items-center justify-between mb-1">
      <div class="text-sm text-blue-600 font-semibold">${catLabel}</div>
      <div class="text-xs text-slate-400">${createdStr} ${wrongTag} ${heartTag}</div>
    </div>

    <div class="kv mb-2">${kvHtml || '<div class="text-slate-500">ï¼ˆç„¡æ¬„ä½è³‡æ–™ï¼‰</div>'}</div>

    <div class="${state.mode==='quiz'?'':'hidden'}" id="quiz">
      <div class="grid grid-cols-1 gap-2">
        ${['A','B','C','D'].map(letter=>`
          <button class="opt" data-opt="${letter}">
            <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-extrabold">${letter}</div>
            <div class="font-medium text-slate-800">${letter}</div>
          </button>`).join('')}
      </div>
    </div>

    <div class="flex justify-end gap-2 mt-3">
      <button class="btn btn-ghost text-sm js-edit">ç·¨è¼¯</button>
      <button class="btn btn-ghost text-sm text-rose-600 js-del">åˆªé™¤</button>
      <button class="btn btn-ghost text-sm js-heart">ğŸ’— åŠ ä¸€</button>
      <button class="btn btn-ghost text-sm js-review">${it.isReviewed?'âœ… å·²è¤‡ç¿’':'ğŸ”„ æ¨™è¨˜å·²è¤‡ç¿’'}</button>
    </div>
  `;

  wrap.querySelector('.js-edit').onclick = ()=>openSheet(it);
  wrap.querySelector('.js-del').onclick  = ()=>delItem(it.id);
  wrap.querySelector('.js-heart').onclick= ()=>{ it.heart=(it.heart||0)+1; saveLocal(); render(); };
  wrap.querySelector('.js-review').onclick=()=>markReviewed(it.id, !it.isReviewed);

  // æ¸¬é©—ï¼ˆè‹¥ä½ çš„è‡ªè¨‚æ¬„ä½ä¸­æœ‰ã€Œæ­£è§£é¸é …ã€æˆ– "correctOption" ä¹‹é¡ï¼Œæœƒè‡ªå‹•æŠ“ï¼‰
  if(state.mode==='quiz'){
    const guessCorrectKey = ['æ­£è§£é¸é …','æ­£è§£(é¸é …)','correctOption','ç­”æ¡ˆé¸é …','answerOption'];
    let correct = (it.correctOption||'').trim().toUpperCase();
    for(const k of guessCorrectKey){
      const v = (it.fields||{})[k];
      if(v){ correct=String(v).trim().toUpperCase(); break; }
    }
    wrap.querySelectorAll('.opt').forEach(btn=>{
      btn.onclick=()=>{
        wrap.querySelectorAll('.opt').forEach(b=>b.classList.remove('active','correct','wrong'));
        btn.classList.add('active');
        const pick = btn.dataset.opt;
        if(correct){
          if(pick===correct){
            btn.classList.add('correct');
            it.heart=(it.heart||0)+1;
          }else{
            btn.classList.add('wrong');
            it.wrongCount=(it.wrongCount||0)+1;
          }
          saveLocal(); renderTabs();
        }else{
          alert('æ­¤å¡æœªè¨­å®šæ­£è§£é¸é …ï¼ˆA/B/C/Dï¼‰ã€‚å¯åœ¨è‡ªè¨‚æ¬„ä½ä¸­åŠ å…¥ã€Œæ­£è§£é¸é …ã€ã€‚');
        }
      };
    });
  }

  return wrap;
}

function render(){
  renderTabs(); computeFiltered();
  const host=$('#cards'); host.innerHTML='';
  if(state.filtered.length===0){ $('#empty').classList.remove('hidden-hard'); }
  else { $('#empty').classList.add('hidden-hard'); state.filtered.forEach(it=>host.appendChild(cardEl(it))); }
}

/* ========= CRUD ========= */
function openSheet(it=null){
  $('#sheet').classList.add('show');
  $('#sheet-title').textContent = it?'ç·¨è¼¯éŒ¯é¡Œ':'æ–°å¢éŒ¯é¡Œ';
  $('#btn-delete').classList.toggle('hidden-hard', !it);
  $('#form-category').value = it?.metaCategory || it?.category || state.cat;
  // å‹•æ…‹æ¬„ä½
  renderDynamicFields($('#dynamic-fields'), it);
  // å›å¡«ï¼ˆèˆŠæ¬„ä½ç›¸å®¹ï¼šè‹¥è‡ªè¨‚æ¬„ä½æ²’æœ‰é¡Œå¹¹/è§£æç­‰ï¼Œæœƒä¿ç•™åŸè³‡æ–™ï¼‰
  const fieldsObj = it?.fields||{};
  // nothing else neededï¼Œå› ç‚º renderDynamicFields å·²å›å¡«
}
function closeSheet(){ $('#sheet').classList.remove('show'); }

function collectForm(){
  // å–åˆ†é¡
  const metaCategory = $('#form-category').value;
  // å–è‡ªè¨‚æ¬„ä½
  const fields = {};
  $('#dynamic-fields').querySelectorAll('[data-key]').forEach(el=>{
    const key = el.getAttribute('data-key');
    fields[key] = el.value.trim();
  });
  return { metaCategory, fields };
}

function upsertLocal(obj){
  const i=state.data.findIndex(d=>d.id===obj.id);
  if(i>=0) state.data[i]=obj; else state.data.unshift(obj);
  saveLocal(); render();
}
function delItem(id){
  if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
  const i=state.data.findIndex(d=>d.id===id);
  if(i>=0){ state.data.splice(i,1); saveLocal(); render(); }
}
function markReviewed(id,flag){
  const it=state.data.find(d=>d.id===id); if(!it) return;
  it.isReviewed=!!flag; it.reviewCount=(it.reviewCount||0)+(flag?1:0); it.lastReviewed=Date.now();
  saveLocal(); render();
}

/* ========= åŒ¯å…¥/åŒ¯å‡ºï¼ˆæœ¬æ©Ÿæª”æ¡ˆï¼‰ ========= */
(function setupFileImport(){
  const btn=$('#btn-import-file');
  const input=document.createElement('input'); input.type='file'; input.accept='.csv,application/json,text/csv';
  btn.onclick=()=>input.click();

  function parseCSV(text){
    // ç°¡æ˜“ CSV è§£æï¼šæ”¯æ´é€—è™Ÿã€é›™å¼•è™Ÿæ‹¬å€¼ã€è·³è„« ""
    const lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l=>l.trim().length>0);
    if(lines.length===0) return {headers:[],rows:[]};
    const parseLine = (line)=>{
      const out=[]; let cur=''; let inQ=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(inQ){
          if(ch==='"' && line[i+1]==='"'){ cur+='"'; i++; }
          else if(ch==='"'){ inQ=false; }
          else cur+=ch;
        }else{
          if(ch===','){ out.push(cur); cur=''; }
          else if(ch==='"'){ inQ=true; }
          else cur+=ch;
        }
      }
      out.push(cur);
      return out;
    };
    const headers = parseLine(lines[0]).map(h=>h.trim()).filter(Boolean);
    const rows = lines.slice(1).map(l=>parseLine(l)).map(arr=>{
      const obj={}; headers.forEach((h,idx)=>{ obj[h]=arr[idx]??''; }); return obj;
    });
    return {headers, rows};
  }

  function adoptFieldsFromHeaders(headers){
    // æŠŠã€Œåˆ†é¡ã€é€™å€‹æ¬„ä½ä¿ç•™ç‚ºç‰¹æ®Šï¼›å…¶ä»–æ¬„ä½è®Šæˆè‡ªè¨‚æ¬„ä½
    const normalized = headers.map(h=>h.trim()).filter(Boolean);
    const rest = normalized.filter(h=>h!=='åˆ†é¡');
    state.fields = rest;
    saveFields();
  }

  input.onchange=e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const name=(f.name||'').toLowerCase();
        let imported=[];
        if(name.endsWith('.csv') || name.endsWith('.txt')){
          const {headers, rows} = parseCSV(String(r.result||''));
          if(headers.length===0) throw new Error('CSV ç„¡æ¨™é¡Œåˆ—æˆ–æ ¼å¼éŒ¯èª¤');
          adoptFieldsFromHeaders(headers);
          imported = rows.map(row=>{
            // è§£æåˆ†é¡ï¼ˆä¸­æ–‡æˆ–è‹±æ–‡éƒ½å¯ï¼‰
            const catRaw = row['åˆ†é¡'] || row['category'] || row['Category'] || '';
            const mc = normalizeCategory(catRaw);
            const fields = {};
            state.fields.forEach(h=>{ fields[h] = row[h] ?? ''; });
            return { id:uid(), metaCategory:mc, fields, createdAt:Date.now(), isReviewed:false, reviewCount:0, lastReviewed:0, heart:0, wrongCount:0 };
          });
        }else{
          const arr=JSON.parse(r.result);
          if(!Array.isArray(arr)) throw new Error('JSON æ‡‰ç‚ºé™£åˆ—');
          // è‹¥ JSON çš„ç¬¬ä¸€ç­†æœ‰ keysï¼Œæ²¿ç”¨ç‚ºæ¬„ä½
          const first = arr[0]||{};
          const headers = Object.keys(first);
          // å˜—è©¦åµæ¸¬æ˜¯å¦åŒ…å«ã€Œåˆ†é¡ã€
          adoptFieldsFromHeaders(headers);
          imported = arr.map(obj=>{
            const catRaw = obj['åˆ†é¡'] || obj['category'] || obj['Category'] || obj.metaCategory || obj.category || '';
            const mc = normalizeCategory(catRaw);
            const fields={};
            state.fields.forEach(h=>{ fields[h] = obj[h] ?? (obj.fields?obj.fields[h]: ''); });
            return {
              id: obj.id||uid(),
              metaCategory: mc || obj.metaCategory || obj.category || 'Grammar',
              fields,
              createdAt: obj.createdAt||Date.now(),
              isReviewed: !!obj.isReviewed,
              reviewCount: obj.reviewCount||0,
              lastReviewed: obj.lastReviewed||0,
              heart: obj.heart||0,
              wrongCount: obj.wrongCount||0
            };
          });
        }

        // åˆä½µå»é‡ï¼ˆä»¥ ä¸»è¦éµï¼šåˆ†é¡ + ç¬¬ä¸€æ¬„ä½ + æ­£è§£/ä½ çš„ç­”æ¡ˆ ä»»ä¸€å¯ä½œ keyï¼›ç‚ºç°¡åŒ–ï¼Œç”¨ JSON å­—ä¸²ç•¶ keyï¼‰
        const key=o=>JSON.stringify([o.metaCategory, ...state.fields.map(k=>o.fields[k]||'')]);
        const map=new Map(state.data.map(o=>[key(o),o]));
        imported.forEach(o=>map.set(key(o), o));
        state.data=[...map.values()];
        saveLocal(); render();
        alert('åŒ¯å…¥å®Œæˆï¼Œå·²å¥—ç”¨æª”æ¡ˆæ¬„ä½åˆ°è¡¨å–®');
      }catch(err){
        console.error(err);
        alert('åŒ¯å…¥å¤±æ•—ï¼š'+err.message);
      }finally{
        input.value='';
      }
    };
    r.readAsText(f);
  };
})();

function normalizeCategory(raw){
  const s=String(raw||'').trim().toLowerCase();
  if(['æ–‡æ³•','grammar','g'].includes(s)) return 'Grammar';
  if(['ç‰‡èª','collocations','phrase','phrases','c'].includes(s)) return 'Collocations';
  if(['å–®å­—','vocab','vocabulary','word','words','v'].includes(s)) return 'Vocabulary';
  return state.cat; // è‹¥ç„¡æ³•åˆ¤æ–·ï¼Œæ²¿ç”¨ç›®å‰é ç±¤
}

/* ========= æ¬„ä½è¨­å®š ========= */
$('#btn-fields').onclick=()=>{
  $('#sheet-fields').classList.add('show');
  $('#fields-editor').value = (state.fields||[]).join('\n');
};
$('#fields-close').onclick=()=>$('#sheet-fields').classList.remove('show');
$('#fields-save').onclick=()=>{
  const lines = $('#fields-editor').value.split('\n').map(s=>s.trim()).filter(Boolean);
  state.fields = lines;
  saveFields();
  $('#sheet-fields').classList.remove('show');
  alert('å·²å„²å­˜æ¬„ä½è¨­å®š');
};

/* ========= äº‹ä»¶æ›è¼‰ ========= */
$('#tab-grammar').onclick=()=>{ state.cat='Grammar'; render(); };
$('#tab-collocations').onclick=()=>{ state.cat='Collocations'; render(); };
$('#tab-vocab').onclick=()=>{ state.cat='Vocabulary'; render(); };
$('#btn-quick').onclick =()=>setMode('list');
$('#btn-quiz').onclick  =()=>setMode('quiz');
$('#search').oninput    =()=>render();
$('#btn-add').onclick   =()=>openSheet();
$('#sheet-close').onclick=()=>closeSheet();
$('#btn-delete').onclick=()=>{ const id=$('#form').dataset.editId; if(id){ closeSheet(); delItem(id); } };

$('#form').onsubmit=(e)=>{
  e.preventDefault();
  const {metaCategory, fields} = collectForm();
  const id = $('#form').dataset.editId || uid();
  const existed=state.data.find(d=>d.id===id);
  const obj={
    id,
    metaCategory,
    fields,
    // èˆŠæ¬„ä½ç›¸å®¹ï¼ˆä¿ç•™ï¼Œä½†ä¸ä¸­æ–·ï¼‰
    question: existed?.question || '',
    wrongAnswer: existed?.wrongAnswer || '',
    correctAnswer: existed?.correctAnswer || '',
    correctOption: existed?.correctOption || '',
    subtopic: existed?.subtopic || '',
    analysis: existed?.analysis || '',
    mnemonic: existed?.mnemonic || '',
    tags: existed?.tags || [],
    createdAt: existed? existed.createdAt : Date.now(),
    isReviewed: existed? !!existed.isReviewed : false,
    reviewCount: existed? (existed.reviewCount||0) : 0,
    lastReviewed: existed? (existed.lastReviewed||0) : 0,
    heart: existed? (existed.heart||0) : 0,
    wrongCount: existed? (existed.wrongCount||0) : 0
  };
  upsertLocal(obj); closeSheet();
};

// è®“ openSheet çŸ¥é“ç›®å‰æ˜¯ç·¨è¼¯å“ªä¸€ç­†
function patchOpenSheetEditId(){
  const orig = openSheet;
  openSheet = function(it=null){
    $('#form').dataset.editId = it?.id || '';
    orig(it);
  }
}
patchOpenSheetEditId();

$('#stat-grammar').onclick=()=>showStat('grammar');
$('#stat-coll').onclick   =()=>showStat('coll');
$('#stat-vocab').onclick  =()=>showStat('vocab');

/* ========= Google Driveï¼ˆappDataFolderï¼‰ ========= */
// !!!! ä½¿ç”¨å‰è«‹æŠŠä¸‹é¢çš„ client id æ›æˆä½ çš„ !!!!
const GOOGLE_CLIENT_ID = '1067450972173-l1o4o3fl73f57mcm4rltj520h2ocio12.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/drive.appdata';
let tokenClient=null, accessToken=null, driveFileId=null;

function updateDriveStatus(isLogin){
  if(isLogin){
    $('#drive-status').innerHTML='âœ… å·²ç™»å…¥ Google';
    $('#btn-auth').textContent='ç™»å‡º';
    $('#btn-auth').onclick=signOut;
  }else{
    $('#drive-status').innerHTML='é›¢ç·šæ¨¡å¼ï¼ˆå°šæœªç™»å…¥ï¼‰';
    $('#btn-auth').textContent='Google ç™»å…¥';
    $('#btn-auth').onclick=authorize;
  }
}

// SDK onload å›å‘¼
function gapiLoaded(){
  gapi.load('client', async ()=>{
    await gapi.client.init({ discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
  });
}
function gisLoaded(){
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: SCOPES,
    callback: (resp)=>{
      if(resp && resp.access_token){
        accessToken = resp.access_token;
        gapi.client.setToken({access_token:accessToken});
        updateDriveStatus(true);
        findBackupFile();
      }else{
        updateDriveStatus(false);
      }
    }
  });
}

function authorize(){
  if(!tokenClient){ alert('Google ç™»å…¥å°šæœªå°±ç·’ï¼Œè«‹ç¨å¾Œå†è©¦'); return; }
  tokenClient.requestAccessToken({prompt:'consent'});
}

function signOut(){
  if(!accessToken){ return; }
  google.accounts.oauth2.revoke(accessToken, ()=>{});
  accessToken=null; driveFileId=null; gapi.client.setToken(null);
  updateDriveStatus(false);
}

async function findBackupFile(){
  try{
    const resp = await gapi.client.drive.files.list({
      spaces:'appDataFolder',
      q:"name='english_mistakes_v3.json'",
      fields:'files(id, name, modifiedTime)'
    });
    driveFileId = (resp.result.files && resp.result.files[0]?.id) || null;
  }catch(err){
    console.warn('åˆ—æª”å¤±æ•—', err);
  }
}

async function backupToDrive(){
  if(!accessToken){ alert('è«‹å…ˆ Google ç™»å…¥'); return; }
  $('#loading').classList.remove('hidden');
  try{
    const data = JSON.stringify({fields:state.fields, data:state.data}, null, 2);
    if(driveFileId){
      await gapi.client.request({
        path: `/upload/drive/v3/files/${driveFileId}`,
        method:'PATCH',
        params:{ uploadType:'media' },
        headers:{ 'Content-Type':'application/json' },
        body: data
      });
    }else{
      const meta = { name:'english_mistakes_v3.json', parents:['appDataFolder'] };
      const boundary='foo_bar_' + Math.random().toString(36).slice(2);
      const body =
        `--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n`+
        JSON.stringify(meta)+
        `\r\n--${boundary}\r\nContent-Type: application/json\r\n\r\n`+
        data+`\r\n--${boundary}--`;
      const res = await gapi.client.request({
        path:'/upload/drive/v3/files?uploadType=multipart',
        method:'POST',
        headers:{ 'Content-Type':`multipart/related; boundary=${boundary}` },
        body
      });
      driveFileId = res.result.id;
    }
    alert('âœ… å‚™ä»½æˆåŠŸ');
  }catch(err){
    console.error(err);
    alert('å‚™ä»½å¤±æ•—ï¼šè«‹åˆ° GCP å•Ÿç”¨ Google Drive APIï¼Œä¸¦æª¢æŸ¥ OAuth è¨­å®šï¼ˆä¾†æº/å°å‘ URIï¼‰ã€‚');
  }finally{ $('#loading').classList.add('hidden'); }
}

async function restoreFromDrive(){
  if(!accessToken){ alert('è«‹å…ˆ Google ç™»å…¥'); return; }
  if(!driveFileId){ await findBackupFile(); }
  if(!driveFileId){ alert('é›²ç«¯å°šç„¡å‚™ä»½ï¼Œè«‹å…ˆå‚™ä»½ä¸€æ¬¡'); return; }
  $('#loading').classList.remove('hidden');
  try{
    const res = await gapi.client.drive.files.get({ fileId:driveFileId, alt:'media' });
    const payload = res.result || {};
    // v3 å‚™ä»½æ ¼å¼ï¼š{ fields: [...], data: [...] }
    if(Array.isArray(payload.fields)) { state.fields = payload.fields; saveFields(); }
    if(Array.isArray(payload.data))   { state.data   = payload.data; }
    saveLocal(); render();
    alert('âœ… é‚„åŸæˆåŠŸ');
  }catch(err){
    console.error(err);
    alert('é‚„åŸå¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™æˆ–ç¶²è·¯');
  }finally{ $('#loading').classList.add('hidden'); }
}

// ç¶å®šä¸‰é¡†é›²ç«¯éµ
$('#btn-auth').onclick = authorize;
$('#btn-backup').onclick = backupToDrive;
$('#btn-restore').onclick= restoreFromDrive;

/* ========= å•Ÿå‹• ========= */
window.addEventListener('error', e=>{
  console.error(e.error||e.message);
  $('#loading').classList.add('hidden');
});

loadFields();
loadLocal();
render();
updateDriveStatus(false);

// å¦‚æœå¿«å–ä¸­ SDK å…ˆä¾†äº†ï¼Œå˜—è©¦è§¸ç™¼
if(typeof gapi!=='undefined'){ try{ gapiLoaded(); }catch{} }
if(typeof google!=='undefined'){ try{ gisLoaded(); }catch{} }
</script>
</body>
</html>
