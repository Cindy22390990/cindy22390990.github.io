<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ğŸ“’ è‹±æ–‡éŒ¯é¡Œæœ¬ï¼ˆDrive é›²ç«¯ï¼‰</title>
<meta name="theme-color" content="#2563eb" />
<link rel="manifest" href="manifest.json" />
<link rel="apple-touch-icon" href="icon-192.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800;900&display=swap" rel="stylesheet" />
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root{
    --blue:#2563eb;
    --blue-100:#eaf2ff;
    --slate:#0f172a;
    --safe-top:max(env(safe-area-inset-top),22px);
    --safe-side:max(env(safe-area-inset-left),16px);
  }
  html,body{height:100%}
  body{
    font-family:'Inter',system-ui,-apple-system,'SF Pro Text','PingFang TC','Noto Sans TC','Microsoft JhengHei',sans-serif;
    background:#f7f9fc;color:var(--slate);
  }
  .container-pad{padding-left:calc(var(--safe-side) + 16px);padding-right:calc(var(--safe-side) + 16px)}
  .safe-top{height:var(--safe-top)}
  .header{position:sticky;top:0;z-index:40;background:#fff;border-bottom:1px solid #e5e7eb;backdrop-filter:blur(6px)}
  .h-row{display:flex;gap:12px;flex-wrap:wrap;padding:10px 0 14px}
  .btn{border-radius:14px;font-weight:800;padding:.65rem 1rem;transition:.06s transform, .06s background, .06s color; background:#eef2f7; color:#334155}
  .btn:active{transform:scale(.98)}
  .btn-primary{background:#ffffff;border:1px solid #dbe3f5}
  .btn-blue{background:#eef4ff;color:var(--blue);border:1px solid #cfe0ff}
  .btn-active{background:var(--blue-100)!important;color:var(--blue)!important}
  .btn-ghost{background:#eef2f7;color:#334155}
  .btn-lg{min-height:52px}
  .pill{font-size:12px;border-radius:9999px;padding:.125rem .5rem}
  .badge{font-size:12px;background:#f1f5f9;color:#64748b;border-radius:10px;padding:.1rem .45rem}
  .card{background:#fff;border:1px solid #eef2f7;border-radius:16px;box-shadow:0 8px 18px rgba(15,23,42,.06)}
  .toolbar{padding:10px 0;background:#fff}
  .sticky-2{position:sticky;top:calc(var(--safe-top) + 74px);z-index:30;border-bottom:1px solid #e5e7eb}
  .tap{-webkit-tap-highlight-color:transparent}
  .hidden-hard{display:none!important}
  #loading{position:fixed;inset:0;background:rgba(255,255,255,.78);display:none;align-items:center;justify-content:center;z-index:100}
  #loading.show{display:flex}
  .fab{position:fixed;right:calc(var(--safe-side) + 18px);bottom:calc(env(safe-area-inset-bottom) + 18px);width:64px;height:64px;border-radius:9999px;background:var(--blue);color:#fff;font-size:34px;display:flex;align-items:center;justify-content:center;box-shadow:0 12px 28px rgba(37,99,235,.35);z-index:35}
  .sheet{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:end;z-index:50}
  .sheet.show{display:flex}
  .sheet-card{background:#fff;border-top-left-radius:18px;border-top-right-radius:18px;width:100%}
  .opt{display:flex;align-items:center;gap:10px;border:1px solid #e6eaf0;border-radius:12px;padding:14px 12px}
  .opt.active{border-color:var(--blue);background:#eef4ff;color:var(--blue)}
  .opt.correct{border-color:#16a34a;background:#ecfdf5}
  .opt.wrong{border-color:#dc2626;background:#fef2f2}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:88px;z-index:60;background:#111827;color:#fff;border-radius:9999px;padding:.5rem .9rem;font-size:14px;display:none}
  .toast.show{display:block}
</style>
</head>

<body class="min-h-screen flex flex-col">
  <div class="safe-top"></div>

  <!-- Headerï¼šé ç•™éˆå‹•å³¶å®‰å…¨å€ï¼ŒæŒ‰éˆ•ä¸æœƒå¤ªé ä¸Š -->
  <header class="header container-pad">
    <div style="padding-top:6px">
      <h1 class="text-2xl font-black leading-tight">ğŸ“’ è‹±æ–‡éŒ¯é¡Œæœ¬ <span class="text-slate-500 font-extrabold">ï¼ˆDrive é›²ç«¯ï¼‰</span></h1>
      <div id="drive-status" class="text-xs text-slate-500 mt-1">é›¢ç·šæ¨¡å¼ï¼ˆå°šæœªç™»å…¥ï¼‰</div>
      <div class="h-row">
        <button id="btn-auth" class="btn btn-blue btn-lg tap">Google ç™»å…¥</button>
        <button id="btn-backup" class="btn btn-primary btn-lg tap">å‚™ä»½</button>
        <button id="btn-restore" class="btn btn-primary btn-lg tap">é‚„åŸ</button>
      </div>
    </div>
  </header>

  <!-- å·¥å…·åˆ—ï¼šåŒ¯å…¥/åŒ¯å‡º + åˆ†é¡ + æœå°‹ -->
  <section class="toolbar sticky-2 container-pad">
    <div class="flex items-center gap-8 flex-wrap">
      <div class="flex items-center gap-8">
        <label class="btn btn-ghost tap">
          åŒ¯å…¥ï¼ˆæª”æ¡ˆï¼‰
          <input id="file-import" type="file" accept=".json" class="hidden" />
        </label>
        <button id="btn-export-file" class="btn btn-ghost tap">åŒ¯å‡ºï¼ˆæª”æ¡ˆï¼‰</button>
      </div>
    </div>

    <div class="mt-3 grid grid-cols-3 gap-3">
      <button id="tab-grammar" class="btn btn-ghost tap">ğŸ“ æ–‡æ³• <span id="count-grammar" class="badge ml-1">0</span></button>
      <button id="tab-collocations" class="btn btn-ghost tap">ğŸ”— ç‰‡èª <span id="count-coll" class="badge ml-1">0</span></button>
      <button id="tab-vocab" class="btn btn-ghost tap">ğŸ’¡ å–®å­— <span id="count-vocab" class="badge ml-1">0</span></button>
    </div>

    <div class="mt-3 grid grid-cols-[1fr_auto_auto] gap-2">
      <div class="relative">
        <input id="search" type="search" placeholder="æœå°‹é¡Œå¹¹/æ¨™ç±¤ï¼ˆex: ä»‹ç³»è© / scheduleï¼‰"
               class="w-full rounded-lg border border-gray-300 px-3 py-2 pl-9 focus:ring-2 focus:ring-blue-500 outline-none">
        <div class="absolute left-2 top-2.5 text-gray-400 select-none">ğŸ”</div>
      </div>
      <button id="btn-search" class="btn btn-primary tap">æœå°‹</button>
      <button id="btn-clear" class="btn btn-ghost tap">æ¸…é™¤</button>
    </div>

    <div class="mt-3 grid grid-cols-2 gap-3">
      <button id="mode-list" class="btn btn-ghost tap">ğŸ“‹ å¿«é€Ÿç¿»</button>
      <button id="mode-quiz" class="btn btn-ghost tap">â“ æ¸¬é©—</button>
    </div>
  </section>

  <!-- ä¸»å…§å®¹ -->
  <main class="flex-1">
    <div class="container-pad">
      <div class="max-w-xl mx-auto py-4 space-y-3" id="cards"></div>
      <div id="empty" class="hidden max-w-xl mx-auto py-16 text-center text-gray-500">
        ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œé»å³ä¸‹è§’ <b>ï¼‹</b> æ–°å¢ç¬¬ä¸€å¼µå¡ç‰‡æˆ–ç”¨ã€ŒåŒ¯å…¥ï¼ˆæª”æ¡ˆï¼‰ã€è¼‰å…¥ JSONã€‚
      </div>
    </div>
  </main>

  <!-- æ–°å¢æŒ‰éˆ• -->
  <button id="btn-add" class="fab tap" aria-label="æ–°å¢éŒ¯é¡Œ">ï¼‹</button>

  <!-- æ–°å¢/ç·¨è¼¯ Sheet -->
  <div id="sheet" class="sheet">
    <div class="sheet-card">
      <div class="container-pad" style="padding-top:12px;padding-bottom:12px">
        <div class="flex items-center justify-between">
          <h2 id="sheet-title" class="text-lg font-extrabold">æ–°å¢éŒ¯é¡Œ</h2>
          <button id="sheet-close" class="btn btn-ghost tap">é—œé–‰</button>
        </div>
      </div>
      <div class="container-pad" style="padding-bottom:calc(env(safe-area-inset-bottom) + 14px)">
        <form id="form" class="space-y-3">
          <input type="hidden" id="form-id" />
          <div>
            <label class="text-sm text-gray-700">åˆ†é¡</label>
            <select id="form-category" required class="w-full border rounded-lg px-3 py-2">
              <option value="Grammar">æ–‡æ³• (Grammar)</option>
              <option value="Collocations">ç‰‡èª (Collocations)</option>
              <option value="Vocabulary">å–®å­— (Vocabulary)</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-gray-700">å­åˆ†é¡ï¼ˆå¯é¸ï¼‰</label>
            <input id="form-subcat" class="w-full border rounded-lg px-3 py-2" placeholder="ä»‹ç³»è© / æ™‚æ…‹ / è©æ€§é¸æ“‡ â€¦">
          </div>
          <div>
            <label class="text-sm text-gray-700">é¡Œå¹¹</label>
            <textarea id="form-question" required rows="2" class="w-full border rounded-lg px-3 py-2" placeholder="è¼¸å…¥é¡Œç›®æ–‡å­—"></textarea>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-sm text-gray-700">âŒ ä½ çš„ç­”æ¡ˆï¼ˆæˆ–éŒ¯èª¤ç­”æ¡ˆï¼‰</label>
              <input id="form-wrong" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label class="text-sm text-gray-700">âœ… æ­£ç¢ºç­”æ¡ˆï¼ˆæ–‡å­—ï¼‰</label>
              <input id="form-correct" class="w-full border rounded-lg px-3 py-2">
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-sm text-gray-700">æ­£è§£é¸é …ï¼ˆA/B/C/Dï¼Œå¯ç©ºï¼‰</label>
              <input id="form-correct-letter" class="w-full border rounded-lg px-3 py-2" maxlength="1" placeholder="A / B / C / D">
            </div>
            <div>
              <label class="text-sm text-gray-700">é¸é …ï¼ˆä»¥ ï¼›åˆ†éš”ï¼Œå¯ç©ºï¼‰</label>
              <input id="form-options" class="w-full border rounded-lg px-3 py-2" placeholder="Aé¸é …ï¼›Bé¸é …ï¼›Cé¸é …ï¼›Dé¸é …">
            </div>
          </div>

          <div>
            <label class="text-sm text-gray-700">ğŸ” éŒ¯å› åˆ†æ</label>
            <textarea id="form-analysis" rows="2" class="w-full border rounded-lg px-3 py-2"></textarea>
          </div>
          <div>
            <label class="text-sm text-gray-700">ğŸ¯ è¨˜æ†¶å£è¨£/å°æŠ€å·§</label>
            <textarea id="form-mnemonic" rows="2" class="w-full border rounded-lg px-3 py-2"></textarea>
          </div>
          <div>
            <label class="text-sm text-gray-700">æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
            <input id="form-tags" class="w-full border rounded-lg px-3 py-2" placeholder="ä»‹ç³»è©, TOEIC, Part5">
          </div>
          <div class="flex items-center justify-between pt-2">
            <button type="button" id="btn-delete" class="text-red-600 tap hidden">åˆªé™¤</button>
            <button class="btn btn-blue tap" type="submit">å„²å­˜</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast & Loading -->
  <div id="toast" class="toast">æç¤º</div>
  <div id="loading"><div class="text-center">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-2"></div>
    <p class="text-gray-700">åŒæ­¥ä¸­...</p></div>
  </div>

<script>
/* ====================== åŸºç¤å·¥å…· ====================== */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const toast=(msg,dur=1500)=>{ const el=$("#toast"); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),dur); };

const LS_KEY='eng_error_cards_v4';
const state={ cat:null, mode:null, data:[], filtered:[] };

/* ====================== ç‰ˆé¢äº’å‹•ï¼ˆæŒ‰éˆ•è—å­—ï¼‰ ====================== */
function setActive(btn, active){
  btn.classList.toggle('btn-active', !!active);
}
function setGroupActive(btns, activeBtn){
  btns.forEach(b=>setActive(b, b===activeBtn));
}

/* ====================== æ¸²æŸ“é‚è¼¯ ====================== */
function renderTabs(){
  const counts={
    Grammar: state.data.filter(d=>d.category==='Grammar').length,
    Collocations: state.data.filter(d=>d.category==='Collocations').length,
    Vocabulary: state.data.filter(d=>d.category==='Vocabulary').length,
  };
  $("#count-grammar").textContent = counts.Grammar;
  $("#count-coll").textContent    = counts.Collocations;
  $("#count-vocab").textContent   = counts.Vocabulary;

  setActive($("#tab-grammar"), state.cat==='Grammar');
  setActive($("#tab-collocations"), state.cat==='Collocations');
  setActive($("#tab-vocab"), state.cat==='Vocabulary');
}

function computeFiltered(){
  const q=$("#search").value.trim().toLowerCase();
  let arr=state.data;
  if(state.cat) arr=arr.filter(d=>d.category===state.cat);
  if(q){
    arr=arr.filter(d=>{
      const blob=[d.question,d.wrongAnswer,d.correctAnswer,d.analysis,d.mnemonic,(d.tags||[]).join(','),d.subCategory].join(' ').toLowerCase();
      return blob.includes(q);
    });
  }
  // å¿«é€Ÿç¿»ï¼šæŒ‰å»ºç«‹æ™‚é–“å€’åº
  if(state.mode==='list'){ arr.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)); }
  // æ¸¬é©—ï¼šéŒ¯é¡Œå„ªå…ˆï¼ˆfailCount é«˜è€…åœ¨å‰ï¼‰
  if(state.mode==='quiz'){ arr.sort((a,b)=>(b.failCount||0)-(a.failCount||0)); }

  state.filtered = arr;
}

function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }

function cardEl(it){
  const el=document.createElement('div');
  el.className='card p-4 tap';
  const categoryMap={'Grammar':'ğŸ“ æ–‡æ³•','Collocations':'ğŸ”— ç‰‡èª','Vocabulary':'ğŸ’¡ å–®å­—'};
  const created = new Date(it.createdAt||Date.now()).toLocaleDateString('zh-TW');

  // é¸é …ï¼ˆABCDï¼‰
  const opts = Array.isArray(it.options)? it.options : [];
  const hasOptions = opts.length===4;

  el.innerHTML = `
    <div class="flex items-center justify-between mb-2">
      <div class="text-sm font-semibold text-blue-700">${categoryMap[it.category]||'ğŸ“„'} ${it.subCategory?`<span class="pill bg-blue-50 text-blue-700 ml-2">${escapeHTML(it.subCategory)}</span>`:''}</div>
      <div class="text-xs text-gray-400">${created} <span class="pill bg-red-100 text-red-600 ml-2">éŒ¯ ${it.failCount||0} æ¬¡</span></div>
    </div>
    <h3 class="font-bold text-gray-900 mb-2">${escapeHTML(it.question||'')}</h3>
    <div class="flex flex-wrap gap-1 mb-2">${(it.tags||[]).map(t=>`<span class="pill bg-gray-100 text-gray-600">#${escapeHTML(t)}</span>`).join('')}</div>

    ${state.mode==='quiz' && hasOptions ? `
      <div class="space-y-2" data-quiz="${it.id}">
        ${opts.map((o,idx)=>`<button class="opt w-full text-left" data-choice="${'ABCD'[idx]}"><b>${'ABCD'[idx]}.</b> <span>${escapeHTML(o)}</span></button>`).join('')}
      </div>
      <div class="mt-3 hidden" id="qa-${it.id}">
        <div class="p-2 bg-green-50 border border-green-200 rounded-lg text-sm"><b class="text-green-700">âœ… æ­£è§£</b>ï¼š${escapeHTML(it.correctAnswer||'')} ${it.correctLetter?`ï¼ˆ${it.correctLetter}ï¼‰`:''}</div>
        ${it.analysis?`<div class="mt-2 p-3 bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg text-sm"><div class="font-semibold text-yellow-800 mb-1">ğŸ” éŒ¯å› åˆ†æ</div><div class="text-gray-800">${escapeHTML(it.analysis||'â€”')}</div></div>`:''}
        ${it.mnemonic?`<div class="mt-2 p-3 bg-indigo-50 border-l-4 border-indigo-500 rounded-r-lg text-sm"><div class="font-semibold text-indigo-800 mb-1">ğŸ¯ è¨˜æ†¶å£è¨£/å°æŠ€å·§</div><div class="text-gray-800">${escapeHTML(it.mnemonic||'â€”')}</div></div>`:''}
      </div>
    ` : `
      <div class="${state.mode==='quiz'?'hidden':''}">
        <div class="grid grid-cols-2 gap-2 text-sm">
          <div class="p-2 bg-red-50 border border-red-200 rounded-lg"><b class="text-red-600">âŒ</b> ${escapeHTML(it.wrongAnswer||'')}</div>
          <div class="p-2 bg-green-50 border border-green-200 rounded-lg"><b class="text-green-600">âœ…</b> ${escapeHTML(it.correctAnswer||'')}</div>
        </div>
        ${it.analysis?`<div class="mt-2 p-3 bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg text-sm"><div class="font-semibold text-yellow-800 mb-1">ğŸ” éŒ¯å› åˆ†æ</div><div class="text-gray-800">${escapeHTML(it.analysis||'â€”')}</div></div>`:''}
        ${it.mnemonic?`<div class="mt-2 p-3 bg-indigo-50 border-l-4 border-indigo-500 rounded-r-lg text-sm"><div class="font-semibold text-indigo-800 mb-1">ğŸ¯ è¨˜æ†¶å£è¨£/å°æŠ€å·§</div><div class="text-gray-800">${escapeHTML(it.mnemonic||'â€”')}</div></div>`:''}
      </div>
      ${state.mode!=='quiz' ? `<button class="btn btn-blue w-full mt-3 js-show tap">é¡¯ç¤ºç­”æ¡ˆ</button>`:''}
    `}

    <div class="flex justify-end gap-2 mt-3">
      <button class="btn btn-ghost text-sm js-edit tap">ç·¨è¼¯</button>
      <button class="btn btn-ghost text-sm text-red-600 js-del tap">åˆªé™¤</button>
      <button class="btn btn-ghost text-sm ${it.isReviewed?'btn-active':''} js-review tap">${it.isReviewed?'âœ… å·²è¤‡ç¿’':'ğŸ”„ æ¨™è¨˜å·²è¤‡ç¿’'}</button>
    </div>
  `;

  // è¡Œç‚ºï¼šé¡¯ç¤ºç­”æ¡ˆï¼ˆåˆ—è¡¨æ¨¡å¼ï¼‰
  el.querySelector('.js-show')?.addEventListener('click',(e)=>{
    const btn=e.currentTarget;
    btn.previousElementSibling.classList.remove('hidden');
    btn.remove();
  });

  // è¡Œç‚ºï¼šæ¸¬é©—é»é¸ ABCD
  if(state.mode==='quiz' && el.querySelector(`[data-quiz="${it.id}"]`)){
    const quizBox = el.querySelector(`[data-quiz="${it.id}"]`);
    quizBox.querySelectorAll('.opt').forEach(opt=>{
      opt.addEventListener('click', ()=>{
        const choice = opt.getAttribute('data-choice');
        // æ¨£å¼
        quizBox.querySelectorAll('.opt').forEach(o=>o.classList.remove('active','correct','wrong'));
        opt.classList.add('active');

        const isCorrect = (it.correctLetter && it.correctLetter.toUpperCase()===choice.toUpperCase());
        if(isCorrect){ opt.classList.add('correct'); changeFailCount(it.id, -1); toast('ç­”å°äº†ï¼â¤ï¸ æ¸›å°‘éŒ¯èª¤æ¬¡æ•¸'); }
        else { opt.classList.add('wrong'); changeFailCount(it.id, +1); toast('ç­”éŒ¯äº†ï¼Œå·²+1 è¨˜éŒ„'); }
        // é¡¯ç¤ºè§£æ
        $(`#qa-${it.id}`)?.classList.remove('hidden');
      });
    });
  }

  // ç·¨è¼¯/åˆªé™¤/è¤‡ç¿’
  el.querySelector('.js-edit').onclick=()=>openSheet(it);
  el.querySelector('.js-del').onclick=()=>delItem(it.id);
  el.querySelector('.js-review').onclick=()=>markReviewed(it.id, !it.isReviewed);

  return el;
}

function render(){
  renderTabs();
  computeFiltered();
  const host=$("#cards"); host.innerHTML='';
  if(state.filtered.length===0){ $("#empty").classList.remove('hidden'); }
  else { $("#empty").classList.add('hidden'); state.filtered.forEach(it=>host.appendChild(cardEl(it))); }
}

/* ====================== è³‡æ–™ CRUD ====================== */
function loadLocal(){ try{ state.data=JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ state.data=[]; } }
function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(state.data)); }

function upsertLocal(obj){
  const idx=state.data.findIndex(d=>d.id===obj.id);
  if(idx>=0) state.data[idx]=obj; else state.data.unshift(obj);
  saveLocal(); render(); toast('å·²å„²å­˜');
}

function delItem(id){
  if(!confirm('ç¢ºå®šåˆªé™¤é€™å¼µå¡ç‰‡ï¼Ÿ')) return;
  const idx=state.data.findIndex(d=>d.id===id);
  if(idx>=0){ state.data.splice(idx,1); saveLocal(); render(); toast('å·²åˆªé™¤'); }
}

function markReviewed(id, flag){
  const it=state.data.find(d=>d.id===id); if(!it) return;
  it.isReviewed=!!flag;
  if(flag){ it.reviewCount=(it.reviewCount||0)+1; it.lastReviewed=Date.now(); }
  saveLocal(); render();
}

function changeFailCount(id, delta){
  const it=state.data.find(d=>d.id===id); if(!it) return;
  it.failCount=Math.max(0,(it.failCount||0)+delta);
  saveLocal();
}

/* ====================== æ–°å¢/ç·¨è¼¯ Sheet ====================== */
function openSheet(it=null){
  $("#sheet").classList.add('show');
  $("#sheet-title").textContent = it?'ç·¨è¼¯éŒ¯é¡Œ':'æ–°å¢éŒ¯é¡Œ';
  $("#btn-delete").classList.toggle('hidden', !it);

  $("#form-id").value = it?.id || '';
  $("#form-category").value = it?.category || (state.cat || 'Grammar');
  $("#form-subcat").value = it?.subCategory || '';
  $("#form-question").value = it?.question || '';
  $("#form-wrong").value = it?.wrongAnswer || '';
  $("#form-correct").value = it?.correctAnswer || '';
  $("#form-correct-letter").value = it?.correctLetter || '';
  $("#form-options").value = (it?.options||[]).join('ï¼›');
  $("#form-analysis").value = it?.analysis || '';
  $("#form-mnemonic").value = it?.mnemonic || '';
  $("#form-tags").value = (it?.tags||[]).join(', ');
}
function closeSheet(){ $("#sheet").classList.remove('show'); }

$("#sheet-close").onclick=()=>closeSheet();
$("#btn-delete").onclick=()=>{
  const id=$("#form-id").value; if(id){ closeSheet(); delItem(id); }
};

$("#form").onsubmit=(e)=>{
  e.preventDefault();
  const id = $("#form-id").value || uid();
  const existed = state.data.find(d=>d.id===id);
  const obj = {
    id,
    category: $("#form-category").value,
    subCategory: $("#form-subcat").value.trim(),
    question: $("#form-question").value.trim(),
    wrongAnswer: $("#form-wrong").value.trim(),
    correctAnswer: $("#form-correct").value.trim(),
    correctLetter: ($("#form-correct-letter").value||'').toUpperCase(),
    options: ($("#form-options").value||'').split('ï¼›').map(s=>s.trim()).filter(Boolean).slice(0,4),
    analysis: $("#form-analysis").value.trim(),
    mnemonic: $("#form-mnemonic").value.trim(),
    tags: $("#form-tags").value.split(',').map(s=>s.trim()).filter(Boolean),
    createdAt: existed?.createdAt || Date.now(),
    isReviewed: existed?.isReviewed || false,
    reviewCount: existed?.reviewCount || 0,
    lastReviewed: existed?.lastReviewed || 0,
    failCount: existed?.failCount || 0
  };
  upsertLocal(obj); closeSheet();
};

/* ====================== åŒ¯å…¥ / åŒ¯å‡º ====================== */
function normalizeCategory(v){
  if(!v) return 'Grammar';
  if(/æ–‡æ³•|grammar/i.test(v)) return 'Grammar';
  if(/ç‰‡èª|colloc/i.test(v)) return 'Collocations';
  if(/å–®å­—|vocab/i.test(v)) return 'Vocabulary';
  return 'Grammar';
}
function parseImportArray(arr){
  // æ”¯æ´ä½ çš„ JSON æ¬„ä½ï¼ˆä¸­æ–‡ keyï¼‰
  return arr.map((o)=>{
    const id = uid();
    const category = normalizeCategory(o['åˆ†é¡'] || o.category);
    const question = o['é¡Œå¹¹'] || o.question || '';
    const userAns = o['ä½ çš„ç­”æ¡ˆ'] || o.wrongAnswer || '';
    const correct = o['æ­£ç¢ºç­”æ¡ˆ'] || o.correctAnswer || '';
    const correctLetter = (o['æ­£è§£é¸é …'] || o.correctLetter || '').toString().trim().toUpperCase();
    const subCategory = o['å­åˆ†é¡'] || o.subCategory || '';
    const analysis = o['éŒ¯å› åˆ†æ'] || o.analysis || '';
    const mnemonic = o['è¨˜æ†¶å£è¨£'] || o.mnemonic || '';
    const tags = (o['æ¨™ç±¤'] || o.tags || '').toString().split(/[,ï¼Œ]/).map(s=>s.trim()).filter(Boolean);
    // è‹¥åŸå§‹æª”æ²’æœ‰é¸é …ï¼Œçµ¦ç©ºé™£åˆ—ï¼ˆä¸å½±éŸ¿å¿«é€Ÿç¿»ï¼›æ¸¬é©—åƒ…åœ¨æœ‰å››å€‹é¸é …æ™‚å•Ÿç”¨ ABCDï¼‰
    const options = Array.isArray(o.options) ? o.options
                   : (o['é¸é …'] ? o['é¸é …'].toString().split(/[;ï¼›]/).map(s=>s.trim()).filter(Boolean) : []);
    return {
      id, category, subCategory,
      question, wrongAnswer:userAns, correctAnswer:correct,
      correctLetter,
      options: options.slice(0,4),
      analysis, mnemonic, tags,
      createdAt: Date.now(), isReviewed:false, reviewCount:0, lastReviewed:0, failCount:0,
      extra:o
    };
  });
}

$("#file-import").onchange=(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const json=JSON.parse(r.result);
      if(!Array.isArray(json)) throw new Error('åŒ¯å…¥æª”ä¸æ˜¯é™£åˆ—');
      const parsed = parseImportArray(json);
      // åˆä½µï¼šä»¥ question + correctAnswer ç•¶éµå»é‡
      const key=o=>(o.question||'')+'|'+(o.correctAnswer||'');
      const map = new Map(state.data.map(o=>[key(o),o]));
      parsed.forEach(o=>map.set(key(o), o));
      state.data = Array.from(map.values()).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      saveLocal(); render();
      toast(`âœ… åŒ¯å…¥æˆåŠŸï¼Œå…± ${parsed.length} ç­†`);
    }catch(err){
      console.error(err); toast('âŒ åŒ¯å…¥å¤±æ•—ï¼šæ ¼å¼éŒ¯èª¤æˆ–å…§å®¹ç„¡æ³•è§£æ');
    }
  };
  r.readAsText(f);
  e.target.value='';
};

$("#btn-export-file").onclick=()=>{
  const data=JSON.stringify(state.data,null,2);
  const url=URL.createObjectURL(new Blob([data],{type:'application/json'}));
  const a=Object.assign(document.createElement('a'),{href:url,download:`english-mistakes-${Date.now()}.json`});
  document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),500);
  toast('å·²åŒ¯å‡ºï¼ˆæœ¬æ©Ÿæª”æ¡ˆï¼‰');
};

/* ====================== åˆ†é¡/æ¨¡å¼/æœå°‹ ====================== */
function requireCategoryBeforeMode(){
  if(!state.cat){
    alert('è«‹å…ˆé¸æ“‡è¦ã€Œå¿«é€Ÿç¿» / æ¸¬é©—ã€çš„ç¯„åœï¼šæ–‡æ³• / ç‰‡èª / å–®å­—');
    return false;
  }
  return true;
}

$("#tab-grammar").onclick=()=>{ state.cat='Grammar'; renderTabs(); render(); };
$("#tab-collocations").onclick=()=>{ state.cat='Collocations'; renderTabs(); render(); };
$("#tab-vocab").onclick=()=>{ state.cat='Vocabulary'; renderTabs(); render(); };

$("#mode-list").onclick=()=>{
  if(!requireCategoryBeforeMode()) return;
  state.mode='list';
  setGroupActive([$("#mode-list"), $("#mode-quiz")], $("#mode-list"));
  render();
};
$("#mode-quiz").onclick=()=>{
  if(!requireCategoryBeforeMode()) return;
  state.mode='quiz';
  setGroupActive([$("#mode-list"), $("#mode-quiz")], $("#mode-quiz"));
  render();
};

$("#btn-search").onclick=()=>render();
$("#btn-clear").onclick=()=>{ $("#search").value=''; render(); };
$("#search").addEventListener('input', ()=>render());  // åŒæ™‚æ”¯æ´å³æ™‚éæ¿¾

/* ====================== æ–°å¢æŒ‰éˆ• ====================== */
$("#btn-add").onclick=()=>openSheet();

/* ====================== Google Driveï¼ˆå¯é¸ï¼‰ ====================== */
const GOOGLE_CLIENT_ID='1067450972173-l1o4o3fl73f57mcm4rltj520h2ocio12.apps.googleusercontent.com'; // â†â† æ”¹æˆä½ çš„
const SCOPES='https://www.googleapis.com/auth/drive.appdata';
let tokenClient=null,accessToken=null,driveFileId=null;

function updateDriveStatus(isLogin){
  $("#drive-status").innerHTML = isLogin ? 'âœ… å·²ç™»å…¥ Google' : 'é›¢ç·šæ¨¡å¼ï¼ˆå°šæœªç™»å…¥ï¼‰';
  $("#btn-auth").textContent = isLogin ? 'ç™»å‡º' : 'Google ç™»å…¥';
  setActive($("#btn-auth"), isLogin);
}

async function gapiInit(){
  return new Promise(resolve=>{
    gapi.load('client', async()=>{
      await gapi.client.init({ discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
      resolve();
    });
  });
}
function gisInit(){
  tokenClient=google.accounts.oauth2.initTokenClient({
    client_id:GOOGLE_CLIENT_ID,
    scope:SCOPES,
    callback:(r)=>{
      if(r && r.access_token){
        accessToken=r.access_token;
        gapi.client.setToken({access_token});
        updateDriveStatus(true);
        findBackupFile();
      }else{
        updateDriveStatus(false);
      }
    }
  });
}
async function ensureSdkReady(){
  if(typeof gapi==='undefined' || typeof google==='undefined'){ toast('Google æœå‹™è¼‰å…¥ä¸­â€¦è«‹ç¨å¾Œå†è©¦'); return false; }
  if(!gapi.client?.drive) await gapiInit();
  if(!tokenClient) gisInit();
  return true;
}
async function authorize(){ if(await ensureSdkReady()) tokenClient?.requestAccessToken({prompt:'consent'}); }
function signOut(){
  if(!accessToken) return;
  google.accounts.oauth2.revoke(accessToken,()=>{});
  accessToken=null; driveFileId=null; gapi.client.setToken(null);
  updateDriveStatus(false);
}
async function findBackupFile(){
  try{
    const resp=await gapi.client.drive.files.list({
      spaces:'appDataFolder', q:"name='english_mistakes_v2.json'", fields:'files(id, modifiedTime)'
    });
    driveFileId=(resp.result.files && resp.result.files[0]?.id) || null;
  }catch(e){ console.warn('åˆ—æª”å¤±æ•—',e); }
}
async function backupToDrive(){
  if(!accessToken){ alert('è«‹å…ˆ Google ç™»å…¥'); return; }
  $("#loading").classList.add('show');
  try{
    const data=JSON.stringify(state.data||[],null,2);
    if(driveFileId){
      await gapi.client.request({
        path:`/upload/drive/v3/files/${driveFileId}`,
        method:'PATCH',
        params:{uploadType:'media'},
        headers:{'Content-Type':'application/json'},
        body:data
      });
    }else{
      const meta={ name:'english_mistakes_v2.json', parents:['appDataFolder'] };
      const boundary='foo_bar_'+Math.random().toString(36).slice(2);
      const body=`--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify(meta)}\r\n--${boundary}\r\nContent-Type: application/json\r\n\r\n${data}\r\n--${boundary}--`;
      const res=await gapi.client.request({
        path:'/upload/drive/v3/files?uploadType=multipart',
        method:'POST',
        headers:{'Content-Type':`multipart/related; boundary=${boundary}`},
        body
      });
      driveFileId=res.result.id;
    }
    alert('âœ… å‚™ä»½æˆåŠŸ');
  }catch(e){
    console.error(e);
    alert('å‚™ä»½å¤±æ•—ï¼šè«‹ç¢ºèªå·²å•Ÿç”¨ Drive API ä¸¦æ–¼ OAuth çš„ Authorized JavaScript origins åŠ å…¥ä½ çš„ GitHub Pages ç¶²åŸŸã€‚');
  }finally{ $("#loading").classList.remove('show'); }
}
async function restoreFromDrive(){
  if(!accessToken){ alert('è«‹å…ˆ Google ç™»å…¥'); return; }
  if(!driveFileId){ await findBackupFile(); }
  if(!driveFileId){ alert('é›²ç«¯å°šç„¡å‚™ä»½ï¼Œè«‹å…ˆå‚™ä»½ä¸€æ¬¡'); return; }
  $("#loading").classList.add('show');
  try{
    const res=await gapi.client.drive.files.get({ fileId:driveFileId, alt:'media' });
    const arr=Array.isArray(res.result)?res.result:[];
    // é˜²å®ˆè£œé½Šæ¬„ä½
    state.data=(arr||[]).map(o=>({...o, options:Array.isArray(o.options)?o.options:[], extra:o.extra||{} }));
    saveLocal(); render();
    alert('âœ… é‚„åŸæˆåŠŸ');
  }catch(e){
    console.error(e);
    alert('é‚„åŸå¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™æˆ–ç¶²è·¯');
  }finally{ $("#loading").classList.remove('show'); }
}
$("#btn-auth").onclick=()=>{ if(accessToken) signOut(); else authorize(); };
$("#btn-backup").onclick=backupToDrive;
$("#btn-restore").onclick=restoreFromDrive;

/* ====================== å•Ÿå‹• ====================== */
window.addEventListener('error', e=>{ console.error(e.error||e.message); $("#loading").classList.remove('show'); });

loadLocal();
render();           // åˆå§‹æ¸²æŸ“
updateDriveStatus(false); // åˆå§‹ç‚ºæœªç™»å…¥

// è‹¥ SDK å·²å…ˆè¼‰å…¥ï¼Œè£œåˆå§‹åŒ–
if(typeof gapi!=='undefined'){ gapiInit(); }
if(typeof google!=='undefined'){ gisInit(); }

</script>
</body>
</html>
