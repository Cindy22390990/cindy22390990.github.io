<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ğŸ“’ è‹±æ–‡éŒ¯é¡Œæœ¬ï¼ˆDrive é›²ç«¯ï¼‰</title>

  <!-- PWAï¼ˆå¯ç•™å¯åˆªï¼‰ -->
  <meta name="theme-color" content="#2563eb" />
  <link rel="manifest" href="manifest.json" />

  <!-- iOS å®‰å…¨å€ + åœ–ç¤ºï¼ˆå¯ç•™å¯åˆªï¼‰ -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <!-- å­—é«” / Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google APIs -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <style>
    :root { --primary:#2563eb; }
    html, body { height:100%; }
    body { font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans TC', 'PingFang TC', 'Microsoft JhengHei', sans-serif; background:#f6f7fb; }
    .card { background:#fff; border:1px solid #eef0f4; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .btn { user-select:none; -webkit-tap-highlight-color:transparent; border-radius:16px; font-weight:800; padding:.9rem 1.1rem; }
    .btn:active { transform:scale(.98); }
    .btn-primary { background:var(--primary); color:#fff; }
    .btn-ghost { background:#eef2f7; color:#1f2937; }
    .btn-danger { background:#ef4444; color:#fff; }
    .chip { padding:.25rem .6rem; border-radius:9999px; font-size:.8rem; font-weight:700; }
    .safe-bottom { padding-bottom: max(env(safe-area-inset-bottom), 18px); }
    .disabled { opacity:.45; pointer-events:none; }
    .tapfix { min-height:48px; } /* æé«˜å¯é»æ“Šé«˜åº¦ */

    /* è¡¨å–®æŠ½å±œï¼ˆsheetï¼‰ */
    #sheet { position:fixed; inset:0; display:none; align-items:flex-end; background:rgba(0,0,0,.35); z-index:60; }
    #sheet .panel { width:100%; max-width:680px; margin:0 auto; border-radius:20px 20px 0 0; }
    /* é—œé–‰éµï¼šæ”¾åœ¨å³ä¸Šä½†åŠ å¤§ç†±å€ï¼ŒåŒæ™‚åœ¨åº•éƒ¨ä¹Ÿæä¾›ä¸€å€‹æ˜é¡¯é—œé–‰éµ */
    .close-hit { position:absolute; right:12px; top:12px; width:44px; height:44px; display:flex; align-items:center; justify-content:center; border-radius:12px; background:#f1f5f9; }
    #sheet-close-bottom { width:100%; padding:14px 0; }

    /* Loading é®ç½© */
    #loading { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(255,255,255,.75); backdrop-filter:saturate(160%) blur(2px); z-index:80; }
    .spin { width:48px; height:48px; border-radius:9999px; border:4px solid #cfe0ff; border-top-color:var(--primary); animation:sp 1s linear infinite; }
    @keyframes sp { to { transform:rotate(360deg); } }

    /* æ¸¬é©—é¸é …æ¨£å¼ */
    .opt { display:flex; align-items:center; gap:.9rem; padding:14px 16px; border-radius:14px; border:1px solid #ebeff5; background:#f9fafb; font-weight:800; }
    .opt .badge { width:32px; height:32px; border-radius:9999px; display:flex; align-items:center; justify-content:center; background:#e5edff; color:#1e3a8a; }
    .opt.correct { background:#ecfdf5; border-color:#34d399; }
    .opt.wrong   { background:#fef2f2; border-color:#f87171; }
    .opt.chosen  { outline:2px solid var(--primary); }

    /* è®“é ‚éƒ¨å¤§å¡åœ¨ iPhone 15PM ä¹Ÿæ˜“æŒ‰ */
    .headbtn { width:152px; max-width:42vw; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- é ‚éƒ¨ï¼šæ¨™é¡Œ + Google/å‚™ä»½/é‚„åŸ -->
  <header class="bg-white/90 backdrop-blur sticky top-0 z-50 border-b border-slate-200">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-start justify-between gap-3">
      <div class="leading-tight">
        <div class="text-xs text-slate-400">ENG Error Notebook</div>
        <h1 class="text-[22px] font-extrabold text-slate-900">ğŸ“’ è‹±æ–‡éŒ¯é¡Œæœ¬ <span class="text-slate-400">(Drive é›²ç«¯)</span></h1>
        <div id="status" class="text-xs mt-1 text-slate-500">é›¢ç·šæ¨¡å¼ï¼ˆå°šæœªç™»å…¥ï¼‰</div>
      </div>
      <div class="flex items-stretch gap-2">
        <button id="btn-auth"   class="btn btn-primary headbtn tapfix">Google ç™»å…¥</button>
        <button id="btn-backup" class="btn btn-ghost headbtn tapfix disabled">å‚™ä»½</button>
        <button id="btn-restore" class="btn btn-ghost headbtn tapfix disabled">é‚„åŸ</button>
      </div>
    </div>
  </header>

  <!-- æ¬¡åˆ—ï¼šåŒ¯å…¥(æª”æ¡ˆ) -->
  <nav class="bg-white">
    <div class="max-w-3xl mx-auto px-4 py-2 flex items-center gap-2">
      <label class="btn btn-ghost tapfix">
        åŒ¯å…¥ï¼ˆæª”æ¡ˆï¼‰
        <input id="file-import" type="file" accept="application/json" class="hidden" />
      </label>
      <div class="text-xs text-slate-400">æˆ–åœ¨ä¸Šæ–¹ä»¥ Drive é€²è¡Œå‚™ä»½ / é‚„åŸ</div>
    </div>
  </nav>

  <!-- åˆ†é¡ Tabs -->
  <nav class="bg-white border-y border-slate-200 sticky top-[76px] z-40">
    <div class="max-w-3xl mx-auto px-4 py-2 grid grid-cols-3 gap-2">
      <button class="tab btn btn-ghost" data-cat="Grammar">ğŸ“ æ–‡æ³• <span class="count text-slate-400"></span></button>
      <button class="tab btn btn-ghost" data-cat="Collocations">ğŸ”— ç‰‡èª <span class="count text-slate-400"></span></button>
      <button class="tab btn btn-ghost" data-cat="Vocabulary">ğŸ’¡ å–®å­— <span class="count text-slate-400"></span></button>
    </div>
    <div class="max-w-3xl mx-auto px-4 pb-2 flex items-center gap-2">
      <div class="flex-1 relative">
        <input id="search" class="w-full border border-slate-300 rounded-xl px-3 py-2 pl-8 outline-none focus:ring-2 focus:ring-blue-500" placeholder="æœå°‹é¡Œå¹¹/æ¨™ç±¤ï¼ˆex: ä»‹ç³»è© / scheduleï¼‰" />
        <span class="absolute left-2 top-2.5 text-slate-400">ğŸ”</span>
      </div>
      <button id="btn-quick" class="btn btn-ghost tapfix">ğŸ—‚ï¸ å¿«é€Ÿç¿»</button>
      <button id="btn-quiz" class="btn btn-ghost tapfix">â“ æ¸¬é©—</button>
    </div>
  </nav>

  <!-- å¸¸éŒ¯çµ±è¨ˆ -->
  <section class="bg-white">
    <div class="max-w-3xl mx-auto px-4 py-2 flex items-center gap-3">
      <div class="text-[13px]">ğŸ“ˆ å¸¸éŒ¯çµ±è¨ˆï¼š</div>
      <button id="stat-grammar" class="chip bg-blue-50 text-blue-700">æ–‡æ³• <span class="font-extrabold ml-1" id="statG">0</span></button>
      <button id="stat-col" class="chip bg-emerald-50 text-emerald-700">ç‰‡èª <span class="font-extrabold ml-1" id="statC">0</span></button>
      <button id="stat-voc" class="chip bg-violet-50 text-violet-700">å–®å­— <span class="font-extrabold ml-1" id="statV">0</span></button>
    </div>
  </section>

  <!-- ä¸»å…§å®¹ï¼šå¡ç‰‡ -->
  <main class="flex-1">
    <div id="cards" class="max-w-3xl mx-auto px-4 py-4 space-y-4"></div>
    <div id="empty" class="hidden max-w-3xl mx-auto px-4 py-20 text-center text-slate-500">ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œé»å³ä¸‹è§’ <b>ï¼‹</b> æ–°å¢ç¬¬ä¸€å¼µå¡ç‰‡å§ï¼</div>
  </main>

  <!-- å³ä¸‹è§’æ–°å¢ -->
  <button id="btn-add" class="fixed right-4 bottom-5 z-40 btn btn-primary rounded-full w-16 h-16 text-3xl leading-none safe-bottom">ï¼‹</button>

  <!-- è¡¨å–® Sheet -->
  <div id="sheet">
    <div class="panel card p-4 pb-2 safe-bottom relative">
      <button class="close-hit" id="sheet-x">âœ•</button>
      <h2 id="sheet-title" class="text-lg font-extrabold mb-2">æ–°å¢éŒ¯é¡Œ</h2>
      <form id="form" class="space-y-3">
        <input type="hidden" id="form-id" />
        <div>
          <label class="text-sm">åˆ†é¡</label>
          <select id="form-category" class="w-full border rounded-xl px-3 py-2">
            <option value="Grammar">æ–‡æ³• (Grammar)</option>
            <option value="Collocations">ç‰‡èª (Collocations)</option>
            <option value="Vocabulary">å–®å­— (Vocabulary)</option>
          </select>
        </div>
        <div>
          <label class="text-sm">é¡Œå¹¹ï¼ˆç°¡çŸ­é¡Œç›®ï¼‰</label>
          <textarea id="form-question" rows="3" class="w-full border rounded-xl px-3 py-2" placeholder="e.g. Visitors will see the monument ___ the building."></textarea>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-sm">âŒ éŒ¯èª¤ç­”æ¡ˆ</label>
            <input id="form-wrong" class="w-full border rounded-xl px-3 py-2" />
          </div>
          <div>
            <label class="text-sm">âœ… æ­£è§£ï¼ˆA/B/C/Dï¼‰</label>
            <input id="form-correct" class="w-full border rounded-xl px-3 py-2" placeholder="A æˆ– B æˆ– C æˆ– D" />
          </div>
        </div>
        <div>
          <label class="text-sm">ğŸ” éŒ¯å› åˆ†æ</label>
          <textarea id="form-analysis" rows="2" class="w-full border rounded-xl px-3 py-2" placeholder="ç‚ºä½•æœƒéŒ¯ï¼Ÿ"></textarea>
        </div>
        <div>
          <label class="text-sm">ğŸ¯ è¨˜æ†¶å£è¨£/å°æŠ€å·§</label>
          <textarea id="form-mnemonic" rows="2" class="w-full border rounded-xl px-3 py-2" placeholder="å°æŠ€å·§/å£è¨£"></textarea>
        </div>
        <div>
          <label class="text-sm">æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
          <input id="form-tags" class="w-full border rounded-xl px-3 py-2" placeholder="ä»‹ç³»è©, å½¢å®¹è©, Part5" />
        </div>
        <div class="flex items-center justify-between pt-1">
          <button type="button" id="btn-delete" class="text-red-600 hidden">åˆªé™¤</button>
          <button class="btn btn-primary">å„²å­˜</button>
        </div>
      </form>
      <button id="sheet-close-bottom" class="btn btn-ghost mt-3">é—œé–‰</button>
    </div>
  </div>

  <!-- å¸¸éŒ¯çµ±è¨ˆå½ˆçª— -->
  <div id="stat-modal" class="fixed inset-0 hidden items-end z-[55] bg-black/40">
    <div class="w-full max-w-3xl mx-auto card rounded-t-2xl p-4 safe-bottom">
      <div class="flex items-center justify-between">
        <h3 class="font-extrabold">å¸¸éŒ¯å­é¡çµ±è¨ˆ</h3>
        <button id="stat-close" class="close-hit">âœ•</button>
      </div>
      <div id="stat-list" class="mt-2 grid grid-cols-2 gap-2"></div>
      <button id="stat-close-bottom" class="btn btn-ghost mt-3 w-full">é—œé–‰</button>
    </div>
  </div>

  <!-- Toast / Loading -->
  <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-28 z-[70] hidden">
    <div class="bg-slate-900 text-white text-sm px-3 py-2 rounded-full shadow-lg">å®Œæˆ</div>
  </div>
  <div id="loading" class="fixed inset-0 hidden z-[75]">
    <div class="w-full h-full flex items-center justify-center">
      <div class="flex flex-col items-center gap-3">
        <div class="spin"></div>
        <div class="text-slate-700">åŒæ­¥ä¸­â€¦</div>
      </div>
    </div>
  </div>

  <script>
    /* ========= åŸºæœ¬ç‹€æ…‹ ========= */
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    const LS_KEY = 'eng_error_cards_v3';
    const DRIVE_FILE_NAME = 'english_mistakes_v3.json';
    const GOOGLE_CLIENT_ID = '1067450972173-l1o4o3fl73f57mcm4rltj520h2ocio12.apps.googleusercontent.com'; // â†â† é€™è£¡æ”¹æˆä½ çš„ Client ID

    const state = {
      cat: 'Grammar',
      mode: 'list',   // list | quiz
      data: [],
      filtered: [],
      token: null,
      email: null,
      driveFileId: null,
      statScope: 'Grammar'
    };

    /* ========= æœ¬åœ°è³‡æ–™ ========= */
    const loadLocal = () => { try { state.data = JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch { state.data = []; } };
    const saveLocal = () => localStorage.setItem(LS_KEY, JSON.stringify(state.data));

    function toast(msg='å®Œæˆ'){
      const t = $('#toast'); t.firstElementChild.textContent = msg;
      t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 1600);
    }
    function loading(on=true){
      $('#loading').classList.toggle('hidden', !on);
      if(on){ setTimeout(()=>$('#loading').classList.add('hidden'), 15000); } // æœ€é•· 15 ç§’
    }

    /* ========= UIï¼šTabs / ç¯©é¸ / Render ========= */
    function renderTabs(){
      $$('.tab').forEach(btn=>{
        const cat = btn.dataset.cat;
        const cnt = state.data.filter(d=>d.category===cat).length;
        btn.querySelector('.count').textContent = cnt ? `(${cnt})` : '';
        const on = (state.cat===cat);
        btn.classList.toggle('btn-primary', on);
        btn.classList.toggle('btn-ghost', !on);
        btn.classList.toggle('text-white', on);
      });
      // å¸¸éŒ¯å½™ç¸½
      $('#statG').textContent = state.data.filter(d=>d.category==='Grammar' && d.wrongCount>0).length;
      $('#statC').textContent = state.data.filter(d=>d.category==='Collocations' && d.wrongCount>0).length;
      $('#statV').textContent = state.data.filter(d=>d.category==='Vocabulary' && d.wrongCount>0).length;
    }
    function computeFiltered(){
      const q = $('#search').value.trim().toLowerCase();
      state.filtered = state.data
        .filter(d=>d.category===state.cat)
        .filter(d=>{
          if(!q) return true;
          const blob = [d.question,d.wrongAnswer,d.correctAnswer,d.analysis,d.mnemonic,(d.tags||[]).join(',')].join(' ').toLowerCase();
          return blob.includes(q);
        })
        .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    }
    const esc = s => String(s||'').replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

    function cardEl(it){
      const el = document.createElement('div');
      el.className = 'card p-4';
      const tags = (it.tags||[]).map(t=>`<span class="chip bg-slate-100 text-slate-600">#${esc(t)}</span>`).join(' ');
      const hearts = it.heartCount||0, wrongs = it.wrongCount||0;

      // æ¸¬é©—æ¨¡å¼ï¼šåªé¡¯ç¤º A/B/C/Dï¼Œä¸é™„åŠ ä»»ä½•é¡å¤–æ–‡å­—
      const quizBlock = `
        <div class="${state.mode==='quiz'?'':'hidden'} space-y-2 mt-3">
          ${['A','B','C','D'].map(k=>`
            <button class="opt js-opt" data-k="${k}">
              <div class="badge">${k}</div>
              <div class="font-bold">${k}</div>
            </button>`).join('')}
        </div>
      `;

      const reviewBlock = `
        <div class="${state.mode==='list'?'':'hidden'}">
          <div class="grid grid-cols-2 gap-2 text-sm mt-2">
            <div class="p-2 bg-red-50 border border-red-200 rounded-lg"><b class="text-red-600">âŒ</b> ${esc(it.wrongAnswer||'')}</div>
            <div class="p-2 bg-emerald-50 border border-emerald-200 rounded-lg"><b class="text-emerald-600">âœ…</b> ${esc(it.correctAnswer||'')}</div>
          </div>
          <div class="mt-2 p-3 bg-amber-50 border-l-4 border-amber-500 rounded-r-lg text-sm">
            <div class="font-bold text-amber-800 mb-1">ğŸ” éŒ¯å› åˆ†æ</div>
            <div class="text-slate-800">${esc(it.analysis||'â€”')}</div>
          </div>
          <div class="mt-2 p-3 bg-indigo-50 border-l-4 border-indigo-500 rounded-r-lg text-sm">
            <div class="font-bold text-indigo-800 mb-1">ğŸ¯ è¨˜æ†¶å£è¨£/å°æŠ€å·§</div>
            <div class="text-slate-800">${esc(it.mnemonic||'â€”')}</div>
          </div>
        </div>`;

      el.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm text-blue-600 font-bold">${({'Grammar':'ğŸ“ æ–‡æ³•','Collocations':'ğŸ”— ç‰‡èª','Vocabulary':'ğŸ’¡ å–®å­—'}[it.category])}</div>
          <div class="text-xs text-slate-400">${new Date(it.createdAt||Date.now()).toLocaleDateString()}</div>
        </div>
        <h3 class="font-extrabold text-slate-900 text-[18px] leading-snug">${esc(it.question||'')}</h3>
        <div class="flex flex-wrap gap-1 mt-1">${tags}</div>

        ${quizBlock}
        ${reviewBlock}

        <div class="flex items-center justify-between mt-3">
          <div class="text-xs flex items-center gap-2">
            <span class="chip bg-rose-50 text-rose-700">éŒ¯ <b>${wrongs}</b></span>
            <span class="chip bg-pink-50 text-pink-700">â¤ï¸ <b>${hearts}</b></span>
          </div>
          <div class="flex gap-2">
            <button class="btn btn-ghost tapfix js-edit">ç·¨è¼¯</button>
            <button class="btn btn-ghost tapfix js-del text-rose-600">åˆªé™¤</button>
            <button class="btn btn-ghost tapfix js-reviewed ${it.isReviewed?'bg-emerald-100 text-emerald-800':''}">${it.isReviewed?'å·²è¤‡ç¿’':'æ¨™è¨˜å·²è¤‡ç¿’'}</button>
          </div>
        </div>
      `;

      // äº‹ä»¶
      el.querySelector('.js-edit').onclick = ()=>openSheet(it);
      el.querySelector('.js-del').onclick = ()=>delItem(it.id);
      el.querySelector('.js-reviewed').onclick = ()=>toggleReviewed(it.id);

      if(state.mode==='quiz'){
        el.querySelectorAll('.js-opt').forEach(btn=>{
          btn.onclick = ()=>{
            const k = btn.dataset.k;
            // å·²é¸é¡¯ç¤º
            el.querySelectorAll('.js-opt').forEach(o=>o.classList.remove('chosen'));
            btn.classList.add('chosen');
            // åˆ¤æ–·
            if((it.correctAnswer||'').toUpperCase()===k.toUpperCase()){
              btn.classList.add('correct');
              it.heartCount = (it.heartCount||0)+1;
            }else{
              btn.classList.add('wrong');
              it.wrongCount = (it.wrongCount||0)+1;
            }
            saveLocal(); render(); // ç«‹å³æ›´æ–°è¨ˆæ•¸
          };
        });
      }
      return el;
    }

    function render(){
      renderTabs(); computeFiltered();
      const host = $('#cards'); host.innerHTML='';
      if(state.filtered.length===0){ $('#empty').classList.remove('hidden'); }
      else { $('#empty').classList.add('hidden'); state.filtered.forEach(it=>host.appendChild(cardEl(it))); }
    }

    /* ========= è¡¨å–® CRUD ========= */
    function openSheet(it=null){
      $('#sheet').style.display='flex';
      $('#sheet-title').textContent = it?'ç·¨è¼¯éŒ¯é¡Œ':'æ–°å¢éŒ¯é¡Œ';
      $('#btn-delete').classList.toggle('hidden', !it);
      $('#form-id').value = it?.id || '';
      $('#form-category').value = it?.category || state.cat;
      $('#form-question').value = it?.question || '';
      $('#form-wrong').value = it?.wrongAnswer || '';
      $('#form-correct').value = it?.correctAnswer || '';
      $('#form-analysis').value = it?.analysis || '';
      $('#form-mnemonic').value = it?.mnemonic || '';
      $('#form-tags').value = (it?.tags||[]).join(', ');
    }
    function closeSheet(){ $('#sheet').style.display='none'; }

    function upsert(obj){
      const idx = state.data.findIndex(d=>d.id===obj.id);
      if(idx>=0) state.data[idx]=obj; else state.data.unshift(obj);
      saveLocal(); render(); toast('å·²å„²å­˜');
    }
    function delItem(id){
      if(!confirm('ç¢ºå®šåˆªé™¤é€™å¼µå¡ç‰‡ï¼Ÿ')) return;
      const idx = state.data.findIndex(d=>d.id===id);
      if(idx>=0){ state.data.splice(idx,1); saveLocal(); render(); }
    }
    function toggleReviewed(id){
      const it = state.data.find(d=>d.id===id); if(!it) return;
      it.isReviewed = !it.isReviewed; if(it.isReviewed){ it.reviewCount=(it.reviewCount||0)+1; it.lastReviewed=Date.now(); }
      saveLocal(); render();
    }

    // åŒ¯å…¥ JSONï¼ˆåˆä½µé‡è¦†é¡Œç›®ï¼šä»¥ question+correctAnswer ç‚º keyï¼‰
    function importJSON(arr){
      if(!Array.isArray(arr)) return toast('åŒ¯å…¥æ ¼å¼éŒ¯èª¤');
      const key = o => (o.question||'') + '|' + (o.correctAnswer||'');
      const map = new Map(state.data.map(o=>[key(o), o]));
      arr.forEach(o=>{
        o.id = o.id || uid();
        o.tags = Array.isArray(o.tags) ? o.tags : String(o.tags||'').split(',').map(s=>s.trim()).filter(Boolean);
        o.wrongCount = o.wrongCount||0; o.heartCount = o.heartCount||0;
        map.set(key(o), {...(map.get(key(o))||{}), ...o});
      });
      state.data = Array.from(map.values()).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      saveLocal(); render(); toast('å·²åŒ¯å…¥');
    }

    /* ========= å¸¸éŒ¯çµ±è¨ˆï¼ˆå­æ¨™ç±¤ï¼‰ ========= */
    function openStatModal(scopeCat='Grammar'){
      state.statScope = scopeCat;
      const list = $('#stat-list'); list.innerHTML='';
      // ä»¥ tags çµ±è¨ˆ
      const counts = {};
      state.data.filter(d=>d.category===scopeCat).forEach(d=>{
        (d.tags||[]).forEach(t=>{ counts[t]=(counts[t]||0)+(d.wrongCount||0); });
      });
      const items = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
      if(items.length===0){ list.innerHTML = `<div class="text-slate-500">å°šç„¡çµ±è¨ˆè³‡æ–™</div>`; }
      else {
        items.forEach(([t,c])=>{
          const div=document.createElement('div');
          div.className='card p-3 flex items-center justify-between';
          div.innerHTML=`<div class="font-bold">#${esc(t)}</div><div class="chip bg-rose-50 text-rose-700">éŒ¯ <b>${c}</b></div>`;
          list.appendChild(div);
        });
      }
      $('#stat-modal').style.display='flex';
    }
    function closeStatModal(){ $('#stat-modal').style.display='none'; }

    /* ========= Google ç™»å…¥ + Drive ========= */
    let tokenClient, gapiInited=false, gisInited=false;

    function gapiLoaded(){
      gapi.load('client', async ()=>{
        await gapi.client.init({
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
        });
        gapiInited = true; maybeEnableAuth();
      });
    }
    window.gapiLoaded = gapiLoaded;

    function gisLoaded(){
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.file email',
        callback: (resp)=>{
          if(resp.error){ toast('æˆæ¬Šå¤±æ•—'); return; }
          state.token = resp.access_token;
          gapi.client.setToken({access_token: state.token});
          // å˜—è©¦å–å¾—ä½¿ç”¨è€… emailï¼ˆç”¨ userinfo endpointï¼‰
          fetch('https://www.googleapis.com/oauth2/v2/userinfo', { headers:{Authorization:'Bearer '+state.token}})
            .then(r=>r.json()).then(u=>{
              state.email = u.email || 'å·²ç™»å…¥';
              updateAuthUI(true);
              // æ‰¾æª”æ¡ˆ
              findDriveFile().finally(()=>{});
            }).catch(()=>{ updateAuthUI(true); });
        }
      });
      gisInited = true; maybeEnableAuth();
    }
    window.gisLoaded = gisLoaded;

    // æ‰‹å‹•è¼‰å…¥ï¼ˆé¿å…æŸäº›ç€è¦½å™¨å»¶é² onloadï¼‰
    window.addEventListener('load', ()=>{
      if(typeof gapi!=='undefined'){ gapiLoaded(); }
      if(typeof google!=='undefined'){ gisLoaded(); }
    });

    function maybeEnableAuth(){
      if(gapiInited && gisInited){
        $('#btn-auth').classList.remove('disabled');
      }
    }

    function updateAuthUI(isLoggedIn){
      if(isLoggedIn){
        $('#status').textContent = `âœ… å·²ç™»å…¥ Googleï¼š${state.email||''}`;
        $('#btn-auth').textContent = 'ç™»å‡º';
        $('#btn-auth').onclick = signOut;
        $('#btn-backup').classList.remove('disabled');
        $('#btn-restore').classList.remove('disabled');
      }else{
        $('#status').textContent = 'é›¢ç·šæ¨¡å¼ï¼ˆå°šæœªç™»å…¥ï¼‰';
        $('#btn-auth').textContent = 'Google ç™»å…¥';
        $('#btn-auth').onclick = authorize;
        $('#btn-backup').classList.add('disabled');
        $('#btn-restore').classList.add('disabled');
      }
    }

    function authorize(){
      if(!tokenClient){ toast('é›²ç«¯æœå‹™æœªå°±ç·’'); return; }
      tokenClient.requestAccessToken({prompt:'consent'});
    }
    function signOut(){
      try{
        google.accounts.oauth2.revoke(state.token, ()=>{});
      }catch{}
      state.token=null; state.email=null; state.driveFileId=null;
      gapi.client.setToken('');
      updateAuthUI(false);
      toast('å·²ç™»å‡º');
    }

    async function findDriveFile(){
      try{
        const r = await gapi.client.drive.files.list({
          spaces:'appDataFolder',
          q:`name='${DRIVE_FILE_NAME}'`,
          fields:'files(id, modifiedTime)',
          pageSize:1
        });
        const files = r.result.files||[];
        state.driveFileId = files.length? files[0].id : null;
      }catch(e){ console.warn('list error', e); }
    }

    async function backupToDrive(){
      if(!state.token){ return toast('è«‹å…ˆç™»å…¥ Google'); }
      loading(true);
      try{
        const data = JSON.stringify(state.data, null, 2);
        const boundary = '-------314159265358979323846'; // ä»»æ„
        const delimiter = `\r\n--${boundary}\r\n`;
        const closeDelim = `\r\n--${boundary}--`;
        const meta = { name: DRIVE_FILE_NAME, parents:['appDataFolder'], mimeType:'application/json' };

        const multipartBody =
          delimiter + 'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
          JSON.stringify(meta) +
          delimiter + 'Content-Type: application/json\r\n\r\n' +
          data + closeDelim;

        let url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
        let method = 'POST';
        if(state.driveFileId){
          url = `https://www.googleapis.com/upload/drive/v3/files/${state.driveFileId}?uploadType=multipart`;
          method = 'PATCH';
        }
        const resp = await fetch(url, {
          method,
          headers: {
            'Authorization':'Bearer '+state.token,
            'Content-Type':'multipart/related; boundary='+boundary
          },
          body: multipartBody
        });
        if(!resp.ok){
          const txt = await resp.text();
          throw new Error('ä¸Šå‚³å¤±æ•—ï¼š'+txt);
        }
        const j = await resp.json();
        state.driveFileId = j.id || state.driveFileId;
        toast('âœ… å‚™ä»½æˆåŠŸ');
      }catch(e){
        console.error(e);
        if(String(e).includes('AccessNotConfigured') || String(e).includes('drive.googleapis.com')){
          toast('å‚™ä»½å¤±æ•—ï¼šè«‹åˆ° GCP å•Ÿç”¨ Google Drive API');
        }else{
          toast('å‚™ä»½å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
      }finally{ loading(false); }
    }

    async function restoreFromDrive(){
      if(!state.token){ return toast('è«‹å…ˆç™»å…¥ Google'); }
      await findDriveFile();
      if(!state.driveFileId){ return toast('é›²ç«¯æœªæ‰¾åˆ°å‚™ä»½ï¼Œè«‹å…ˆå‚™ä»½'); }
      loading(true);
      try{
        const r = await gapi.client.drive.files.get({ fileId: state.driveFileId, alt:'media' });
        if(r.result){ importJSON(r.result); toast('âœ… é‚„åŸæˆåŠŸ'); }
        else throw new Error('ç„¡æ³•å–å¾—æª”æ¡ˆå…§å®¹');
      }catch(e){
        console.error(e); toast('é‚„åŸå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }finally{ loading(false); }
    }

    /* ========= äº‹ä»¶ ========= */
    $$('.tab').forEach(b=>b.onclick=()=>{ state.cat=b.dataset.cat; render(); });
    $('#btn-quick').onclick = ()=>{ state.mode='list'; render(); };
    $('#btn-quiz').onclick  = ()=>{ state.mode='quiz'; render(); };

    $('#btn-add').onclick = ()=>openSheet();
    $('#sheet-x').onclick = closeSheet;
    $('#sheet-close-bottom').onclick = closeSheet;

    $('#form').onsubmit = (e)=>{
      e.preventDefault();
      const id = $('#form-id').value || uid();
      const existed = state.data.find(d=>d.id===id);
      const obj = {
        id,
        category: $('#form-category').value,
        question: $('#form-question').value.trim(),
        wrongAnswer: $('#form-wrong').value.trim(),
        correctAnswer: ($('#form-correct').value||'').trim().toUpperCase(), // åƒ… A/B/C/D
        analysis: $('#form-analysis').value.trim(),
        mnemonic: $('#form-mnemonic').value.trim(),
        tags: $('#form-tags').value.split(',').map(s=>s.trim()).filter(Boolean),
        createdAt: existed? existed.createdAt : Date.now(),
        isReviewed: existed? existed.isReviewed : false,
        reviewCount: existed? existed.reviewCount||0 : 0,
        heartCount: existed? existed.heartCount||0 : 0,
        wrongCount: existed? existed.wrongCount||0 : 0
      };
      upsert(obj); closeSheet();
    };
    $('#btn-delete').onclick = ()=>{
      const id=$('#form-id').value; if(!id) return; closeSheet(); delItem(id);
    };

    // åŒ¯å‡ºï¼ˆæœ¬æ©Ÿä¸‹è¼‰ï¼‰
    //ï¼ˆä¿ç•™å¿«æ·ï¼šåœ¨ä»»ä½•æ™‚å€™è¼¸å‡ºï¼‰
    document.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='e'){
        const blob = new Blob([JSON.stringify(state.data,null,2)],{type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement('a'),{href:url,download:'english-mistakes.json'});
        document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),500);
      }
    });

    // åŒ¯å…¥ï¼ˆæª”æ¡ˆï¼‰
    $('#file-import').onchange = (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader(); r.onload = ()=>{
        try { importJSON(JSON.parse(r.result)); } catch { toast('åŒ¯å…¥å¤±æ•—'); }
      };
      r.readAsText(f); e.target.value='';
    };

    // å¸¸éŒ¯çµ±è¨ˆï¼ˆå­é¡å½ˆçª—ï¼‰
    $('#stat-grammar').onclick = ()=>openStatModal('Grammar');
    $('#stat-col').onclick = ()=>openStatModal('Collocations');
    $('#stat-voc').onclick = ()=>openStatModal('Vocabulary');
    $('#stat-close').onclick = closeStatModal;
    $('#stat-close-bottom').onclick = closeStatModal;

    // é›²ç«¯æŒ‰éˆ•
    $('#btn-auth').onclick = authorize;    // åˆå§‹çµ¦ authorizeï¼›ç™»å…¥å¾Œæœƒæ”¹ç¶ signOut
    $('#btn-backup').onclick = backupToDrive;
    $('#btn-restore').onclick = restoreFromDrive;

    /* ========= å•Ÿå‹• ========= */
    // PWA swï¼ˆå¯ç•™å¯åˆªï¼‰
    if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('sw.js').catch(()=>{}); }); }

    loadLocal(); render(); updateAuthUI(false);

    // è‹¥å¤–éƒ¨ script å·²è¼‰å…¥ï¼Œæ‰‹å‹•è§¸ç™¼åˆå§‹åŒ–
    if(typeof gapi!=='undefined'){ gapiLoaded(); }
    if(typeof google!=='undefined'){ gisLoaded(); }
  </script>
</body>
</html>
