<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>📒 英文錯題本 — Google Drive 雲端同步</title>

  <!-- PWA -->
  <meta name="theme-color" content="#2563eb" />
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <!-- 字體 & Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 外掛腳本：加上 onload 事件，載入完成後會呼叫我們定義的函式 -->
  <script src="https://accounts.google.com/gsi/client" async defer onload="onGisLoaded()"></script>
  <script src="https://apis.google.com/js/api.js" async defer onload="onGapiLoaded()"></script>

  <style>
    html, body { height: 100%; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans TC', 'PingFang TC', 'Microsoft JhengHei', sans-serif; background:#f8fafc; }
    .safe-bottom { padding-bottom: max(env(safe-area-inset-bottom), 1rem); }
    .card-shadow { box-shadow: 0 10px 15px -3px rgba(0,0,0,.08), 0 4px 6px -4px rgba(0,0,0,.06); }
    .btn { padding:.5rem .75rem; border-radius:.5rem; font-weight:700; transition:.1s transform; }
    .btn:active{ transform:scale(.98); }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-ghost { background:#f1f5f9; color:#334155; }
    .pill { font-size:12px; padding:.125rem .5rem; border-radius:9999px; }
    .disabled-btn { opacity: .5; pointer-events: none; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Header -->
  <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-gray-200">
    <div class="max-w-xl mx-auto px-4 py-3 flex items-center justify-between">
      <div>
        <div class="text-xs text-gray-400">ENG Error Notebook</div>
        <h1 class="text-xl font-extrabold text-gray-800">📒 英文錯題本（Drive 雲端）</h1>
        <div id="drive-status" class="text-xs text-gray-500 mt-1">（本機模式）</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btn-google-auth" class="btn btn-primary text-sm whitespace-nowrap">Google 登入</button>
        <button id="btn-backup"  class="btn btn-primary text-sm disabled-btn">💾 備份</button>
        <button id="btn-restore" class="btn btn-ghost  text-sm disabled-btn">🔄 還原</button>
      </div>
    </div>
    <div class="max-w-xl mx-auto px-4 py-2 border-t border-gray-100 flex items-center gap-2">
      <button id="btn-export" class="btn btn-ghost text-sm">匯出 (檔案備份)</button>
      <label class="btn btn-ghost text-sm cursor-pointer">
        匯入 (檔案還原)<input id="file-import" type="file" accept=".json" class="hidden" />
      </label>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="sticky top-[118px] z-20 bg-white/90 backdrop-blur border-b border-gray-200">
    <div class="max-w-xl mx-auto px-2 py-2 grid grid-cols-3 gap-2">
      <button data-cat="Grammar"      class="tab btn btn-ghost text-center">📝 文法 <span class="count text-gray-400"></span></button>
      <button data-cat="Collocations" class="tab btn btn-ghost text-center">🔗 片語 <span class="count text-gray-400"></span></button>
      <button data-cat="Vocabulary"   class="tab btn btn-ghost text-center">💡 單字 <span class="count text-gray-400"></span></button>
    </div>
  </nav>

  <!-- Search / Modes -->
  <section class="bg-white">
    <div class="max-w-xl mx-auto px-4 py-3 flex items-center gap-2">
      <div class="flex-1 relative">
        <input id="search" type="search" placeholder="搜尋題幹/標籤（ex: 介系詞 / schedule）" class="w-full rounded-lg border border-gray-300 px-3 py-2 pl-9 focus:ring-2 focus:ring-blue-500 outline-none" />
        <div class="absolute left-2 top-2.5 text-gray-400">🔎</div>
      </div>
      <button id="mode-list" class="btn btn-ghost text-sm" data-mode="list">📋 快速翻</button>
      <button id="mode-quiz" class="btn btn-ghost text-sm" data-mode="quiz">❓ 測驗</button>
    </div>
  </section>

  <!-- Main -->
  <main class="flex-1">
    <div class="max-w-xl mx-auto px-4 py-4 space-y-3" id="cards"></div>
    <div id="empty" class="hidden max-w-xl mx-auto px-4 py-16 text-center text-gray-500">目前沒有資料，點右下角 <b>＋</b> 新增第一張卡片吧！</div>
  </main>

  <!-- Add Button -->
  <div class="fixed right-4 bottom-4 z-40">
    <button id="btn-add" class="btn btn-primary shadow-xl rounded-full w-14 h-14 text-3xl leading-none">＋</button>
  </div>

  <!-- Sheet -->
  <div id="sheet" class="fixed inset-0 bg-black/40 hidden items-end z-50">
    <div class="w-full max-w-xl mx-auto bg-white rounded-t-2xl card-shadow p-4 safe-bottom">
      <div class="flex items-center justify-between mb-2">
        <h2 id="sheet-title" class="text-lg font-bold">新增錯題</h2>
        <button id="sheet-close" class="btn btn-ghost">關閉</button>
      </div>
      <form id="form" class="space-y-3">
        <input type="hidden" id="form-id" />
        <div>
          <label class="text-sm text-gray-700">分類</label>
          <select id="form-category" class="w-full border rounded-lg px-3 py-2">
            <option value="Grammar">文法 (Grammar)</option>
            <option value="Collocations">片語 &amp; 固定搭配 (Collocations)</option>
            <option value="Vocabulary">單字 (Vocabulary)</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-gray-700">題幹（簡短題目）</label>
          <textarea id="form-question" rows="2" class="w-full border rounded-lg px-3 py-2" placeholder="e.g. Visitors will see the monument ___ the building."></textarea>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-sm text-gray-700">❌ 錯誤答案</label>
            <input id="form-wrong" class="w-full border rounded-lg px-3 py-2" />
          </div>
          <div>
            <label class="text-sm text-gray-700">✅ 正解</label>
            <input id="form-correct" class="w-full border rounded-lg px-3 py-2" />
          </div>
        </div>
        <div>
          <label class="text-sm text-gray-700">🔎 錯因分析</label>
          <textarea id="form-analysis" rows="2" class="w-full border rounded-lg px-3 py-2" placeholder="為何會錯？"></textarea>
        </div>
        <div>
          <label class="text-sm text-gray-700">🎯 記憶口訣/小技巧</label>
          <textarea id="form-mnemonic" rows="2" class="w-full border rounded-lg px-3 py-2" placeholder="小技巧/口訣"></textarea>
        </div>
        <div>
          <label class="text-sm text-gray-700">標籤（逗號分隔）</label>
          <input id="form-tags" class="w-full border rounded-lg px-3 py-2" placeholder="介系詞, TOEIC, Part5" />
        </div>
        <div class="flex items-center justify-between pt-2">
          <button type="button" id="btn-delete" class="hidden text-red-600">刪除</button>
          <button class="btn btn-primary">儲存</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-24 z-50 hidden">
    <div class="bg-gray-900 text-white text-sm px-3 py-2 rounded-full shadow-lg">已儲存</div>
  </div>

  <!-- Loading -->
  <div id="loading" class="fixed inset-0 bg-white/80 flex items-center justify-center z-[100] hidden">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-2"></div>
      <p class="text-gray-700">同步中...</p>
    </div>
  </div>

  <!-- PWA Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(() => {});
      });
    }
  </script>

  <!-- App Logic -->
  <script>
  /* ------------------ 設定區 ------------------ */
  // ⚠️ 換成你的真實 Client ID
  const GOOGLE_CLIENT_ID = '1067450972173-l1o4o3fl73f57mcm4rltj520h2ocio12.apps.googleusercontent.com';
  const SCOPES = 'https://www.googleapis.com/auth/drive.appdata';
  const DRIVE_FILE_NAME = 'english_mistakes_v2.json';

  /* ------------------ 狀態 & 小工具 ------------------ */
  const $  = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));
  const uid= () => Math.random().toString(36).slice(2)+Date.now().toString(36);

  const state={ cat:'Grammar', mode:'list', data:[], filtered:[] };
  const LS_KEY='eng_error_cards_v2';

  let tokenClient = null;
  let driveFileId = null;

  let GAPI_READY=false, GIS_READY=false;

  const escapeHTML=(s)=> (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m]));
  const errText=(e)=> (e && (e.result?.error?.message || e.error || e.message)) || String(e);

  /* ------------------ 本地資料 ------------------ */
  const loadLocal=()=>{ try{ state.data=JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ state.data=[]; } };
  const saveLocal=()=> localStorage.setItem(LS_KEY, JSON.stringify(state.data));

  function renderTabs(){
    $$('.tab').forEach(btn=>{
      const cat=btn.dataset.cat;
      const count=state.data.filter(d=>d.category===cat).length;
      btn.querySelector('.count').textContent = count?`(${count})`:'';
      btn.classList.toggle('btn-primary', state.cat===cat);
      btn.classList.toggle('btn-ghost', state.cat!==cat);
      btn.classList.toggle('text-white', state.cat===cat);
    });
  }
  function setMode(m){
    state.mode=m;
    $('#mode-list').classList.toggle('btn-primary', m==='list');
    $('#mode-quiz').classList.toggle('btn-primary', m==='quiz');
    render();
  }
  function computeFiltered(){
    const q=$('#search').value.trim().toLowerCase();
    state.filtered = state.data
      .filter(d=>d.category===state.cat)
      .filter(d=>{
        if(!q) return true;
        const blob=[d.question,d.wrongAnswer,d.correctAnswer,d.analysis,d.mnemonic,(d.tags||[]).join(',')].join(' ').toLowerCase();
        return blob.includes(q);
      })
      .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  }
  function cardEl(it){
    const el=document.createElement('div');
    el.className='bg-white rounded-xl border border-gray-100 card-shadow p-4';
    el.innerHTML=`
      <div class="flex items-center justify-between mb-2">
        <div class="text-sm text-blue-600 font-semibold">${({'Grammar':'📝 文法','Collocations':'🔗 片語','Vocabulary':'💡 單字'}[it.category]||'📄')}</div>
        <div class="text-xs text-gray-400">${new Date(it.createdAt||Date.now()).toLocaleDateString('zh-TW')}</div>
      </div>
      <h3 class="font-bold text-gray-900 mb-2">${escapeHTML(it.question||'')}</h3>
      <div class="flex flex-wrap gap-1 mb-2">${(it.tags||[]).map(t=>`<span class="pill bg-gray-100 text-gray-600">#${escapeHTML(t)}</span>`).join('')}</div>
      <div class="${state.mode==='quiz'?'hidden':''}">
        <div class="grid grid-cols-2 gap-2 text-sm">
          <div class="p-2 bg-red-50 border border-red-200 rounded-lg"><b class="text-red-600">❌</b> ${escapeHTML(it.wrongAnswer||'')}</div>
          <div class="p-2 bg-green-50 border border-green-200 rounded-lg"><b class="text-green-600">✅</b> ${escapeHTML(it.correctAnswer||'')}</div>
        </div>
        <div class="mt-2 p-3 bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg text-sm">
          <div class="font-semibold text-yellow-800 mb-1">🔎 錯因分析</div>
          <div class="text-gray-800">${escapeHTML(it.analysis||'—')}</div>
        </div>
        <div class="mt-2 p-3 bg-indigo-50 border-l-4 border-indigo-500 rounded-r-lg text-sm">
          <div class="font-semibold text-indigo-800 mb-1">🎯 記憶口訣/小技巧</div>
          <div class="text-gray-800">${escapeHTML(it.mnemonic||'—')}</div>
        </div>
      </div>
      ${state.mode==='quiz'?`<button class="btn btn-primary w-full mt-3 js-show">顯示答案</button>`:''}
      <div class="flex justify-end gap-2 mt-3">
        <button class="btn btn-ghost text-sm js-edit">編輯</button>
        <button class="btn btn-ghost text-sm text-red-600 js-del">刪除</button>
        <button class="btn btn-ghost text-sm ${it.isReviewed?'text-green-700 bg-green-100':'text-gray-700 bg-gray-100'} js-review">${it.isReviewed?'✅ 已複習':'🔄 標記已複習'}</button>
      </div>`;
    el.querySelector('.js-edit').onclick=()=>openSheet(it);
    el.querySelector('.js-del').onclick=()=>delItem(it.id);
    el.querySelector('.js-review').onclick=()=>markReviewed(it.id, !it.isReviewed);
    el.querySelector('.js-show')?.addEventListener('click',(e)=>{ e.target.previousElementSibling.classList.remove('hidden'); e.target.remove(); });
    return el;
  }
  function render(){
    renderTabs(); computeFiltered();
    const host=$('#cards'); host.innerHTML='';
    if(state.filtered.length===0){ $('#empty').classList.remove('hidden'); }
    else { $('#empty').classList.add('hidden'); state.filtered.forEach(it=>host.appendChild(cardEl(it))); }
  }
  function openSheet(it=null){
    $('#sheet').classList.remove('hidden');
    $('#sheet-title').textContent = it?'編輯錯題':'新增錯題';
    $('#btn-delete').classList.toggle('hidden', !it);
    $('#form-id').value = it?.id || '';
    $('#form-category').value = it?.category || state.cat;
    $('#form-question').value = it?.question || '';
    $('#form-wrong').value = it?.wrongAnswer || '';
    $('#form-correct').value = it?.correctAnswer || '';
    $('#form-analysis').value = it?.analysis || '';
    $('#form-mnemonic').value = it?.mnemonic || '';
    $('#form-tags').value = (it?.tags||[]).join(', ');
  }
  function closeSheet(){ $('#sheet').classList.add('hidden'); }
  function upsertLocal(obj){
    const idx=state.data.findIndex(d=>d.id===obj.id);
    if(idx>=0) state.data[idx]=obj; else state.data.unshift(obj);
    saveLocal(); render(); toast('已儲存');
  }
  function delItem(id){
    if(!confirm('確定刪除這張卡片？')) return;
    const idx=state.data.findIndex(d=>d.id===id);
    if(idx>=0){ state.data.splice(idx,1); saveLocal(); render(); }
  }
  function markReviewed(id,flag){
    const it=state.data.find(d=>d.id===id); if(!it) return;
    it.isReviewed=!!flag; 
    if(flag){ it.reviewCount=(it.reviewCount||0)+1; it.lastReviewed=Date.now(); }
    saveLocal(); render();
  }
  function toast(msg='已儲存'){ const t=$('#toast'); t.firstElementChild.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),1200); }
  function importJSON(arr){
    if(!Array.isArray(arr)) return toast('匯入格式錯誤');
    const key = (o)=> (o.question||'') + '|' + (o.correctAnswer||'');
    const map = new Map(state.data.map(o=>[key(o), o]));
    arr.forEach(o=>{
      o.id = o.id || uid();
      o.tags = Array.isArray(o.tags)? o.tags : String(o.tags||'').split(',').map(s=>s.trim()).filter(Boolean);
      map.set(key(o), o);
    });
    state.data = Array.from(map.values()).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    saveLocal(); render(); toast('已匯入');
  }

  /* ------------------ Google Drive：初始化 & 登入 ------------------ */
  function updateDriveStatus(isLoggedIn, email=''){
    const el = $('#drive-status');
    const btn= $('#btn-google-auth');
    if (isLoggedIn){
      el.innerHTML = `<span class="text-green-600">✅ 已登入 Google ${email?`：${email}`:''}</span>`;
      btn.textContent = '登出';
      btn.onclick = signOut;
      setDriveButtons(true);
    }else{
      el.innerHTML = '<span class="text-gray-500">（本機模式）</span>';
      btn.textContent = 'Google 登入';
      btn.onclick = authorize;
      setDriveButtons(false);
    }
  }
  function setDriveButtons(enabled){
    const b1=$('#btn-backup'), b2=$('#btn-restore');
    [b1,b2].forEach(b=>{
      b.classList.toggle('disabled-btn', !enabled);
      b.onclick = enabled ? (b===b1?backupToDrive:restoreFromDrive) : null;
    });
  }

  // 由 <script onload> 觸發：GAPI
  async function onGapiLoaded(){
    gapi.load('client', async () => {
      try{
        await gapi.client.init({
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
        });
        GAPI_READY = true;
        maybeEnableLogin();
      }catch(e){
        console.error('GAPI 初始化失敗：', errText(e));
      }
    });
  }

  // 由 <script onload> 觸發：GIS
  function onGisLoaded(){
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_CLIENT_ID,
      scope: SCOPES,
      prompt: '',
      callback: async (resp) => {
        if (resp.error) { toast('登入失敗'); return; }
        gapi.client.setToken(resp);               // 把 access_token 丟給 gapi
        updateDriveStatus(true, '');              // 可自行加 email 顯示
        try{ await searchBackupFile(); }catch(e){ console.error('列檔失敗：', errText(e)); }
      }
    });
    GIS_READY = true;
    maybeEnableLogin();
  }

  function maybeEnableLogin(){
    if (GAPI_READY && GIS_READY) updateDriveStatus(false);
  }

  function authorize(){
    if (!tokenClient){ toast('雲端服務未就緒','error'); return; }
    tokenClient.requestAccessToken({ prompt:'consent' }); // 第一次建議 'consent'
  }

  function signOut(){
    const t=gapi.client.getToken();
    if (t){
      google.accounts.oauth2.revoke(t.access_token, ()=>{
        gapi.client.setToken(null);
        driveFileId=null;
        updateDriveStatus(false);
        toast('已登出');
      });
    }
  }

  async function searchBackupFile(){
    const resp = await gapi.client.drive.files.list({
      spaces: 'appDataFolder',
      q: `name = '${DRIVE_FILE_NAME}' and trashed = false`,
      fields: 'files(id, modifiedTime)'
    });
    const files = resp.result.files || [];
    driveFileId = files.length ? files[0].id : null;
    return files;
  }

  /* ------------------ Google Drive：備份 / 還原 ------------------ */
  async function backupToDrive(){
    try{
      $('#loading').classList.remove('hidden');
      const data = JSON.stringify(state.data || [], null, 2);

      if (!driveFileId){
        const metadata = { name: DRIVE_FILE_NAME, parents: ['appDataFolder'] };
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', new Blob([data], { type: 'application/json' }));

        const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` },
          body: form
        });
        const json = await res.json();
        if (!json.id) throw new Error('上傳失敗');
        driveFileId = json.id;
      }else{
        await gapi.client.request({
          path: `/upload/drive/v3/files/${driveFileId}`,
          method: 'PATCH',
          params: { uploadType: 'media' },
          headers: { 'Content-Type': 'application/json' },
          body: data
        });
      }
      toast('✅ 備份成功');
    }catch(e){
      console.error('備份失敗：', errText(e));
      toast('備份失敗：' + errText(e));
    }finally{
      $('#loading').classList.add('hidden');
    }
  }

  async function restoreFromDrive(){
    try{
      if (!driveFileId){ toast('雲端沒有備份，請先備份'); return; }
      $('#loading').classList.remove('hidden');

      const resp = await gapi.client.drive.files.get({ fileId: driveFileId, alt: 'media' });
      const content = resp.result;
      if (!Array.isArray(content)) throw new Error('備份檔案格式錯誤');
      importJSON(content);
      toast('✅ 還原成功');
    }catch(e){
      console.error('還原失敗：', errText(e));
      toast('還原失敗：' + errText(e));
    }finally{
      $('#loading').classList.add('hidden');
    }
  }

  /* ------------------ 事件綁定 & 啟動 ------------------ */
  $$('.tab').forEach(b=>b.onclick=()=>{ state.cat=b.dataset.cat; render(); });
  $('#mode-list').onclick=()=>setMode('list');
  $('#mode-quiz').onclick=()=>setMode('quiz');
  $('#btn-add').onclick=()=>openSheet();
  $('#sheet-close').onclick=()=>closeSheet();
  $('#search').oninput=()=>render();
  $('#form').onsubmit=(e)=>{
    e.preventDefault();
    const id = $('#form-id').value || uid();
    const existed = state.data.find(d=>d.id===id);
    const obj = {
      id,
      category: $('#form-category').value,
      question: $('#form-question').value.trim(),
      wrongAnswer: $('#form-wrong').value.trim(),
      correctAnswer: $('#form-correct').value.trim(),
      analysis: $('#form-analysis').value.trim(),
      mnemonic: $('#form-mnemonic').value.trim(),
      tags: $('#form-tags').value.split(',').map(s=>s.trim()).filter(Boolean),
      createdAt: existed?.createdAt || Date.now(),
      isReviewed: existed?.isReviewed || false, 
      reviewCount: existed?.reviewCount || 0,
      lastReviewed: existed?.lastReviewed || 0
    };
    upsertLocal(obj); closeSheet();
  };
  $('#btn-delete').onclick=()=>{
    const id=$('#form-id').value; if(id){ closeSheet(); delItem(id); }
  };
  $('#btn-export').onclick=()=>{
    const data=JSON.stringify(state.data,null,2);
    const url=URL.createObjectURL(new Blob([data],{type:'application/json'}));
    const a=Object.assign(document.createElement('a'),{href:url,download:`english-mistakes-${Date.now()}.json`});
    document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),500);
    toast('匯出成功 (本地檔案)');
  };
  $('#file-import').onchange=(e)=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{ try{ importJSON(JSON.parse(r.result)); }catch{ toast('匯入失敗'); } };
    r.readAsText(f); e.target.value='';
  };

  loadLocal();
  render();
  updateDriveStatus(false);
  </script>
</body>
</html>
