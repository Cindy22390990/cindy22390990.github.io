<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ğŸ“’ è‹±æ–‡éŒ¯é¡Œæœ¬ï¼ˆDrive é›²ç«¯ï¼‰</title>
<meta name="theme-color" content="#2563eb" />
<link rel="manifest" href="manifest.json" />
<link rel="apple-touch-icon" href="icon-192.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800;900&display=swap" rel="stylesheet" />
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root{
    --blue:#2563eb;
    --blue-100:#eef4ff;
    --safe-top:max(env(safe-area-inset-top),26px);
    --safe-side:max(env(safe-area-inset-left),16px);
  }
  html,body{height:100%}
  body{font-family:'Inter',system-ui,-apple-system,'SF Pro Text','PingFang TC','Noto Sans TC','Microsoft JhengHei',sans-serif;background:#f7f9fc;color:#0f172a;}
  .safe-top{height:var(--safe-top)}
  .container-pad{padding-left:calc(var(--safe-side) + 16px);padding-right:calc(var(--safe-side) + 16px)}
  .header{position:sticky;top:0;z-index:40;background:#fff;border-bottom:1px solid #e5e7eb;backdrop-filter:blur(6px)}
  .btn{border-radius:14px;font-weight:800;padding:.65rem 1rem;background:#eef2f7;color:#334155;transition:.06s transform,.06s color,.06s background}
  .btn:active{transform:scale(.98);color:var(--blue)}
  .btn-lg{min-height:52px}
  .btn-primary{background:#2563eb;color:#fff}
  .btn-blue{background:var(--blue-100);color:var(--blue);border:1px solid #cfe0ff}
  .btn-active{background:var(--blue-100)!important;color:var(--blue)!important}
  .pill{font-size:12px;border-radius:9999px;padding:.125rem .5rem}
  .badge{font-size:12px;background:#f1f5f9;color:#64748b;border-radius:10px;padding:.1rem .45rem}
  .card{background:#fff;border:1px solid #eef2f7;border-radius:16px;box-shadow:0 8px 18px rgba(15,23,42,.06);padding:1rem;margin:.5rem 0}
  .toolbar{position:sticky;top:calc(var(--safe-top) + 74px);z-index:30;background:#fff;border-bottom:1px solid #e5e7eb}
  .tap{-webkit-tap-highlight-color:transparent}
  .hidden-hard{display:none!important}
  .opt{display:flex;align-items:center;gap:10px;border:1px solid #e6eaf0;border-radius:12px;padding:14px 12px;cursor:pointer}
  .opt b{width:1.5rem;text-align:center}
  .opt.active{border-color:var(--blue);background:var(--blue-100);color:var(--blue)}
  .opt.correct{border-color:#16a34a;background:#ecfdf5}
  .opt.wrong{border-color:#dc2626;background:#fef2f2}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:88px;z-index:60;background:#111827;color:#fff;border-radius:9999px;padding:.5rem .9rem;font-size:14px;display:none}
  .toast.show{display:block}
  #loading{position:fixed;inset:0;background:rgba(255,255,255,.78);display:none;align-items:center;justify-content:center;z-index:100}
  #loading.show{display:flex}
  .fab{position:fixed;right:calc(var(--safe-side) + 18px);bottom:calc(env(safe-area-inset-bottom) + 18px);width:64px;height:64px;border-radius:9999px;background:var(--blue);color:#fff;font-size:34px;display:flex;align-items:center;justify-content:center;box-shadow:0 12px 28px rgba(37,99,235,.35);z-index:35}
  .sheet{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:end;z-index:50}
  .sheet.show{display:flex}
  .sheet-card{background:#fff;border-top-left-radius:18px;border-top-right-radius:18px;width:100%}
</style>
</head>

<body class="min-h-screen flex flex-col">
  <div class="safe-top"></div>

  <!-- Header -->
  <header class="header">
    <div class="container-pad">
      <h1 class="text-2xl font-black leading-tight">ğŸ“’ è‹±æ–‡éŒ¯é¡Œæœ¬ <span class="text-slate-500 font-extrabold">ï¼ˆDrive é›²ç«¯ï¼‰</span></h1>
      <div id="drive-status" class="text-xs text-slate-500 mt-1">é›¢ç·šæ¨¡å¼ï¼ˆå°šæœªç™»å…¥ï¼‰</div>
      <div class="flex flex-wrap gap-3 pb-3 mt-2">
        <button id="btn-auth" class="btn btn-lg btn-primary tap">Google ç™»å…¥</button>
        <button id="btn-backup" class="btn btn-lg btn-blue tap">å‚™ä»½</button>
        <button id="btn-restore" class="btn btn-lg btn-blue tap">é‚„åŸ</button>
        <label class="btn tap">åŒ¯å…¥ï¼ˆæª”æ¡ˆï¼‰<input id="file-import" type="file" accept=".json" class="hidden" /></label>
        <button id="btn-export-file" class="btn tap">åŒ¯å‡ºï¼ˆæª”æ¡ˆï¼‰</button>
      </div>
    </div>
  </header>

  <!-- å·¥å…·åˆ— -->
  <section class="toolbar">
    <div class="container-pad">
      <div class="mt-3 grid grid-cols-3 gap-3">
        <button id="tab-grammar" class="btn tap">ğŸ“ æ–‡æ³•</button>
        <button id="tab-collocations" class="btn tap">ğŸ”— ç‰‡èª</button>
        <button id="tab-vocab" class="btn tap">ğŸ’¡ å–®å­—</button>
      </div>
      <div class="mt-3 grid grid-cols-2 gap-3">
        <button id="mode-list" class="btn tap">ğŸ“‹ ç¶œåˆæ¸¬é©—</button>
        <button id="mode-quiz" class="btn tap">ğŸ“ æ¸¬é©—ï¼ˆä¾é¡åˆ¥ï¼‰</button>
      </div>
      <div class="mt-3 grid grid-cols-[1fr_auto_auto] gap-2">
        <div class="relative">
          <input id="search" type="search" placeholder="æœå°‹é¡Œå¹¹/æ¨™ç±¤ï¼ˆex: ä»‹ç³»è© / scheduleï¼‰"
                 class="w-full rounded-lg border border-gray-300 px-3 py-2 pl-9 focus:ring-2 focus:ring-blue-500 outline-none">
          <div class="absolute left-2 top-2.5 text-gray-400 select-none">ğŸ”</div>
        </div>
        <button id="btn-search" class="btn tap">æœå°‹</button>
        <button id="btn-clear" class="btn tap">æ¸…é™¤</button>
      </div>
    </div>
  </section>

  <!-- ä¸»å…§å®¹ -->
  <main class="flex-1">
    <div class="container-pad">
      <div class="max-w-xl mx-auto py-4 space-y-3" id="cards"></div>
      <div id="empty" class="hidden max-w-xl mx-auto py-16 text-center text-gray-500">
        ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œé»å³ä¸‹è§’ <b>ï¼‹</b> æ–°å¢ç¬¬ä¸€å¼µå¡ç‰‡æˆ–ç”¨ã€ŒåŒ¯å…¥ï¼ˆæª”æ¡ˆï¼‰ã€è¼‰å…¥ JSONã€‚
      </div>
    </div>
  </main>

  <!-- æ–°å¢æŒ‰éˆ• -->
  <button id="btn-add" class="fab tap" aria-label="æ–°å¢éŒ¯é¡Œ">ï¼‹</button>

  <!-- æ–°å¢/ç·¨è¼¯ Sheet -->
  <div id="sheet" class="sheet">
    <div class="sheet-card">
      <div class="container-pad" style="padding-top:12px;padding-bottom:12px"><h2 id="sheet-title" class="text-lg font-extrabold">æ–°å¢éŒ¯é¡Œ</h2></div>
      <div class="container-pad" style="padding-bottom:calc(env(safe-area-inset-bottom) + 14px)">
        <form id="form" class="space-y-3">
          <input type="hidden" id="form-id" />
          <div>
            <label class="text-sm text-gray-700">åˆ†é¡</label>
            <select id="form-category" required class="w-full border rounded-lg px-3 py-2">
              <option value="Grammar">æ–‡æ³• (Grammar)</option>
              <option value="Collocations">ç‰‡èª (Collocations)</option>
              <option value="Vocabulary">å–®å­— (Vocabulary)</option>
            </select>
          </div>
          <div><label class="text-sm text-gray-700">å­åˆ†é¡ï¼ˆå¦‚ï¼šä»‹ç³»è©ï¼æ™‚æ…‹ï¼‰</label>
            <input id="form-subcat" class="w-full border rounded-lg px-3 py-2" placeholder="ä»‹ç³»è© / æ™‚æ…‹ / è©æ€§ â€¦"></div>
          <div><label class="text-sm text-gray-700">é¡Œå¹¹</label>
            <textarea id="form-question" required rows="2" class="w-full border rounded-lg px-3 py-2" placeholder="è¼¸å…¥é¡Œç›®æ–‡å­—"></textarea></div>
          <div class="grid grid-cols-2 gap-2">
            <div><label class="text-sm text-gray-700">âŒ ä½ çš„ç­”æ¡ˆï¼ˆæˆ–å¸¸è¦‹èª¤ç­”ï¼‰</label>
              <input id="form-wrong" class="w-full border rounded-lg px-3 py-2"></div>
            <div><label class="text-sm text-gray-700">âœ… æ­£ç¢ºç­”æ¡ˆï¼ˆæ–‡å­—æˆ– A/B/C/Dï¼‰</label>
              <input id="form-correct" class="w-full border rounded-lg px-3 py-2" placeholder="ä¾‹å¦‚ï¼šA æˆ– (A) this æˆ– this"></div>
          </div>
          <div><label class="text-sm text-gray-700">ğŸ” éŒ¯å› åˆ†æ</label>
            <textarea id="form-analysis" rows="2" class="w-full border rounded-lg px-3 py-2"></textarea></div>
          <div><label class="text-sm text-gray-700">ğŸ¯ è¨˜æ†¶å£è¨£/å°æŠ€å·§</label>
            <textarea id="form-mnemonic" rows="2" class="w-full border rounded-lg px-3 py-2"></textarea></div>
          <div><label class="text-sm text-gray-700">ğŸ§© é¡é¡Œæé†’ï¼ˆåŒè§€å¿µé¡Œå‹ï¼‰</label>
            <input id="form-related" class="w-full border rounded-lg px-3 py-2" placeholder="ä¾‹ï¼šå›ºå®šæ­é… in/onï¼›å½¢å®¹è©é †åº â€¦"></div>
          <div><label class="text-sm text-gray-700">ğŸ“ é¡Œç›®ä¾†æº</label>
            <input id="form-source" class="w-full border rounded-lg px-3 py-2" placeholder="æ›¸å / ç¶²ç«™ / è©¦é¡Œå¹´ä»½ â€¦"></div>
          <div><label class="text-sm text-gray-700">æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
            <input id="form-tags" class="w-full border rounded-lg px-3 py-2" placeholder="ä»‹ç³»è©, TOEIC, Part5"></div>
          <div class="flex items-center justify-between pt-2">
            <button type="button" id="btn-delete" class="text-red-600 tap hidden">åˆªé™¤</button>
            <div class="ml-auto flex items-center gap-2">
              <button type="button" id="btn-close" class="btn tap">é—œé–‰</button>
              <button class="btn btn-blue tap" type="submit">å„²å­˜</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast & Loading -->
  <div id="toast" class="toast">æç¤º</div>
  <div id="loading"><div class="text-center">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-2"></div>
    <p class="text-gray-700">è™•ç†ä¸­â€¦</p></div></div>

<script>
/* ========= å°å·¥å…· ========= */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const toast=(msg,dur=1400)=>{ const el=$("#toast"); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),dur); };
const shuffle=arr=>{const a=arr.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;};
const fmt=(t)=>{const d=new Date(t);const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}/${p(d.getMonth()+1)}/${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`}

/* é¡Œå¹¹æŠ½å– (A)(B)(C)(D) */
function extractInlineChoices(q){ if(!q) return []; const reg=/\(([ABCD])\)\s*([^()]+?)(?=\s*\([ABCD]\)|$)/g; let m,list=[]; while((m=reg.exec(q))) list.push(m[2].trim()); return list.length===4?list:[];}
function stripChoicesFromQuestion(q){ if(!q) return ''; return q.replace(/\([ABCD]\)\s*[^()]+(?=\s*\([ABCD]\)|$)/g,'').replace(/\s{2,}/g,' ').trim(); }
function resolveCorrectText(correctAnswer, optionTexts){
  const ca=(correctAnswer||'').trim(); if(!ca) return '';
  if(/^[ABCD]$/i.test(ca)){ const idx='ABCD'.indexOf(ca.toUpperCase()); return optionTexts[idx]||''; }
  const m=ca.match(/^[\(\s]*([ABCD])[\)\.\s]+(.+)$/i);
  if(m){ const L=m[1].toUpperCase(), txt=m[2].trim(); if(optionTexts.some(t=>t && t.toLowerCase().trim()===txt.toLowerCase().trim())) return txt; const idx='ABCD'.indexOf(L); return optionTexts[idx]||txt; }
  return ca;
}

/* ========= ç‹€æ…‹ ========= */
const LS_KEY='eng_error_cards_v5';
const state={ cat:null, mode:null, data:[], filtered:[] };

/* ========= åŒ¯å…¥/åŒ¯å‡º ========= */
function normalizeCategory(v){ if(!v) return 'Grammar'; if(/æ–‡æ³•|grammar/i.test(v)) return 'Grammar'; if(/ç‰‡èª|colloc/i.test(v)) return 'Collocations'; if(/å–®å­—|vocab/i.test(v)) return 'Vocabulary'; return 'Grammar'; }
function parseImportArray(arr){
  return arr.map(o=>{
    const id=uid();
    const category=normalizeCategory(o['åˆ†é¡']||o.category);
    const subCategory=o['å­åˆ†é¡']||o.subCategory||'';
    const question=o['é¡Œå¹¹']||o.question||'';
    const wrongAnswer=o['ä½ çš„ç­”æ¡ˆ']||o['éŒ¯èª¤ç­”æ¡ˆ']||o.wrongAnswer||'';
    const correctAnswer=o['æ­£ç¢ºç­”æ¡ˆ']||o.correctAnswer||'';
    const analysis=o['éŒ¯å› åˆ†æ']||o.analysis||'';
    const mnemonic=o['è¨˜æ†¶å£è¨£']||o.mnemonic||'';
    const relatedHint=o['é¡é¡Œæé†’']||o.relatedHint||'';
    const source=o['é¡Œç›®ä¾†æº']||o.source||'';
    const tags=(o['æ¨™ç±¤']||o.tags||'').toString().split(/[,ï¼Œ]/).map(s=>s.trim()).filter(Boolean);
    const options=Array.isArray(o.options)?o.options:(o['é¸é …']?o['é¸é …'].toString().split(/[;ï¼›]/).map(s=>s.trim()).filter(Boolean):[]);
    return {id,category,subCategory,question,wrongAnswer,correctAnswer,analysis,mnemonic,relatedHint,source,tags,options:options.slice(0,4),
      createdAt:Date.now(),failCount:0,reviewHistory:[],extra:o};
  });
}
function loadLocal(){ try{ state.data=JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ state.data=[]; } 
  state.data.forEach(o=>{ if(!Array.isArray(o.reviewHistory)) o.reviewHistory=[]; });
}
function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(state.data)); }

$("#file-import").onchange=(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const json=JSON.parse(r.result);
      if(!Array.isArray(json)) throw new Error('åŒ¯å…¥æª”ä¸æ˜¯é™£åˆ—');
      const parsed=parseImportArray(json);
      const key=o=>(o.question||'')+'|'+(o.correctAnswer||'');
      const map=new Map(state.data.map(o=>[key(o),o]));
      parsed.forEach(o=>map.set(key(o),o));
      state.data=Array.from(map.values()).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      saveLocal(); render(); toast(`âœ… åŒ¯å…¥æˆåŠŸï¼Œå…± ${parsed.length} ç­†`);
    }catch(err){ console.error(err); toast('âŒ åŒ¯å…¥å¤±æ•—ï¼šæ ¼å¼éŒ¯èª¤æˆ–å…§å®¹ç„¡æ³•è§£æ'); }
  };
  r.readAsText(f); e.target.value='';
};
$("#btn-export-file").onclick=()=>{
  const data=JSON.stringify(state.data,null,2);
  const url=URL.createObjectURL(new Blob([data],{type:'application/json'}));
  const a=Object.assign(document.createElement('a'),{href:url,download:`english-mistakes-${Date.now()}.json`});
  document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),500);
  toast('å·²åŒ¯å‡ºï¼ˆæœ¬æ©Ÿæª”æ¡ˆï¼‰');
};

/* ========= ç¯©é¸/æ¸²æŸ“ ========= */
function setActive(btn,active){ btn.classList.toggle('btn-active',!!active); }
function renderTabs(){ setActive($("#tab-grammar"),state.cat==='Grammar'); setActive($("#tab-collocations"),state.cat==='Collocations'); setActive($("#tab-vocab"),state.cat==='Vocabulary'); }

/* æ’åºè¦å‰‡ï¼š
   1) æœªè¤‡ç¿’å„ªå…ˆï¼ˆreviewHistory.length === 0ï¼‰
   2) å·²è¤‡ç¿’è€…ï¼šä¸Šæ¬¡è¤‡ç¿’æ™‚é–“è¶Šä¹…ï¼ˆè¼ƒå°ï¼‰è¶Šå‰é¢
   3) å†ä»¥éŒ¯é¡Œæ¬¡æ•¸ç”±å¤šåˆ°å°‘
   4) æœ€å¾Œä»¥å»ºç«‹æ™‚é–“ç”±èˆŠåˆ°æ–°ï¼ˆé¿å…å®Œå…¨ç›¸åŒæ™‚æŠ–å‹•ï¼‰
*/
function sortByReviewPriority(a,b){
  const ar=(a.reviewHistory?.length||0), br=(b.reviewHistory?.length||0);
  if(ar===0 && br>0) return -1;
  if(br===0 && ar>0) return 1;
  if(ar===0 && br===0){
    // éƒ½æ²’è¤‡ç¿’ï¼šç”¨ createdAt ç”±èˆŠåˆ°æ–°ï¼Œå†ä»¥ failCount é«˜åˆ°ä½
    if((a.createdAt||0)!==(b.createdAt||0)) return (a.createdAt||0)-(b.createdAt||0);
    return (b.failCount||0)-(a.failCount||0);
  }
  const al=a.reviewHistory[ar-1]||0, bl=b.reviewHistory[br-1]||0;
  if(al!==bl) return al-bl; // è¼ƒä¹…æ²’è¤‡ç¿’ï¼ˆæ™‚é–“è¼ƒå°ï¼‰åœ¨å‰
  if((b.failCount||0)!==(a.failCount||0)) return (b.failCount||0)-(a.failCount||0);
  return (a.createdAt||0)-(b.createdAt||0);
}

function computeFiltered(){
  const q=$("#search").value.trim().toLowerCase();
  let arr=state.data.slice();
  // ç¶œåˆæ¸¬é©—ï¼ˆlistï¼‰ï¼šä¸é™å®šé¡åˆ¥ï¼›ä¾å„ªå…ˆåº¦æ’åº
  // ä¾é¡åˆ¥æ¸¬é©—ï¼ˆquizï¼‰ï¼šå…ˆéæ¿¾é¡åˆ¥ï¼Œå†ä¾å„ªå…ˆåº¦æ’åº
  if(state.mode==='quiz' && state.cat){
    arr=arr.filter(d=>d.category===state.cat);
  }
  if(q){
    arr=arr.filter(d=>{
      const blob=[d.question,d.wrongAnswer,d.correctAnswer,d.analysis,d.mnemonic,d.relatedHint,d.source,(d.tags||[]).join(','),d.subCategory].join(' ').toLowerCase();
      return blob.includes(q);
    });
  }
  // çµ±ä¸€æ¡ç”¨ã€Œæœªè¤‡ç¿’ â†’ æœ€ä¹…æœªè¤‡ç¿’ â†’ éŒ¯å¤šã€çš„å„ªå…ˆé †åº
  arr.sort(sortByReviewPriority);
  state.filtered=arr;
}

function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* å‚™æ´å››é¸é …ï¼ˆåªæœ‰ç•¶é¡Œå¹¹èˆ‡ options éƒ½æ²’æœ‰æ™‚ä½¿ç”¨ï¼‰ */
function fallbackOptions(item){
  const CA=(item.correctAnswer||'').trim(); const pool=['in','on','at','to','make','do','take','have','increase','reduce','book','time','work']; 
  const uniq=[...new Set([CA,...pool])].filter(Boolean).slice(0,4);
  while(uniq.length<4) uniq.push(pool[Math.floor(Math.random()*pool.length)]);
  return uniq.slice(0,4);
}

function changeFailCount(id,delta,elCard){
  const it=state.data.find(d=>d.id===id); if(!it) return;
  it.failCount=Math.max(0,(it.failCount||0)+delta); saveLocal();
  elCard?.querySelector('.js-fails')?.replaceChildren(document.createTextNode(`éŒ¯ ${it.failCount} æ¬¡`));
}
function addReview(id){
  const it=state.data.find(d=>d.id===id); if(!it) return;
  const now=Date.now(); it.reviewHistory=Array.isArray(it.reviewHistory)?it.reviewHistory:[]; it.reviewHistory.push(now);
  saveLocal();
}

/* å¡ç‰‡ */
function cardEl(it){
  const el=document.createElement('div'); el.className='card tap';
  const categoryMap={'Grammar':'ğŸ“ æ–‡æ³•','Collocations':'ğŸ”— ç‰‡èª','Vocabulary':'ğŸ’¡ å–®å­—'};
  const created=new Date(it.createdAt||Date.now()).toLocaleDateString('zh-TW');

  // å–å¾—å››å€‹é¸é …æ–‡å­—
  let optionTexts=extractInlineChoices(it.question);
  if(optionTexts.length!==4 && Array.isArray(it.options) && it.options.length===4){ optionTexts=it.options.map(o=>typeof o==='string'?o:(o.text||'')); }
  if(optionTexts.length!==4) optionTexts=fallbackOptions(it);

  const correctText=resolveCorrectText(it.correctAnswer,optionTexts);
  const shuffled=(function(a){const b=a.slice();for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;})(optionTexts);
  let correctIdx=0; for(let i=0;i<4;i++){ if((shuffled[i]||'').trim().toLowerCase()===(correctText||'').trim().toLowerCase()){ correctIdx=i; break; } }
  const correctLetter='ABCD'[correctIdx];
  const cleanQuestion=stripChoicesFromQuestion(it.question||'');
  const lastReview = (it.reviewHistory&&it.reviewHistory.length)? fmt(it.reviewHistory[it.reviewHistory.length-1]) : null;
  const reviewCount = (it.reviewHistory&&it.reviewHistory.length)||0;

  el.innerHTML=`
    <div class="flex items-center justify-between mb-2">
      <div class="text-sm font-semibold text-blue-700">
        ${categoryMap[it.category]||'ğŸ“„'}
        ${it.subCategory?`<span class="pill bg-blue-50 text-blue-700 ml-2">${escapeHTML(it.subCategory)}</span>`:''}
      </div>
      <div class="text-right text-xs text-gray-400">
        <div>${created}</div>
        <div class="mt-1">
          <span class="pill bg-emerald-50 text-emerald-600">è¤‡ç¿’ ${reviewCount} æ¬¡${lastReview?`ãƒ»ä¸Šæ¬¡ ${lastReview}`:''}</span>
          <span class="pill bg-red-100 text-red-600 ml-1 js-fails">éŒ¯ ${it.failCount||0} æ¬¡</span>
        </div>
      </div>
    </div>

    <h3 class="font-bold text-gray-900 mb-2">${escapeHTML(cleanQuestion)}</h3>
    <div class="flex flex-wrap gap-1 mb-2">${(it.tags||[]).map(t=>`<span class="pill bg-gray-100 text-gray-600">#${escapeHTML(t)}</span>`).join('')}</div>

    <div class="space-y-2" data-quiz="${it.id}">
      ${[0,1,2,3].map(i=>`<button class="opt" data-idx="${i}"><b>${'ABCD'[i]}</b><span>${escapeHTML(shuffled[i]||'')}</span></button>`).join('')}
    </div>
    <div class="mt-3 hidden" id="qa-${it.id}">
      <div class="p-2 bg-green-50 border border-green-200 rounded-lg text-sm">
        <b class="text-green-700">âœ… æ­£è§£</b>ï¼š${correctLetter}ï¼ˆ${escapeHTML(shuffled[correctIdx]||'')}ï¼‰
      </div>
      ${it.analysis?`<div class="mt-2 p-3 bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg text-sm"><div class="font-semibold text-yellow-800 mb-1">ğŸ” éŒ¯å› åˆ†æ</div><div class="text-gray-800">${escapeHTML(it.analysis)}</div></div>`:''}
      ${it.mnemonic?`<div class="mt-2 p-3 bg-indigo-50 border-l-4 border-indigo-500 rounded-r-lg text-sm"><div class="font-semibold text-indigo-800 mb-1">ğŸ¯ è¨˜æ†¶å£è¨£</div><div class="text-gray-800">${escapeHTML(it.mnemonic)}</div></div>`:''}
      ${it.relatedHint?`<div class="mt-2 p-3 bg-sky-50 border-l-4 border-sky-500 rounded-r-lg text-sm"><div class="font-semibold text-sky-800 mb-1">ğŸ§© é¡é¡Œæé†’</div><div class="text-gray-800">${escapeHTML(it.relatedHint)}</div></div>`:''}
      ${it.source?`<div class="mt-2 text-xs text-slate-500">ğŸ“ é¡Œç›®ä¾†æºï¼š${escapeHTML(it.source)}</div>`:''}
    </div>

    <div class="flex justify-end gap-2 mt-3">
      ${ (state.mode ? '' : '<button class="btn text-sm js-edit tap">ç·¨è¼¯</button><button class="btn text-sm text-red-600 js-del tap">åˆªé™¤</button>' ) }
      <button class="btn text-sm js-review tap">â• è¨˜ä¸€ç­†è¤‡ç¿’</button>
    </div>
  `;

  const box=el.querySelector(`[data-quiz="${it.id}"]`);
  box.querySelectorAll('.opt').forEach(opt=>{
    opt.addEventListener('click',()=>{
      box.querySelectorAll('.opt').forEach(o=>o.classList.remove('active','correct','wrong'));
      opt.classList.add('active');
      const idx=Number(opt.getAttribute('data-idx'));
      const ok=(idx===correctIdx);
      if(ok){ opt.classList.add('correct'); changeFailCount(it.id,-1,el); toast('âœ… ç­”å°äº†ï¼å·²è¨˜è¤‡ç¿’'); }
      else{ opt.classList.add('wrong'); changeFailCount(it.id,+1,el); toast('âŒ ç­”éŒ¯äº†ï¼å·²è¨˜è¤‡ç¿’'); }
      addReview(it.id);
      document.getElementById(`qa-${it.id}`)?.classList.remove('hidden');
      render(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ’åºèˆ‡ã€Œä¸Šæ¬¡è¤‡ç¿’ã€é¡¯ç¤º
    });
  });

  if(!state.mode){
    el.querySelector('.js-edit')?.addEventListener('click',()=>openSheet(it));
    el.querySelector('.js-del')?.addEventListener('click',()=>delItem(it.id));
  }
  el.querySelector('.js-review').onclick=()=>{ addReview(it.id); toast('å·²è¨˜ä¸€ç­†è¤‡ç¿’'); render(); };

  return el;
}

function render(){
  renderTabs(); computeFiltered();
  const host=$("#cards"); host.innerHTML='';
  // ä¸å†å°ç¶œåˆæ¸¬é©—åšéš¨æ©Ÿæ´—ç‰Œï¼Œç¶­æŒæ’åºè¦å‰‡
  if(state.filtered.length===0) $("#empty").classList.remove('hidden');
  else { $("#empty").classList.add('hidden'); state.filtered.forEach(it=>host.appendChild(cardEl(it))); }
}

/* ========= CRUD ========= */
function upsertLocal(obj){
  const idx=state.data.findIndex(d=>d.id===obj.id);
  if(idx>=0) state.data[idx]=obj; else state.data.unshift(obj);
  if(!Array.isArray(obj.reviewHistory)) obj.reviewHistory=[];
  saveLocal(); render(); toast('å·²å„²å­˜');
}
function delItem(id){
  if(!confirm('ç¢ºå®šåˆªé™¤é€™å¼µå¡ç‰‡ï¼Ÿ')) return;
  const idx=state.data.findIndex(d=>d.id===id);
  if(idx>=0){ state.data.splice(idx,1); saveLocal(); render(); toast('å·²åˆªé™¤'); }
}

/* ========= æ–°å¢/ç·¨è¼¯ Sheet ========= */
function openSheet(it=null){
  $("#sheet").classList.add('show');
  $("#sheet-title").textContent=it?'ç·¨è¼¯éŒ¯é¡Œ':'æ–°å¢éŒ¯é¡Œ';
  $("#btn-delete").classList.toggle('hidden',!it);
  $("#form-id").value=it?.id||'';
  $("#form-category").value=it?.category||(state.cat||'Grammar');
  $("#form-subcat").value=it?.subCategory||'';
  $("#form-question").value=it?.question||'';
  $("#form-wrong").value=it?.wrongAnswer||'';
  $("#form-correct").value=it?.correctAnswer||'';
  $("#form-analysis").value=it?.analysis||'';
  $("#form-mnemonic").value=it?.mnemonic||'';
  $("#form-related").value=it?.relatedHint||'';
  $("#form-source").value=it?.source||'';
  $("#form-tags").value=(it?.tags||[]).join(', ');
}
function closeSheet(){ $("#sheet").classList.remove('show'); }
$("#btn-close").onclick=closeSheet;
$("#btn-delete").onclick=()=>{ const id=$("#form-id").value; if(id){ closeSheet(); delItem(id); } };
$("#form").onsubmit=(e)=>{
  e.preventDefault();
  const id=$("#form-id").value||uid();
  const existed=state.data.find(d=>d.id===id);
  const obj={
    id,
    category:$("#form-category").value,
    subCategory:$("#form-subcat").value.trim(),
    question:$("#form-question").value.trim(),
    wrongAnswer:$("#form-wrong").value.trim(),
    correctAnswer:$("#form-correct").value.trim(),
    analysis:$("#form-analysis").value.trim(),
    mnemonic:$("#form-mnemonic").value.trim(),
    relatedHint:$("#form-related").value.trim(),
    source:$("#form-source").value.trim(),
    tags:$("#form-tags").value.split(',').map(s=>s.trim()).filter(Boolean),
    options:[],
    createdAt:existed?.createdAt||Date.now(),
    failCount:existed?.failCount||0,
    reviewHistory:Array.isArray(existed?.reviewHistory)?existed.reviewHistory:[]
  };
  upsertLocal(obj); closeSheet();
};

/* ========= åˆ†é¡/æ¨¡å¼/æœå°‹ ========= */
$("#tab-grammar").onclick=()=>{ state.cat='Grammar'; state.mode=null; render(); };
$("#tab-collocations").onclick=()=>{ state.cat='Collocations'; state.mode=null; render(); };
$("#tab-vocab").onclick=()=>{ state.cat='Vocabulary'; state.mode=null; render(); };
$("#mode-list").onclick=()=>{ state.mode='list'; render(); };
$("#mode-quiz").onclick=()=>{ if(!state.cat){ alert('è¦ä½¿ç”¨ã€Œæ¸¬é©—ï¼ˆä¾é¡åˆ¥ï¼‰ã€è«‹å…ˆé¸æ“‡æ–‡æ³• / ç‰‡èª / å–®å­—'); return; } state.mode='quiz'; render(); };
$("#btn-search").onclick=()=>render();
$("#btn-clear").onclick=()=>{ $("#search").value=''; render(); };
$("#search").addEventListener('input',()=>render());
$("#btn-add").onclick=()=>openSheet();

/* ========= Google Driveï¼ˆå¯é¸ï¼‰ ========= */
const GOOGLE_CLIENT_ID='1067450972173-l1o4o3fl73f57mcm4rltj520h2ocio12.apps.googleusercontent.com';
const SCOPES='https://www.googleapis.com/auth/drive.appdata';
let tokenClient=null,accessToken=null,driveFileId=null;

function updateDriveStatus(isLogin){
  $("#drive-status").innerHTML=isLogin?'âœ… å·²ç™»å…¥ Google':'é›¢ç·šæ¨¡å¼ï¼ˆå°šæœªç™»å…¥ï¼‰';
  $("#btn-auth").textContent=isLogin?'ç™»å‡º':'Google ç™»å…¥';
  $("#btn-auth").onclick=isLogin?signOut:authorize;
}
async function ensureGapi(){ return new Promise(res=>{ gapi.load('client',async()=>{ await gapi.client.init({discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']}); res(); }); }); }
function ensureGis(){ if(tokenClient) return;
  tokenClient=google.accounts.oauth2.initTokenClient({
    client_id:GOOGLE_CLIENT_ID,scope:SCOPES,
    callback:(r)=>{ if(r&&r.access_token){ accessToken=r.access_token; if(typeof gapi!=='undefined') gapi.client.setToken({access_token}); updateDriveStatus(true); findBackupFile(); } else updateDriveStatus(false); }
  });
}
async function authorize(){ if(typeof gapi==='undefined'||typeof google==='undefined'){ toast('Google æœå‹™è¼‰å…¥ä¸­â€¦'); return; } await ensureGapi(); ensureGis(); tokenClient.requestAccessToken({prompt:'consent'}); }
function signOut(){ if(!accessToken) return; google.accounts.oauth2.revoke(accessToken,()=>{}); accessToken=null; driveFileId=null; if(typeof gapi!=='undefined'){ try{ gapi.client.setToken(null);}catch{} } updateDriveStatus(false); }
async function findBackupFile(){ try{ const resp=await gapi.client.drive.files.list({spaces:'appDataFolder',q:"name='english_mistakes_v2.json'",fields:'files(id,modifiedTime)'}); driveFileId=(resp.result.files&&resp.result.files[0]?.id)||null; }catch(e){ console.warn('åˆ—å‡ºå‚™ä»½å¤±æ•—',e);} }
$("#btn-backup").onclick=async()=>{ if(!accessToken){ alert('è«‹å…ˆ Google ç™»å…¥'); return; } $("#loading").classList.add('show');
  try{ const data=JSON.stringify(state.data||[],null,2);
    if(driveFileId){ await gapi.client.request({path:`/upload/drive/v3/files/${driveFileId}`,method:'PATCH',params:{uploadType:'media'},headers:{'Content-Type':'application/json'},body:data}); }
    else{ const meta={name:'english_mistakes_v2.json',parents:['appDataFolder']}; const boundary='m_'+Math.random().toString(36).slice(2);
      const body=`--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify(meta)}\r\n--${boundary}\r\nContent-Type: application/json\r\n\r\n${data}\r\n--${boundary}--`;
      const res=await gapi.client.request({path:'/upload/drive/v3/files?uploadType=multipart',method:'POST',headers:{'Content-Type':`multipart/related; boundary=${boundary}`},body}); driveFileId=res.result.id; }
    alert('âœ… å‚™ä»½æˆåŠŸ');
  }catch(e){ console.error(e); alert('å‚™ä»½å¤±æ•—ï¼šè«‹ç¢ºèª Drive API èˆ‡ç¶²åŸŸè¨­å®š'); }
  finally{ $("#loading").classList.remove('show'); }
};
$("#btn-restore").onclick=async()=>{ if(!accessToken){ alert('è«‹å…ˆ Google ç™»å…¥'); return; } if(!driveFileId){ await findBackupFile(); } if(!driveFileId){ alert('é›²ç«¯å°šç„¡å‚™ä»½ï¼Œè«‹å…ˆå‚™ä»½ä¸€æ¬¡'); return; }
  $("#loading").classList.add('show');
  try{ const res=await gapi.client.drive.files.get({fileId:driveFileId,alt:'media'}); const arr=Array.isArray(res.result)?res.result:[];
    state.data=(arr||[]).map(o=>({...o,reviewHistory:Array.isArray(o.reviewHistory)?o.reviewHistory:[]}));
    saveLocal(); render(); alert('âœ… é‚„åŸæˆåŠŸ');
  }catch(e){ console.error(e); alert('é‚„åŸå¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™æˆ–ç¶²è·¯'); }
  finally{ $("#loading").classList.remove('show'); }
};

/* å•Ÿå‹• */
loadLocal(); render(); updateDriveStatus(false);
window.addEventListener('load', async ()=>{
  if(typeof gapi!=='undefined'){ await ensureGapi(); }
  if(typeof google!=='undefined'){ ensureGis(); try{ tokenClient?.requestAccessToken({prompt:''}); }catch{} }
});
</script>
</body>
</html>
